

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="黄山">
  <meta name="keywords" content="C/C++,Python,C#,Go,Web,AI,游戏开发,网络安全">
  
    <meta name="description" content="0 在设计初期尽早确定异常处理策略。 在C++中，设计初期的异常处理策略需要紧密结合语言特性（如RAII、异常安全等级、智能指针）和性能要求。以下是一套针对C++的异常处理设计框架，包含代码示例和最佳实践：  1. 异常分类与标准化设计 1.1 异常类型层级 1234567891011121314151617181920212223#include &lt;stdexcept&gt;#includ">
<meta property="og:type" content="article">
<meta property="og:title" content="C++程序设计语言笔记——基本功能：异常处理">
<meta property="og:url" content="https://mounthuangshan.github.io/C-%E7%AC%94%E8%AE%B0/C++%E7%AC%94%E8%AE%B0/C++%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%9F%BA%E6%9C%AC%E5%8A%9F%E8%83%BD%EF%BC%9A%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/">
<meta property="og:site_name" content="钺不言">
<meta property="og:description" content="0 在设计初期尽早确定异常处理策略。 在C++中，设计初期的异常处理策略需要紧密结合语言特性（如RAII、异常安全等级、智能指针）和性能要求。以下是一套针对C++的异常处理设计框架，包含代码示例和最佳实践：  1. 异常分类与标准化设计 1.1 异常类型层级 1234567891011121314151617181920212223#include &lt;stdexcept&gt;#includ">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-03-18T18:19:05.000Z">
<meta property="article:modified_time" content="2025-03-18T18:19:05.849Z">
<meta property="article:author" content="黄山">
<meta property="article:tag" content="C&#x2F;C++">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="C#">
<meta property="article:tag" content="Go">
<meta property="article:tag" content="Web">
<meta property="article:tag" content="AI">
<meta property="article:tag" content="游戏开发">
<meta property="article:tag" content="网络安全">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>C++程序设计语言笔记——基本功能：异常处理 - 钺不言</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"mounthuangshan.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="C++程序设计语言笔记——基本功能：异常处理"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-03-19 02:19" pubdate>
          2025年3月19日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          36k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          303 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">C++程序设计语言笔记——基本功能：异常处理</h1>
            
            
              <div class="markdown-body">
                
                <h1>0 在设计初期尽早确定异常处理策略。</h1>
<p>在C++中，设计初期的异常处理策略需要紧密结合语言特性（如RAII、异常安全等级、智能指针）和性能要求。以下是一套针对C++的异常处理设计框架，包含代码示例和最佳实践：</p>
<hr>
<h3 id="1-异常分类与标准化设计"><strong>1. 异常分类与标准化设计</strong></h3>
<h4 id="1-1-异常类型层级"><strong>1.1 异常类型层级</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdexcept&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><br><span class="hljs-comment">// 自定义业务异常基类（继承标准异常）</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessException</span> : <span class="hljs-keyword">public</span> std::runtime_error &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">BusinessException</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; msg, <span class="hljs-type">int</span> code = <span class="hljs-number">0</span>)</span></span><br><span class="hljs-function">        : std::runtime_error(msg), error_code(code) &#123;</span>&#125;<br>    <br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">get_code</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>&#123; <span class="hljs-keyword">return</span> error_code; &#125;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">int</span> error_code;<br>&#125;;<br><br><span class="hljs-comment">// 具体业务异常（示例：订单异常）</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderException</span> : <span class="hljs-keyword">public</span> BusinessException &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ErrorCode</span> &#123; NOT_FOUND = <span class="hljs-number">1001</span>, INVALID_STATE = <span class="hljs-number">1002</span> &#125;;<br><br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">OrderException</span><span class="hljs-params">(ErrorCode code, <span class="hljs-type">const</span> std::string&amp; details = <span class="hljs-string">&quot;&quot;</span>)</span></span><br><span class="hljs-function">        : BusinessException(<span class="hljs-string">&quot;OrderError: &quot;</span> + details, code) &#123;</span>&#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="1-2-错误码规范"><strong>1.2 错误码规范</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 使用强类型enum定义错误域</span><br><span class="hljs-keyword">namespace</span> ErrorDomain &#123;<br>    <span class="hljs-keyword">enum class</span> <span class="hljs-title class_">Database</span> &#123; CONNECTION_FAILED = <span class="hljs-number">2001</span>, TIMEOUT = <span class="hljs-number">2002</span> &#125;;<br>    <span class="hljs-keyword">enum class</span> <span class="hljs-title class_">Network</span> &#123; API_FAILURE = <span class="hljs-number">3001</span>, RATE_LIMITED = <span class="hljs-number">3002</span> &#125;;<br>&#125;<br><br><span class="hljs-comment">// 异常中携带错误域信息</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">TechnicalException</span> : <span class="hljs-keyword">public</span> std::runtime_error &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;<br>    <span class="hljs-built_in">TechnicalException</span>(T code, <span class="hljs-type">const</span> std::string&amp; msg)<br>        : std::<span class="hljs-built_in">runtime_error</span>(msg), <span class="hljs-built_in">error_code</span>(<span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(code)) &#123;&#125;<br>    <br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">get_code</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>&#123; <span class="hljs-keyword">return</span> error_code; &#125;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">int</span> error_code;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="2-异常处理机制"><strong>2. 异常处理机制</strong></h3>
<h4 id="2-1-全局异常处理"><strong>2.1 全局异常处理</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span></span><br><br><span class="hljs-comment">// 设置全局异常处理器（适用于未被捕获的异常）</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">global_handler</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> ex = std::<span class="hljs-built_in">current_exception</span>()) &#123;<br>            std::<span class="hljs-built_in">rethrow_exception</span>(ex);<br>        &#125;<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> BusinessException&amp; e) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;[Business Error] Code: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">get_code</span>() <br>                  &lt;&lt; <span class="hljs-string">&quot;, Msg: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; <span class="hljs-string">&quot;\n&quot;</span>;<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;[Fatal] &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; <span class="hljs-string">&quot;\n&quot;</span>;<br>    &#125;<br>    <span class="hljs-comment">// 安全终止或重启逻辑</span><br>    std::<span class="hljs-built_in">abort</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    std::<span class="hljs-built_in">set_terminate</span>(global_handler);<br>    <span class="hljs-comment">// 主逻辑...</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="2-2-防御性编程与契约"><strong>2.2 防御性编程与契约</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 使用GSL（Guidelines Support Library）进行契约检查</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;gsl/gsl_assert&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process_order</span><span class="hljs-params">(Order&amp; order)</span> </span>&#123;<br>    <span class="hljs-built_in">Expects</span>(order.<span class="hljs-built_in">is_valid</span>()); <span class="hljs-comment">// 前置条件检查，失败则终止</span><br>    <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-comment">// 参数校验（抛出受检异常）</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">validate_input</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; input)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (input.<span class="hljs-built_in">empty</span>()) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">BusinessException</span>(<span class="hljs-string">&quot;Input cannot be empty&quot;</span>, <span class="hljs-number">400</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="3-资源管理与异常安全"><strong>3. 资源管理与异常安全</strong></h3>
<h4 id="3-1-RAII模式保障资源释放"><strong>3.1 RAII模式保障资源释放</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConnection</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">DatabaseConnection</span>() &#123; <br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">connect</span>()) <span class="hljs-keyword">throw</span> <span class="hljs-built_in">TechnicalException</span>(ErrorDomain::Database::CONNECTION_FAILED, <span class="hljs-string">&quot;DB unreachable&quot;</span>);<br>    &#125;<br>    ~<span class="hljs-built_in">DatabaseConnection</span>() <span class="hljs-keyword">noexcept</span> &#123; <span class="hljs-built_in">disconnect</span>(); &#125;<br><br>    <span class="hljs-comment">// 禁用拷贝，允许移动</span><br>    <span class="hljs-built_in">DatabaseConnection</span>(<span class="hljs-type">const</span> DatabaseConnection&amp;) = <span class="hljs-keyword">delete</span>;<br>    DatabaseConnection&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> DatabaseConnection&amp;) = <span class="hljs-keyword">delete</span>;<br>    <span class="hljs-built_in">DatabaseConnection</span>(DatabaseConnection&amp;&amp;) = <span class="hljs-keyword">default</span>;<br>    DatabaseConnection&amp; <span class="hljs-keyword">operator</span>=(DatabaseConnection&amp;&amp;) = <span class="hljs-keyword">default</span>;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">connect</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-comment">/* ... */</span> &#125;<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">disconnect</span><span class="hljs-params">()</span> <span class="hljs-keyword">noexcept</span> </span>&#123; <span class="hljs-comment">/* ... */</span> &#125;<br>&#125;;<br><br><span class="hljs-comment">// 使用示例</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">query_data</span><span class="hljs-params">()</span> </span>&#123;<br>    DatabaseConnection conn; <span class="hljs-comment">// 资源获取即初始化</span><br>    <span class="hljs-comment">// 若此处抛出异常，conn析构会自动调用disconnect()</span><br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="3-2-智能指针管理动态资源"><strong>3.2 智能指针管理动态资源</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process_file</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span> </span>&#123;<br>    <span class="hljs-keyword">auto</span> file = std::<span class="hljs-built_in">make_unique</span>&lt;std::ifstream&gt;(path);<br>    <span class="hljs-keyword">if</span> (!file-&gt;<span class="hljs-built_in">is_open</span>()) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">TechnicalException</span>(ErrorDomain::IO::FILE_OPEN_FAILED, path);<br>    &#125;<br>    <span class="hljs-comment">// 即使后续操作抛出异常，unique_ptr会确保文件关闭</span><br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="4-性能优化与高级技巧"><strong>4. 性能优化与高级技巧</strong></h3>
<h4 id="4-1-noexcept与移动语义"><strong>4.1 noexcept与移动语义</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Buffer</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Buffer</span>(<span class="hljs-type">size_t</span> size) : <span class="hljs-built_in">data_</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[size]) &#123;&#125;<br>    <br>    <span class="hljs-comment">// 移动构造函数标记为noexcept，确保容器操作安全</span><br>    <span class="hljs-built_in">Buffer</span>(Buffer&amp;&amp; other) <span class="hljs-keyword">noexcept</span> : <span class="hljs-built_in">data_</span>(std::<span class="hljs-built_in">exchange</span>(other.data_, <span class="hljs-literal">nullptr</span>)) &#123;&#125;<br>    <br>    ~<span class="hljs-built_in">Buffer</span>() <span class="hljs-keyword">noexcept</span> &#123; <span class="hljs-keyword">delete</span>[] data_; &#125;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">char</span>* data_;<br>&#125;;<br><br><span class="hljs-comment">// 标记不会失败的函数</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">log_message</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; msg)</span> <span class="hljs-keyword">noexcept</span> </span>&#123;<br>    <span class="hljs-comment">// 即使此处抛出异常，程序会终止（符合noexcept约定）</span><br>    std::cout &lt;&lt; msg &lt;&lt; <span class="hljs-string">&quot;\n&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="4-2-异常替代方案（可选）"><strong>4.2 异常替代方案（可选）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 使用std::optional返回可能失败的操作</span><br><span class="hljs-function">std::optional&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">safe_divide</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (b == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> std::<span class="hljs-literal">nullopt</span>;<br>    <span class="hljs-keyword">return</span> a / b;<br>&#125;<br><br><span class="hljs-comment">// 使用std::expected（C++23或第三方库）</span><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T, <span class="hljs-keyword">typename</span> E&gt;<br><span class="hljs-keyword">using</span> expected = <span class="hljs-comment">/* 类似Rust Result类型的实现 */</span>;<br><br><span class="hljs-function">expected&lt;Data, Error&gt; <span class="hljs-title">fetch_data</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-comment">/* 失败条件 */</span>) <span class="hljs-keyword">return</span> <span class="hljs-built_in">unexpected</span>(Error::NETWORK_FAILURE);<br>    <span class="hljs-keyword">return</span> Data&#123;<span class="hljs-comment">/* ... */</span>&#125;;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="5-测试与调试策略"><strong>5. 测试与调试策略</strong></h3>
<h4 id="5-1-单元测试异常路径"><strong>5.1 单元测试异常路径</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> CATCH_CONFIG_MAIN</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;catch2/catch.hpp&gt;</span></span><br><br><span class="hljs-built_in">TEST_CASE</span>(<span class="hljs-string">&quot;Order validation throws on invalid state&quot;</span>) &#123;<br>    <span class="hljs-function">Order <span class="hljs-title">order</span><span class="hljs-params">(<span class="hljs-comment">/* 无效状态 */</span>)</span></span>;<br>    <span class="hljs-built_in">REQUIRE_THROWS_AS</span>(order.<span class="hljs-built_in">confirm</span>(), OrderException);<br>    <span class="hljs-built_in">REQUIRE_THROWS_WITH</span>(order.<span class="hljs-built_in">cancel</span>(), <span class="hljs-string">&quot;Order is already completed&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="5-2-静态分析工具"><strong>5.2 静态分析工具</strong></h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">使用Clang-Tidy检查异常安全</span><br>clang-tidy -checks=&#x27;modernize-use-noexcept, bugprone-exception-escape&#x27; src/*.cpp<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="6-设计原则总结"><strong>6. 设计原则总结</strong></h3>
<table>
<thead>
<tr>
<th>原则</th>
<th>C++实现方法</th>
<th>示例工具/语法</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>资源安全</strong></td>
<td>RAII + 智能指针</td>
<td>unique_ptr, 自定义RAII类</td>
</tr>
<tr>
<td><strong>异常中立</strong></td>
<td>确保析构函数不抛异常</td>
<td>~MyClass() noexcept {…}</td>
</tr>
<tr>
<td><strong>强异常保证</strong></td>
<td>先修改副本，再swap</td>
<td>std::swap, copy-and-swap</td>
</tr>
<tr>
<td><strong>性能敏感区</strong></td>
<td>禁用异常，改用错误码（-fno-exceptions）</td>
<td>Google的禁用异常规范</td>
</tr>
<tr>
<td><strong>跨模块边界</strong></td>
<td>C接口封装异常为错误码</td>
<td>extern “C” + try-catch块</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="完整示例：异常安全的事务操作"><strong>完整示例：异常安全的事务操作</strong></h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Transaction</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">execute</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">auto</span> backup = current_state_; <span class="hljs-comment">// 强异常保证：先准备副本</span><br>        <span class="hljs-built_in">modify_state</span>();               <span class="hljs-comment">// 可能抛出异常的操作</span><br>        current_state_.<span class="hljs-built_in">swap</span>(backup);  <span class="hljs-comment">// 无异常则提交更改</span><br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    State current_state_;<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify_state</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-comment">/* ...可能抛出... */</span> &#125;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">business_operation</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        Transaction tx;<br>        tx.<span class="hljs-built_in">execute</span>();<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> BusinessException&amp; e) &#123;<br>        <span class="hljs-comment">// 业务级恢复逻辑</span><br>        logger.<span class="hljs-built_in">log_rollback</span>(e);<br>        <span class="hljs-keyword">throw</span>; <span class="hljs-comment">// 重新抛出给上层</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="决策树：何时使用异常？"><strong>决策树：何时使用异常？</strong></h3>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs 1c">是否违反函数的前置条件？ ——是——&gt; 使用断言（Expects/Ensures）<br>                              <span class="hljs-string">|</span><br>                             否<br>                              <span class="hljs-string">|</span><br>是否可恢复的预期错误？ ————是——&gt; 抛出业务异常<br>                              <span class="hljs-string">|</span><br>                             否<br>                              <span class="hljs-string">|</span><br>是否程序无法继续执行？ ————是——&gt; 抛技术异常/终止<br>                              <span class="hljs-string">|</span><br>                             否<br>                              <span class="hljs-string">|</span><br>                        使用错误码或optional<br></code></pre></td></tr></table></figure>
<p>通过早期确立这些策略，可使C++项目在维护性、性能和安全之间取得平衡。建议将核心规则写入团队的《C++异常处理指南》，并通过代码审查确保一致性。</p>
<h1>1 当无法完成既定任务时抛出异常。</h1>
<p>在C++中，当函数无法完成其承诺的任务时，抛出异常是一种清晰的错误传播方式。以下是针对这一场景的详细设计策略和代码实现指南：</p>
<hr>
<h3 id="1-异常抛出原则"><strong>1. 异常抛出原则</strong></h3>
<h4 id="1-1-明确抛出条件"><strong>1.1 明确抛出条件</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 示例：文件加载失败时抛出异常</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">FileLoader</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">std::string <span class="hljs-title">load</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span> </span>&#123;<br>        <span class="hljs-function">std::ifstream <span class="hljs-title">file</span><span class="hljs-params">(path)</span></span>;<br>        <span class="hljs-keyword">if</span> (!file.<span class="hljs-built_in">is_open</span>()) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-built_in">FileIOException</span>(<span class="hljs-string">&quot;Cannot open file: &quot;</span> + path, ErrorCode::FILE_NOT_FOUND);<br>        &#125;<br>        <span class="hljs-comment">// 读取文件内容...</span><br>        <span class="hljs-keyword">if</span> (file.<span class="hljs-built_in">bad</span>()) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-built_in">FileIOException</span>(<span class="hljs-string">&quot;Read error&quot;</span>, ErrorCode::IO_ERROR);<br>        &#125;<br>        <span class="hljs-keyword">return</span> content;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="1-2-使用标准异常类型或继承体系"><strong>1.2 使用标准异常类型或继承体系</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdexcept&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><br><span class="hljs-comment">// 自定义异常类型（继承自std::runtime_error）</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkException</span> : <span class="hljs-keyword">public</span> std::runtime_error &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-keyword">enum class</span> <span class="hljs-title class_">ErrorCode</span> &#123; TIMEOUT, CONNECTION_REFUSED &#125;;<br><br>    <span class="hljs-built_in">NetworkException</span>(ErrorCode code, <span class="hljs-type">const</span> std::string&amp; details)<br>        : std::<span class="hljs-built_in">runtime_error</span>(details), <span class="hljs-built_in">code_</span>(code) &#123;&#125;<br><br>    <span class="hljs-function">ErrorCode <span class="hljs-title">code</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>&#123; <span class="hljs-keyword">return</span> code_; &#125;<br><br><span class="hljs-keyword">private</span>:<br>    ErrorCode code_;<br>&#125;;<br><br><span class="hljs-comment">// 使用示例</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">connect_to_server</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-comment">/* 连接超时 */</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">NetworkException</span>(NetworkException::ErrorCode::TIMEOUT, <span class="hljs-string">&quot;Timeout after 30s&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="2-异常安全等级设计"><strong>2. 异常安全等级设计</strong></h3>
<h4 id="2-1-基本异常安全（Basic-Guarantee）"><strong>2.1 基本异常安全（Basic Guarantee）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseTransaction</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">execute</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">auto</span> old_state = current_state_; <span class="hljs-comment">// 备份状态</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">modify_database</span>(); <span class="hljs-comment">// 可能抛出异常的操作</span><br>            current_state_ = new_state_;<br>        &#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>            current_state_ = old_state; <span class="hljs-comment">// 回滚到之前状态</span><br>            <span class="hljs-keyword">throw</span>;<br>        &#125;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="2-2-强异常安全（Strong-Guarantee）"><strong>2.2 强异常安全（Strong Guarantee）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigManager</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update_config</span><span class="hljs-params">(<span class="hljs-type">const</span> Config&amp; new_config)</span> </span>&#123;<br>        <span class="hljs-keyword">auto</span> temp = std::<span class="hljs-built_in">make_unique</span>&lt;Config&gt;(new_config); <span class="hljs-comment">// 先在临时对象操作</span><br>        <span class="hljs-built_in">validate_config</span>(*temp);  <span class="hljs-comment">// 可能抛出</span><br>        config_.<span class="hljs-built_in">swap</span>(temp);      <span class="hljs-comment">// 无异常则提交（原子操作）</span><br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="3-资源管理策略"><strong>3. 资源管理策略</strong></h3>
<h4 id="3-1-RAII自动释放资源"><strong>3.1 RAII自动释放资源</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeFileHandle</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">SafeFileHandle</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span> </span><br><span class="hljs-function">        : handle_(fopen(path.c_str(), <span class="hljs-string">&quot;r&quot;</span>)) &#123;</span><br>        <span class="hljs-keyword">if</span> (!handle_) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-built_in">FileIOException</span>(<span class="hljs-string">&quot;Open failed: &quot;</span> + path);<br>        &#125;<br>    &#125;<br><br>    ~<span class="hljs-built_in">SafeFileHandle</span>() <span class="hljs-keyword">noexcept</span> &#123; <br>        <span class="hljs-keyword">if</span> (handle_) <span class="hljs-built_in">fclose</span>(handle_); <br>    &#125;<br><br>    <span class="hljs-comment">// 禁用拷贝，允许移动</span><br>    <span class="hljs-built_in">SafeFileHandle</span>(<span class="hljs-type">const</span> SafeFileHandle&amp;) = <span class="hljs-keyword">delete</span>;<br>    SafeFileHandle&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> SafeFileHandle&amp;) = <span class="hljs-keyword">delete</span>;<br>    <span class="hljs-built_in">SafeFileHandle</span>(SafeFileHandle&amp;&amp;) = <span class="hljs-keyword">default</span>;<br>    SafeFileHandle&amp; <span class="hljs-keyword">operator</span>=(SafeFileHandle&amp;&amp;) = <span class="hljs-keyword">default</span>;<br><br><span class="hljs-keyword">private</span>:<br>    FILE* handle_;<br>&#125;;<br><br><span class="hljs-comment">// 使用示例</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process_file</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-function">SafeFileHandle <span class="hljs-title">file</span><span class="hljs-params">(<span class="hljs-string">&quot;data.bin&quot;</span>)</span></span>; <span class="hljs-comment">// 异常安全</span><br>    <span class="hljs-comment">// 使用文件句柄...</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="4-错误类型与上下文传递"><strong>4. 错误类型与上下文传递</strong></h3>
<h4 id="4-1-携带详细错误信息"><strong>4.1 携带详细错误信息</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentException</span> : <span class="hljs-keyword">public</span> std::runtime_error &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">PaymentException</span>(<span class="hljs-type">const</span> std::string&amp; msg, <br>                    <span class="hljs-type">int</span> user_id, <br>                    <span class="hljs-type">const</span> std::string&amp; order_no)<br>        : std::<span class="hljs-built_in">runtime_error</span>(msg), <br>          <span class="hljs-built_in">user_id_</span>(user_id), <br>          <span class="hljs-built_in">order_no_</span>(order_no) &#123;&#125;<br><br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">user_id</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>&#123; <span class="hljs-keyword">return</span> user_id_; &#125;<br>    <span class="hljs-function"><span class="hljs-type">const</span> std::string&amp; <span class="hljs-title">order_no</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>&#123; <span class="hljs-keyword">return</span> order_no_; &#125;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">int</span> user_id_;<br>    std::string order_no_;<br>&#125;;<br><br><span class="hljs-comment">// 抛出示例</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process_payment</span><span class="hljs-params">(<span class="hljs-type">int</span> user_id, <span class="hljs-type">const</span> Order&amp; order)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (order.amount &lt;= <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">PaymentException</span>(<span class="hljs-string">&quot;Invalid amount&quot;</span>, user_id, order.id);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="5-异常处理最佳实践"><strong>5. 异常处理最佳实践</strong></h3>
<h4 id="5-1-顶层异常捕获"><strong>5.1 顶层异常捕获</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">run_application</span>(); <span class="hljs-comment">// 主业务逻辑</span><br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> NetworkException&amp; ex) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;Network Error: &quot;</span> &lt;&lt; ex.<span class="hljs-built_in">what</span>() <br>                  &lt;&lt; <span class="hljs-string">&quot; Code: &quot;</span> &lt;&lt; <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(ex.<span class="hljs-built_in">code</span>()) &lt;&lt; <span class="hljs-string">&quot;\n&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; ex) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;Fatal Error: &quot;</span> &lt;&lt; ex.<span class="hljs-built_in">what</span>() &lt;&lt; <span class="hljs-string">&quot;\n&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>    &#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;Unknown exception occurred\n&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="5-2-异常与日志集成"><strong>5.2 异常与日志集成</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">handle_request</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 业务逻辑...</span><br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> BusinessException&amp; ex) &#123;<br>        logger.<span class="hljs-built_in">error</span>(<span class="hljs-string">&quot;Business failure: &#123;&#125;&quot;</span>, ex.<span class="hljs-built_in">what</span>());<br>        <span class="hljs-keyword">throw</span>;<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; ex) &#123;<br>        logger.<span class="hljs-built_in">error</span>(<span class="hljs-string">&quot;Technical failure: &#123;&#125;&quot;</span>, ex.<span class="hljs-built_in">what</span>());<br>        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">AppException</span>(<span class="hljs-string">&quot;Internal error&quot;</span>); <span class="hljs-comment">// 包装为通用异常</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="6-性能敏感场景替代方案"><strong>6. 性能敏感场景替代方案</strong></h3>
<h4 id="6-1-禁用异常（-fno-exceptions）"><strong>6.1 禁用异常（-fno-exceptions）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 使用错误码返回结果</span><br><span class="hljs-keyword">enum class</span> <span class="hljs-title class_">ErrorCode</span> &#123; OK, FILE_NOT_FOUND, INVALID_DATA &#125;;<br><br><span class="hljs-function">ErrorCode <span class="hljs-title">parse_data</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; input, Data&amp; output)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (input.<span class="hljs-built_in">empty</span>()) <span class="hljs-keyword">return</span> ErrorCode::INVALID_DATA;<br>    <span class="hljs-comment">// 解析逻辑...</span><br>    <span class="hljs-keyword">return</span> ErrorCode::OK;<br>&#125;<br><br><span class="hljs-comment">// 调用方处理</span><br>ErrorCode err = <span class="hljs-built_in">parse_data</span>(raw_input, data);<br><span class="hljs-keyword">if</span> (err != ErrorCode::OK) &#123;<br>    <span class="hljs-built_in">handle_error</span>(err);<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="6-2-使用std-optional（C-17）"><strong>6.2 使用std::optional（C++17）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">std::optional&lt;Image&gt; <span class="hljs-title">load_image</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">file_exists</span>(path)) <span class="hljs-keyword">return</span> std::<span class="hljs-literal">nullopt</span>;<br>    <span class="hljs-comment">// 加载图像...</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Image</span>(pixels);<br>&#125;<br><br><span class="hljs-comment">// 调用方</span><br><span class="hljs-keyword">auto</span> img = <span class="hljs-built_in">load_image</span>(<span class="hljs-string">&quot;photo.jpg&quot;</span>);<br><span class="hljs-keyword">if</span> (!img) &#123;<br>    <span class="hljs-built_in">show_error</span>(<span class="hljs-string">&quot;Image not loaded&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="7-异常测试策略"><strong>7. 异常测试策略</strong></h3>
<h4 id="7-1-单元测试异常路径"><strong>7.1 单元测试异常路径</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;catch2/catch.hpp&gt;</span></span><br><br><span class="hljs-built_in">TEST_CASE</span>(<span class="hljs-string">&quot;Invalid payment amount throws&quot;</span>) &#123;<br>    Order test_order&#123; .id = <span class="hljs-string">&quot;A1001&quot;</span>, .amount = <span class="hljs-number">-50</span> &#125;;<br>    <span class="hljs-built_in">REQUIRE_THROWS_AS</span>(<span class="hljs-built_in">process_payment</span>(<span class="hljs-number">101</span>, test_order), PaymentException);<br>&#125;<br><br><span class="hljs-built_in">TEST_CASE</span>(<span class="hljs-string">&quot;Network timeout handled&quot;</span>) &#123;<br>    mock_server.<span class="hljs-built_in">set_response_delay</span>(<span class="hljs-number">60</span>s); <span class="hljs-comment">// 模拟超时</span><br>    <span class="hljs-built_in">REQUIRE_THROWS_MATCHES</span>(<br>        <span class="hljs-built_in">connect_to_server</span>(), <br>        NetworkException,<br>        Catch::Matchers::<span class="hljs-built_in">Message</span>(<span class="hljs-string">&quot;Timeout after 30s&quot;</span>)<br>    );<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="决策表：何时抛出异常？"><strong>决策表：何时抛出异常？</strong></h3>
<table>
<thead>
<tr>
<th>场景</th>
<th>处理方式</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>违反函数前置条件</td>
<td>抛出异常或终止程序</td>
<td><code>if (ptr == nullptr) throw ...</code></td>
</tr>
<tr>
<td>关键资源获取失败（文件、网络）</td>
<td>立即抛出异常</td>
<td>文件打开失败、数据库连接断开</td>
</tr>
<tr>
<td>外部服务返回不可恢复错误</td>
<td>抛出携带上下文的业务异常</td>
<td>支付网关返回余额不足</td>
</tr>
<tr>
<td>数据校验失败且无法继续流程</td>
<td>抛出带错误码的验证异常</td>
<td>用户提交的表单数据非法</td>
</tr>
<tr>
<td>需要跨多层调用处理错误</td>
<td>抛出异常而非逐层返回错误码</td>
<td>深层嵌套的业务逻辑错误</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="关键设计总结"><strong>关键设计总结</strong></h3>
<ol>
<li><strong>明确语义</strong>：每个异常类型对应具体的错误场景，避免通用<code>std::exception</code>直接抛出</li>
<li><strong>资源安全</strong>：结合RAII和智能指针确保异常发生时资源自动释放</li>
<li><strong>性能权衡</strong>：在实时系统中评估异常开销，必要时使用错误码</li>
<li><strong>文档契约</strong>：在函数注释中明确说明可能抛出的异常类型</li>
<li><strong>统一处理</strong>：在应用入口集中捕获未处理异常，记录日志后安全退出</li>
</ol>
<p>通过遵循这些准则，可在C++项目中构建清晰、健壮的异常处理体系，使错误处理逻辑成为代码质量的优势而非负担。</p>
<h1>2 用异常机制处理错误。</h1>
<p>在C++中，使用异常机制处理错误是一种有效的方法，能够在错误发生时将控制流转移到合适的处理代码，保持程序结构的清晰和健壮性。以下是分步说明和示例：</p>
<hr>
<h3 id="1-定义异常类"><strong>1. 定义异常类</strong></h3>
<p>继承自标准异常类（如<code>std::runtime_error</code>），以携带特定错误信息。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdexcept&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><br><span class="hljs-comment">// 自定义异常类示例</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">FileIOException</span> : <span class="hljs-keyword">public</span> std::runtime_error &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-keyword">enum class</span> <span class="hljs-title class_">ErrorCode</span> &#123; FileNotFound, PermissionDenied, ReadError &#125;;<br><br>    <span class="hljs-built_in">FileIOException</span>(<span class="hljs-type">const</span> std::string&amp; message, ErrorCode code)<br>        : std::<span class="hljs-built_in">runtime_error</span>(message), <span class="hljs-built_in">error_code</span>(code) &#123;&#125;<br><br>    <span class="hljs-function">ErrorCode <span class="hljs-title">getCode</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>&#123; <span class="hljs-keyword">return</span> error_code; &#125;<br><br><span class="hljs-keyword">private</span>:<br>    ErrorCode error_code;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="2-抛出异常"><strong>2. 抛出异常</strong></h3>
<p>在检测到错误时，使用<code>throw</code>关键字抛出异常对象。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">loadFile</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; filename)</span> </span>&#123;<br>    <span class="hljs-function">std::ifstream <span class="hljs-title">file</span><span class="hljs-params">(filename)</span></span>;<br>    <span class="hljs-keyword">if</span> (!file.<span class="hljs-built_in">is_open</span>()) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">FileIOException</span>(<span class="hljs-string">&quot;无法打开文件: &quot;</span> + filename, <br>                             FileIOException::ErrorCode::FileNotFound);<br>    &#125;<br>    <span class="hljs-comment">// 读取文件内容...</span><br>    <span class="hljs-keyword">if</span> (file.<span class="hljs-built_in">fail</span>()) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">FileIOException</span>(<span class="hljs-string">&quot;读取文件失败&quot;</span>, <br>                             FileIOException::ErrorCode::ReadError);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="3-捕获并处理异常"><strong>3. 捕获并处理异常</strong></h3>
<p>使用<code>try-catch</code>块捕获异常，并根据类型处理。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">loadFile</span>(<span class="hljs-string">&quot;data.txt&quot;</span>);<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> FileIOException&amp; e) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;文件错误: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() <br>                  &lt;&lt; <span class="hljs-string">&quot;，错误码: &quot;</span> &lt;&lt; <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(e.<span class="hljs-built_in">getCode</span>()) &lt;&lt; std::endl;<br>        <span class="hljs-comment">// 处理文件错误，如重试或退出</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;标准异常: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>    &#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;未知异常发生！&quot;</span> &lt;&lt; std::endl;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="4-资源管理（RAII）"><strong>4. 资源管理（RAII）</strong></h3>
<p>利用对象的析构函数自动释放资源，避免资源泄漏。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeFileHandler</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">SafeFileHandler</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; filename)</span> </span><br><span class="hljs-function">        : file_(filename) &#123;</span><br>        <span class="hljs-keyword">if</span> (!file_.<span class="hljs-built_in">is_open</span>()) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-built_in">FileIOException</span>(<span class="hljs-string">&quot;文件打开失败&quot;</span>, <br>                                 FileIOException::ErrorCode::FileNotFound);<br>        &#125;<br>    &#125;<br><br>    ~<span class="hljs-built_in">SafeFileHandler</span>() &#123;<br>        <span class="hljs-keyword">if</span> (file_.<span class="hljs-built_in">is_open</span>()) &#123;<br>            file_.<span class="hljs-built_in">close</span>(); <span class="hljs-comment">// 确保文件关闭</span><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 禁用拷贝，允许移动</span><br>    <span class="hljs-built_in">SafeFileHandler</span>(<span class="hljs-type">const</span> SafeFileHandler&amp;) = <span class="hljs-keyword">delete</span>;<br>    SafeFileHandler&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> SafeFileHandler&amp;) = <span class="hljs-keyword">delete</span>;<br>    <span class="hljs-built_in">SafeFileHandler</span>(SafeFileHandler&amp;&amp;) = <span class="hljs-keyword">default</span>;<br>    SafeFileHandler&amp; <span class="hljs-keyword">operator</span>=(SafeFileHandler&amp;&amp;) = <span class="hljs-keyword">default</span>;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">readData</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">// 读取操作，可能抛出异常</span><br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    std::ifstream file_;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">processFile</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-function">SafeFileHandler <span class="hljs-title">file</span><span class="hljs-params">(<span class="hljs-string">&quot;data.txt&quot;</span>)</span></span>; <span class="hljs-comment">// RAII管理资源</span><br>    file.<span class="hljs-built_in">readData</span>(); <span class="hljs-comment">// 即使此处抛出异常，file的析构函数仍会关闭文件</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="5-异常安全保证"><strong>5. 异常安全保证</strong></h3>
<p>确保操作在异常发生后仍保持数据一致性。</p>
<h4 id="强异常安全示例（Copy-and-Swap）"><strong>强异常安全示例（Copy-and-Swap）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseTransaction</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">updateRecord</span><span class="hljs-params">(<span class="hljs-type">int</span> id, <span class="hljs-type">const</span> std::string&amp; newData)</span> </span>&#123;<br>        <span class="hljs-keyword">auto</span> oldData = data_; <span class="hljs-comment">// 备份当前数据</span><br>        data_ = newData;      <span class="hljs-comment">// 修改数据（可能失败的操作）</span><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">commitToDatabase</span>()) &#123;<br>            data_ = oldData; <span class="hljs-comment">// 失败则恢复</span><br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;提交数据库失败&quot;</span>);<br>        &#125;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    std::string data_;<br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">commitToDatabase</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-comment">/* 模拟数据库提交 */</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="6-性能优化"><strong>6. 性能优化</strong></h3>
<p>在性能敏感代码中，避免频繁抛出异常，改用错误码。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 返回错误码而非抛出异常</span><br><span class="hljs-keyword">enum class</span> <span class="hljs-title class_">ErrorCode</span> &#123; Success, InvalidInput, NetworkError &#125;;<br><br><span class="hljs-function">ErrorCode <span class="hljs-title">processRequest</span><span class="hljs-params">(Request&amp; req)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (!req.<span class="hljs-built_in">isValid</span>()) &#123;<br>        <span class="hljs-keyword">return</span> ErrorCode::InvalidInput;<br>    &#125;<br>    <span class="hljs-comment">// 处理请求...</span><br>    <span class="hljs-keyword">return</span> ErrorCode::Success;<br>&#125;<br><br><span class="hljs-comment">// 调用方处理</span><br>ErrorCode result = <span class="hljs-built_in">processRequest</span>(request);<br><span class="hljs-keyword">if</span> (result != ErrorCode::Success) &#123;<br>    <span class="hljs-built_in">handleError</span>(result);<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="7-测试异常路径"><strong>7. 测试异常路径</strong></h3>
<p>使用测试框架验证异常是否正确抛出。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> CATCH_CONFIG_MAIN</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;catch2/catch.hpp&gt;</span></span><br><br><span class="hljs-built_in">TEST_CASE</span>(<span class="hljs-string">&quot;加载不存在的文件应抛出异常&quot;</span>) &#123;<br>    <span class="hljs-built_in">REQUIRE_THROWS_AS</span>(<span class="hljs-built_in">loadFile</span>(<span class="hljs-string">&quot;nonexistent.txt&quot;</span>), FileIOException);<br>&#125;<br><br><span class="hljs-built_in">TEST_CASE</span>(<span class="hljs-string">&quot;无效输入返回错误码&quot;</span>) &#123;<br>    Request invalidReq;<br>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">processRequest</span>(invalidReq) == ErrorCode::InvalidInput);<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="总结"><strong>总结</strong></h3>
<ol>
<li><strong>明确异常用途</strong>：仅对不可恢复或关键错误使用异常。</li>
<li><strong>资源管理</strong>：结合RAII确保资源安全释放。</li>
<li><strong>异常安全</strong>：设计操作保证基本或强异常安全。</li>
<li><strong>分层处理</strong>：在适当层级捕获异常（如UI层捕获并显示错误）。</li>
<li><strong>性能考量</strong>：避免在频繁执行路径中使用异常。</li>
<li><strong>文档化</strong>：在函数注释中注明可能抛出的异常类型。</li>
</ol>
<p>通过合理使用异常机制，可以显著提升代码的可读性和健壮性，将错误处理逻辑与业务逻辑分离，便于维护和调试。</p>
<h1>3 为特定任务设计用户自定义异常类型(而非内置类型)。</h1>
<p>在设计用户自定义异常类型时，遵循以下步骤可以确保其高效性、安全性和易用性：</p>
<hr>
<h3 id="1-定义基础异常类"><strong>1. 定义基础异常类</strong></h3>
<p>创建基类 <code>BaseException</code>，包含核心属性和方法，供所有具体异常继承。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;exception&gt;</span> <span class="hljs-comment">// 可选，若不继承标准异常则无需包含</span></span><br><br><span class="hljs-comment">// 完全独立的自定义异常基类（不继承std::exception）</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseException</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">BaseException</span>(<span class="hljs-type">const</span> std::string&amp; message, <span class="hljs-type">int</span> code = <span class="hljs-number">0</span>)<br>        : <span class="hljs-built_in">message_</span>(message), <span class="hljs-built_in">error_code_</span>(code) &#123;&#125;<br><br>    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">BaseException</span>() = <span class="hljs-keyword">default</span>; <span class="hljs-comment">// 虚析构函数防止切片</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-title">what</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> message_.<span class="hljs-built_in">c_str</span>();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">code</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> error_code_;<br>    &#125;<br><br><span class="hljs-keyword">protected</span>:<br>    std::string message_;<br>    <span class="hljs-type">int</span> error_code_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="2-创建特定任务异常类"><strong>2. 创建特定任务异常类</strong></h3>
<p>针对不同错误场景，派生具体的异常类，添加任务相关数据。</p>
<h4 id="示例1：文件操作异常"><strong>示例1：文件操作异常</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FileIOException</span> : <span class="hljs-keyword">public</span> BaseException &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-keyword">enum class</span> <span class="hljs-title class_">Operation</span> &#123; Read, Write, Open &#125;;<br><br>    <span class="hljs-built_in">FileIOException</span>(Operation op, <span class="hljs-type">const</span> std::string&amp; path, <span class="hljs-type">int</span> sys_errno = <span class="hljs-number">0</span>)<br>        : <span class="hljs-built_in">BaseException</span>(formatMessage(op, path, sys_errno), sys_errno),<br>          <span class="hljs-built_in">operation_</span>(op), <span class="hljs-built_in">file_path_</span>(path) &#123;&#125;<br><br>    <span class="hljs-function">Operation <span class="hljs-title">operation</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> operation_; &#125;<br>    <span class="hljs-function"><span class="hljs-type">const</span> std::string&amp; <span class="hljs-title">path</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> file_path_; &#125;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-function"><span class="hljs-type">static</span> std::string <span class="hljs-title">formatMessage</span><span class="hljs-params">(Operation op, <span class="hljs-type">const</span> std::string&amp; path, <span class="hljs-type">int</span> err)</span> </span>&#123;<br>        std::string opStr;<br>        <span class="hljs-keyword">switch</span> (op) &#123;<br>            <span class="hljs-keyword">case</span> Operation::Read: opStr = <span class="hljs-string">&quot;读取&quot;</span>; <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> Operation::Write: opStr = <span class="hljs-string">&quot;写入&quot;</span>; <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> Operation::Open: opStr = <span class="hljs-string">&quot;打开&quot;</span>; <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> opStr + <span class="hljs-string">&quot;文件失败: &quot;</span> + path + <span class="hljs-string">&quot; (系统错误码: &quot;</span> + std::<span class="hljs-built_in">to_string</span>(err) + <span class="hljs-string">&quot;)&quot;</span>;<br>    &#125;<br><br>    Operation operation_;<br>    std::string file_path_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="示例2：网络请求异常"><strong>示例2：网络请求异常</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkException</span> : <span class="hljs-keyword">public</span> BaseException &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">NetworkException</span>(<span class="hljs-type">const</span> std::string&amp; url, <br>                    <span class="hljs-type">const</span> std::string&amp; response, <br>                    <span class="hljs-type">int</span> http_status)<br>        : <span class="hljs-built_in">BaseException</span>(<span class="hljs-string">&quot;HTTP请求失败: &quot;</span> + url + <span class="hljs-string">&quot; [状态码: &quot;</span> + std::<span class="hljs-built_in">to_string</span>(http_status) + <span class="hljs-string">&quot;]&quot;</span>, http_status),<br>          <span class="hljs-built_in">url_</span>(url), <span class="hljs-built_in">response_</span>(response), <span class="hljs-built_in">http_status_</span>(http_status),<br>          <span class="hljs-built_in">timestamp_</span>(std::chrono::system_clock::<span class="hljs-built_in">now</span>()) &#123;&#125;<br><br>    <span class="hljs-function"><span class="hljs-type">const</span> std::string&amp; <span class="hljs-title">url</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> url_; &#125;<br>    <span class="hljs-function"><span class="hljs-type">const</span> std::string&amp; <span class="hljs-title">response</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> response_; &#125;<br>    <span class="hljs-function">std::<span class="hljs-type">time_t</span> <span class="hljs-title">timestamp</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <br>        <span class="hljs-keyword">return</span> std::chrono::system_clock::<span class="hljs-built_in">to_time_t</span>(timestamp_); <br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    std::string url_;<br>    std::string response_;<br>    <span class="hljs-type">int</span> http_status_;<br>    std::chrono::system_clock::time_point timestamp_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="3-抛出异常"><strong>3. 抛出异常</strong></h3>
<p>在检测到错误时，构造并抛出具体异常对象。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span> <span class="hljs-comment">// 用于strerror</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">readFile</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span> </span>&#123;<br>    <span class="hljs-function">std::ifstream <span class="hljs-title">file</span><span class="hljs-params">(path)</span></span>;<br>    <span class="hljs-keyword">if</span> (!file) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">FileIOException</span>(FileIOException::Operation::Open, path, errno);<br>    &#125;<br><br>    std::string content;<br>    <span class="hljs-keyword">if</span> (!std::<span class="hljs-built_in">getline</span>(file, content)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">FileIOException</span>(FileIOException::Operation::Read, path, errno);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="4-捕获并处理异常"><strong>4. 捕获并处理异常</strong></h3>
<p>使用<code>try-catch</code>块按类型处理不同异常，访问其特定属性。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">readFile</span>(<span class="hljs-string">&quot;data.txt&quot;</span>);<br>        <span class="hljs-comment">// 假设此处有网络请求...</span><br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> FileIOException&amp; e) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;[文件错误] 操作类型: &quot;</span> &lt;&lt; <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(e.<span class="hljs-built_in">operation</span>())<br>                  &lt;&lt; <span class="hljs-string">&quot;\n路径: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">path</span>()<br>                  &lt;&lt; <span class="hljs-string">&quot;\n错误信息: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> NetworkException&amp; e) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;[网络错误] URL: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">url</span>()<br>                  &lt;&lt; <span class="hljs-string">&quot;\n响应内容: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">response</span>()<br>                  &lt;&lt; <span class="hljs-string">&quot;\n时间: &quot;</span> &lt;&lt; std::<span class="hljs-built_in">ctime</span>(&amp;e.<span class="hljs-built_in">timestamp</span>())<br>                  &lt;&lt; <span class="hljs-string">&quot;错误码: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">code</span>() &lt;&lt; std::endl;<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> BaseException&amp; e) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;[通用错误] &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() <br>                  &lt;&lt; <span class="hljs-string">&quot; (代码: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">code</span>() &lt;&lt; <span class="hljs-string">&quot;)&quot;</span> &lt;&lt; std::endl;<br>    &#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;未知异常发生！&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="5-高级特性增强"><strong>5. 高级特性增强</strong></h3>
<h4 id="5-1-支持链式异常（错误原因追溯）"><strong>5.1 支持链式异常（错误原因追溯）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseException</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">BaseException</span>(<span class="hljs-type">const</span> std::string&amp; message, BaseException* cause = <span class="hljs-literal">nullptr</span>)<br>        : <span class="hljs-built_in">message_</span>(message), <span class="hljs-built_in">cause_</span>(cause) &#123;&#125;<br><br>    <span class="hljs-function"><span class="hljs-type">const</span> BaseException* <span class="hljs-title">cause</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> cause_.<span class="hljs-built_in">get</span>(); &#125;<br><br>    <span class="hljs-comment">// 递归打印异常链</span><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">printTrace</span><span class="hljs-params">(std::ostream&amp; os, <span class="hljs-type">int</span> level = <span class="hljs-number">0</span>)</span> <span class="hljs-type">const</span> </span>&#123;<br>        os &lt;&lt; std::<span class="hljs-built_in">string</span>(level * <span class="hljs-number">2</span>, <span class="hljs-string">&#x27; &#x27;</span>) &lt;&lt; <span class="hljs-string">&quot;[&quot;</span> &lt;&lt; level &lt;&lt; <span class="hljs-string">&quot;] &quot;</span> &lt;&lt; <span class="hljs-built_in">what</span>() &lt;&lt; <span class="hljs-string">&quot;\n&quot;</span>;<br>        <span class="hljs-keyword">if</span> (cause_) &#123;<br>            cause_-&gt;<span class="hljs-built_in">printTrace</span>(os, level + <span class="hljs-number">1</span>);<br>        &#125;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    std::unique_ptr&lt;BaseException&gt; cause_;<br>&#125;;<br><br><span class="hljs-comment">// 使用示例</span><br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">connectDatabase</span>(); <span class="hljs-comment">// 可能抛出NetworkException</span><br>    &#125; <span class="hljs-built_in">catch</span> (BaseException&amp; e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">BaseException</span>(<span class="hljs-string">&quot;数据库连接失败&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">NetworkException</span>(e)); <span class="hljs-comment">// 包装原因</span><br>    &#125;<br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> BaseException&amp; e) &#123;<br>    e.<span class="hljs-built_in">printTrace</span>(std::cerr);<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="5-2-序列化异常信息（用于日志或网络传输）"><strong>5.2 序列化异常信息（用于日志或网络传输）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;nlohmann/json.hpp&gt;</span> <span class="hljs-comment">// 使用JSON库</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkException</span> : <span class="hljs-keyword">public</span> BaseException &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">nlohmann::json <span class="hljs-title">toJson</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> &#123;<br>            &#123;<span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-string">&quot;NetworkException&quot;</span>&#125;,<br>            &#123;<span class="hljs-string">&quot;url&quot;</span>, url_&#125;,<br>            &#123;<span class="hljs-string">&quot;http_status&quot;</span>, http_status_&#125;,<br>            &#123;<span class="hljs-string">&quot;timestamp&quot;</span>, timestamp_.<span class="hljs-built_in">time_since_epoch</span>().<span class="hljs-built_in">count</span>()&#125;,<br>            &#123;<span class="hljs-string">&quot;message&quot;</span>, message_&#125;,<br>            &#123;<span class="hljs-string">&quot;code&quot;</span>, error_code_&#125;<br>        &#125;;<br>    &#125;<br>&#125;;<br><br><span class="hljs-comment">// 日志记录示例</span><br><span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> NetworkException&amp; e) &#123;<br>    logger.<span class="hljs-built_in">error</span>(e.<span class="hljs-built_in">toJson</span>().<span class="hljs-built_in">dump</span>());<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="6-设计原则总结-2"><strong>6. 设计原则总结</strong></h3>
<table>
<thead>
<tr>
<th>原则</th>
<th>实现方法</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>明确语义</strong></td>
<td>每个异常类对应具体错误场景（如<code>FileIOException</code>、<code>NetworkException</code>）</td>
</tr>
<tr>
<td><strong>丰富上下文</strong></td>
<td>在异常类中添加任务相关数据（路径、错误码、时间戳等）</td>
</tr>
<tr>
<td><strong>类型安全</strong></td>
<td>通过继承层次区分错误类型，避免使用通用异常</td>
</tr>
<tr>
<td><strong>资源安全</strong></td>
<td>使用智能指针管理动态分配的原因异常（<code>std::unique_ptr&lt;BaseException&gt;</code>）</td>
</tr>
<tr>
<td><strong>可扩展性</strong></td>
<td>通过基类提供统一接口（<code>what()</code>、<code>code()</code>），派生类扩展数据</td>
</tr>
<tr>
<td><strong>兼容性</strong></td>
<td>可选：若需与标准异常交互，可多重继承<code>std::exception</code>（但根据用户需求省略）</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="性能优化建议"><strong>性能优化建议</strong></h3>
<ol>
<li><strong>避免频繁抛出</strong>：在性能关键路径（如循环内部）优先使用错误码。</li>
<li><strong>移动语义</strong>：确保异常类支持移动构造，减少拷贝开销。<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseException</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">BaseException</span>(BaseException&amp;&amp;) = <span class="hljs-keyword">default</span>;<br>    BaseException&amp; <span class="hljs-keyword">operator</span>=(BaseException&amp;&amp;) = <span class="hljs-keyword">default</span>;<br>&#125;;<br></code></pre></td></tr></table></figure>
</li>
<li><strong>轻量级设计</strong>：避免在异常类中存储过大数据（如完整响应内容可存指针）。</li>
</ol>
<hr>
<h3 id="单元测试示例"><strong>单元测试示例</strong></h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> CATCH_CONFIG_MAIN</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;catch2/catch.hpp&gt;</span></span><br><br><span class="hljs-built_in">TEST_CASE</span>(<span class="hljs-string">&quot;读取不存在文件应抛出FileIOException&quot;</span>) &#123;<br>    <span class="hljs-built_in">REQUIRE_THROWS_AS</span>(<span class="hljs-built_in">readFile</span>(<span class="hljs-string">&quot;nonexistent.txt&quot;</span>), FileIOException);<br>&#125;<br><br><span class="hljs-built_in">TEST_CASE</span>(<span class="hljs-string">&quot;NetworkException序列化包含正确URL&quot;</span>) &#123;<br>    <span class="hljs-function">NetworkException <span class="hljs-title">e</span><span class="hljs-params">(<span class="hljs-string">&quot;https://api.example.com&quot;</span>, <span class="hljs-string">&quot;Not Found&quot;</span>, <span class="hljs-number">404</span>)</span></span>;<br>    <span class="hljs-keyword">auto</span> json = e.<span class="hljs-built_in">toJson</span>();<br>    <span class="hljs-built_in">REQUIRE</span>(json[<span class="hljs-string">&quot;url&quot;</span>] == <span class="hljs-string">&quot;https://api.example.com&quot;</span>);<br>    <span class="hljs-built_in">REQUIRE</span>(json[<span class="hljs-string">&quot;http_status&quot;</span>] == <span class="hljs-number">404</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<p>通过以上步骤，您可以为特定任务设计出功能强大、信息丰富的自定义异常类型，提升代码的可维护性和错误处理能力。</p>
<h1>4 如果由于某种原因你无法使用异常，尽量模仿其机制。</h1>
<p>在无法使用C++异常机制的情况下（如嵌入式环境、禁用异常的代码规范或性能敏感场景），可以通过以下方法模拟类似异常的错误处理流程，同时保持代码的结构化和安全性：</p>
<hr>
<h3 id="1-定义错误类型与返回码"><strong>1. 定义错误类型与返回码</strong></h3>
<h4 id="1-1-通用错误码枚举"><strong>1.1 通用错误码枚举</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">enum class</span> <span class="hljs-title class_">ErrorCode</span> &#123;<br>    Success = <span class="hljs-number">0</span>,<br>    FileNotFound,<br>    NetworkTimeout,<br>    InvalidArgument,<br>    OutOfMemory<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="1-2-携带上下文信息的错误对象"><strong>1.2 携带上下文信息的错误对象</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Error</span> &#123;<br>    ErrorCode code;<br>    std::string message;  <span class="hljs-comment">// 错误描述</span><br>    std::string detail;   <span class="hljs-comment">// 调试信息（如文件路径）</span><br>    <span class="hljs-type">int</span> sys_errno = <span class="hljs-number">0</span>;    <span class="hljs-comment">// 系统错误码（如errno）</span><br><br>    <span class="hljs-comment">// 快速创建错误的辅助方法</span><br>    <span class="hljs-function"><span class="hljs-type">static</span> Error <span class="hljs-title">fromFileError</span><span class="hljs-params">(ErrorCode code, <span class="hljs-type">const</span> std::string&amp; path, <span class="hljs-type">int</span> err)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> Error&#123;code, <span class="hljs-string">&quot;文件操作失败&quot;</span>, <span class="hljs-string">&quot;路径: &quot;</span> + path, err&#125;;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="2-错误传递机制"><strong>2. 错误传递机制</strong></h3>
<h4 id="2-1-函数返回错误码"><strong>2.1 函数返回错误码</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 返回值 + 错误码输出参数</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">readFile</span><span class="hljs-params">(std::string&amp; content, <span class="hljs-type">const</span> std::string&amp; path, Error&amp; err)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (path.<span class="hljs-built_in">empty</span>()) &#123;<br>        err = Error&#123;ErrorCode::InvalidArgument, <span class="hljs-string">&quot;路径为空&quot;</span>&#125;;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-comment">// 文件操作...</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="2-2-使用结构体包装结果"><strong>2.2 使用结构体包装结果</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Result</span> &#123;<br>    T value;<br>    Error error;<br><br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">ok</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> error.code == ErrorCode::Success; &#125;<br>&#125;;<br><br><span class="hljs-function">Result&lt;std::string&gt; <span class="hljs-title">loadConfig</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">fileExists</span>(path)) &#123;<br>        <span class="hljs-keyword">return</span> &#123; &#123;&#125;, Error::<span class="hljs-built_in">fromFileError</span>(ErrorCode::FileNotFound, path, errno) &#125;;<br>    &#125;<br>    <span class="hljs-keyword">return</span> &#123; <span class="hljs-built_in">readFileContent</span>(path), Error&#123;ErrorCode::Success&#125; &#125;;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="3-错误处理流程模拟"><strong>3. 错误处理流程模拟</strong></h3>
<h4 id="3-1-手动实现-try-catch-逻辑"><strong>3.1 手动实现&quot;try-catch&quot;逻辑</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 通过宏简化错误检查</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TRY(expr) \</span><br><span class="hljs-meta">    &#123; auto result = expr; <span class="hljs-keyword">if</span> (!result.ok()) return result.<span class="hljs-keyword">error</span>; &#125;</span><br><br><span class="hljs-comment">// 函数调用链中的错误冒泡</span><br><span class="hljs-function">Error <span class="hljs-title">initializeSystem</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-built_in">TRY</span>(<span class="hljs-built_in">loadConfig</span>(<span class="hljs-string">&quot;config.json&quot;</span>));  <span class="hljs-comment">// 若失败直接返回错误</span><br>    <span class="hljs-built_in">TRY</span>(<span class="hljs-built_in">connectToDatabase</span>());<br>    <span class="hljs-keyword">return</span> Error&#123;ErrorCode::Success&#125;;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="3-2-错误处理中心"><strong>3.2 错误处理中心</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">handleError</span><span class="hljs-params">(<span class="hljs-type">const</span> Error&amp; err)</span> </span>&#123;<br>    <span class="hljs-built_in">logError</span>(err);  <span class="hljs-comment">// 记录日志</span><br>    <span class="hljs-keyword">if</span> (err.code == ErrorCode::NetworkTimeout) &#123;<br>        <span class="hljs-built_in">retryOperation</span>();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">shutdownGracefully</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    Error err = <span class="hljs-built_in">initializeSystem</span>();<br>    <span class="hljs-keyword">if</span> (!err.<span class="hljs-built_in">ok</span>()) &#123;<br>        <span class="hljs-built_in">handleError</span>(err);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="4-资源管理（模拟RAII）"><strong>4. 资源管理（模拟RAII）</strong></h3>
<h4 id="4-1-自定义作用域守卫"><strong>4.1 自定义作用域守卫</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> Cleanup&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ScopeGuard</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">ScopeGuard</span>(Cleanup cleanup) : <span class="hljs-built_in">cleanup_</span>(cleanup), <span class="hljs-built_in">active_</span>(<span class="hljs-literal">true</span>) &#123;&#125;<br>    ~<span class="hljs-built_in">ScopeGuard</span>() &#123; <span class="hljs-keyword">if</span> (active_) <span class="hljs-built_in">cleanup_</span>(); &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dismiss</span><span class="hljs-params">()</span> </span>&#123; active_ = <span class="hljs-literal">false</span>; &#125;<br><br><span class="hljs-keyword">private</span>:<br>    Cleanup cleanup_;<br>    <span class="hljs-type">bool</span> active_;<br>&#125;;<br><br><span class="hljs-comment">// 使用示例：确保文件句柄关闭</span><br><span class="hljs-function">Result&lt;<span class="hljs-type">void</span>&gt; <span class="hljs-title">processFile</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span> </span>&#123;<br>    FILE* file = <span class="hljs-built_in">fopen</span>(path.<span class="hljs-built_in">c_str</span>(), <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span> (!file) <span class="hljs-keyword">return</span> <span class="hljs-built_in">makeFileError</span>(path);<br>    <br>    <span class="hljs-keyword">auto</span> guard = <span class="hljs-built_in">ScopeGuard</span>([&amp;] &#123; <span class="hljs-built_in">fclose</span>(file); &#125;);<br>    <span class="hljs-comment">// 文件操作...</span><br>    guard.<span class="hljs-built_in">dismiss</span>();  <span class="hljs-comment">// 操作成功时取消关闭</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">success</span>();<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="5-错误传播优化"><strong>5. 错误传播优化</strong></h3>
<h4 id="5-1-错误链追踪"><strong>5.1 错误链追踪</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Error</span> &#123;<br>    <span class="hljs-comment">// ... 其他字段</span><br>    std::shared_ptr&lt;Error&gt; cause;  <span class="hljs-comment">// 错误原因链</span><br><br>    <span class="hljs-function"><span class="hljs-type">static</span> Error <span class="hljs-title">wrap</span><span class="hljs-params">(Error&amp;&amp; current, Error&amp;&amp; cause)</span> </span>&#123;<br>        current.cause = std::<span class="hljs-built_in">make_shared</span>&lt;Error&gt;(std::<span class="hljs-built_in">move</span>(cause));<br>        <span class="hljs-keyword">return</span> current;<br>    &#125;<br>&#125;;<br><br><span class="hljs-function">Error <span class="hljs-title">fetchData</span><span class="hljs-params">()</span> </span>&#123;<br>    Error err = <span class="hljs-built_in">downloadFromNetwork</span>();<br>    <span class="hljs-keyword">if</span> (!err.<span class="hljs-built_in">ok</span>()) &#123;<br>        <span class="hljs-keyword">return</span> Error::<span class="hljs-built_in">wrap</span>(<br>            Error&#123;ErrorCode::DataUnavailable, <span class="hljs-string">&quot;数据获取失败&quot;</span>&#125;,<br>            std::<span class="hljs-built_in">move</span>(err)<br>        );<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">success</span>();<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="6-替代方案对比"><strong>6. 替代方案对比</strong></h3>
<table>
<thead>
<tr>
<th>方法</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>返回错误码</strong></td>
<td>简单直观，零开销</td>
<td>需手动检查每个返回值</td>
</tr>
<tr>
<td><strong>Result<T>结构体</strong></td>
<td>类型安全，可携带附加数据</td>
<td>代码冗余，需频繁解包</td>
</tr>
<tr>
<td><strong>setjmp/longjmp</strong></td>
<td>真正的非本地跳转</td>
<td>不安全（可能跳过析构函数）</td>
</tr>
<tr>
<td><strong>错误回调函数</strong></td>
<td>异步友好</td>
<td>破坏控制流可读性</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="完整示例：错误处理工作流"><strong>完整示例：错误处理工作流</strong></h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">Result&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">parseNumber</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; input)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (input.<span class="hljs-built_in">empty</span>()) &#123;<br>        <span class="hljs-keyword">return</span> &#123;<span class="hljs-number">0</span>, Error&#123;ErrorCode::InvalidArgument, <span class="hljs-string">&quot;输入为空&quot;</span>&#125;&#125;;<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> &#123;std::<span class="hljs-built_in">stoi</span>(input), &#123;&#125;&#125;;<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) &#123;<br>        <span class="hljs-keyword">return</span> &#123;<span class="hljs-number">0</span>, Error&#123;ErrorCode::InvalidArgument, e.<span class="hljs-built_in">what</span>()&#125;&#125;;<br>    &#125;<br>&#125;<br><br><span class="hljs-function">Error <span class="hljs-title">calculateSum</span><span class="hljs-params">()</span> </span>&#123;<br>    Result&lt;<span class="hljs-type">int</span>&gt; a = <span class="hljs-built_in">parseNumber</span>(<span class="hljs-string">&quot;42&quot;</span>);<br>    <span class="hljs-keyword">if</span> (!a.<span class="hljs-built_in">ok</span>()) <span class="hljs-keyword">return</span> a.error;<br><br>    Result&lt;<span class="hljs-type">int</span>&gt; b = <span class="hljs-built_in">parseNumber</span>(<span class="hljs-string">&quot;abc&quot;</span>);<br>    <span class="hljs-keyword">if</span> (!b.<span class="hljs-built_in">ok</span>()) <span class="hljs-keyword">return</span> b.error;  <span class="hljs-comment">// 此处会返回解析错误</span><br><br>    std::cout &lt;&lt; <span class="hljs-string">&quot;Sum: &quot;</span> &lt;&lt; (a.value + b.value) &lt;&lt; std::endl;<br>    <span class="hljs-keyword">return</span> &#123;&#125;;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (Error err = <span class="hljs-built_in">calculateSum</span>(); !err.<span class="hljs-built_in">ok</span>()) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;错误: &quot;</span> &lt;&lt; err.message <br>                  &lt;&lt; <span class="hljs-string">&quot;\n详情: &quot;</span> &lt;&lt; err.detail &lt;&lt; std::endl;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="关键设计原则"><strong>关键设计原则</strong></h3>
<ol>
<li><strong>统一错误接口</strong>：所有函数使用相同的错误返回方式（如<code>Result&lt;T&gt;</code>）</li>
<li><strong>错误信息丰富化</strong>：携带足够上下文用于调试</li>
<li><strong>资源安全</strong>：通过守卫对象模拟RAII</li>
<li><strong>错误处理集中化</strong>：在高层级统一处理错误，避免分散的错误检查</li>
<li><strong>错误链支持</strong>：追踪错误根源，类似异常的堆栈回溯</li>
</ol>
<p>通过这种方式，可以在禁用异常的环境中构建可维护的错误处理系统，同时保持代码的结构化。对于性能关键代码，可进一步优化错误对象的内存分配（如使用预分配错误池）。</p>
<h1>5 使用层次化异常处理。</h1>
<p>在C++中实现层次化异常处理，需结合系统架构分层设计异常类型和处理逻辑。以下为分层处理策略、代码示例及最佳实践：</p>
<hr>
<h3 id="1-分层异常类型设计"><strong>1. 分层异常类型设计</strong></h3>
<h4 id="1-1-基础异常类（所有异常基类）"><strong>1.1 基础异常类（所有异常基类）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;exception&gt;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseException</span> : <span class="hljs-keyword">public</span> std::exception &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">BaseException</span>(<span class="hljs-type">const</span> std::string&amp; message, <span class="hljs-type">int</span> code = <span class="hljs-number">0</span>, <span class="hljs-type">const</span> BaseException* cause = <span class="hljs-literal">nullptr</span>)<br>        : <span class="hljs-built_in">msg_</span>(message), <span class="hljs-built_in">code_</span>(code), <span class="hljs-built_in">cause_</span>(cause ? cause-&gt;<span class="hljs-built_in">clone</span>() : <span class="hljs-literal">nullptr</span>) &#123;&#125;<br><br>    <span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-title">what</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> <span class="hljs-keyword">override</span> </span>&#123; <span class="hljs-keyword">return</span> msg_.<span class="hljs-built_in">c_str</span>(); &#125;<br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">code</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>&#123; <span class="hljs-keyword">return</span> code_; &#125;<br>    <span class="hljs-function"><span class="hljs-type">const</span> BaseException* <span class="hljs-title">cause</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>&#123; <span class="hljs-keyword">return</span> cause_.<span class="hljs-built_in">get</span>(); &#125;<br><br>    <span class="hljs-comment">// 克隆方法用于异常链</span><br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> BaseException* <span class="hljs-title">clone</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">BaseException</span>(*<span class="hljs-keyword">this</span>);<br>    &#125;<br><br><span class="hljs-keyword">protected</span>:<br>    std::string msg_;<br>    <span class="hljs-type">int</span> code_;<br>    std::unique_ptr&lt;BaseException&gt; cause_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="1-2-分层异常派生类"><strong>1.2 分层异常派生类</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 数据访问层异常</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DaoException</span> : <span class="hljs-keyword">public</span> BaseException &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ErrorType</span> &#123; CONNECTION_FAILED, QUERY_ERROR &#125;;<br><br>    <span class="hljs-built_in">DaoException</span>(ErrorType type, <span class="hljs-type">const</span> std::string&amp; sql, <span class="hljs-type">int</span> db_errno)<br>        : <span class="hljs-built_in">BaseException</span>(formatMsg(type, sql, db_errno), db_errno),<br>          <span class="hljs-built_in">sql_</span>(sql), <span class="hljs-built_in">error_type_</span>(type) &#123;&#125;<br><br>    <span class="hljs-function">ErrorType <span class="hljs-title">error_type</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> error_type_; &#125;<br>    <span class="hljs-function"><span class="hljs-type">const</span> std::string&amp; <span class="hljs-title">sql</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> sql_; &#125;<br><br>    <span class="hljs-function">DaoException* <span class="hljs-title">clone</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">DaoException</span>(*<span class="hljs-keyword">this</span>);<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-function"><span class="hljs-type">static</span> std::string <span class="hljs-title">formatMsg</span><span class="hljs-params">(ErrorType type, <span class="hljs-type">const</span> std::string&amp; sql, <span class="hljs-type">int</span> err)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">string</span>(<span class="hljs-string">&quot;DAO Error: &quot;</span>) + <br>               (type == CONNECTION_FAILED ? <span class="hljs-string">&quot;连接失败&quot;</span> : <span class="hljs-string">&quot;查询失败&quot;</span>) +<br>               <span class="hljs-string">&quot; SQL: &quot;</span> + sql + <span class="hljs-string">&quot; Code: &quot;</span> + std::<span class="hljs-built_in">to_string</span>(err);<br>    &#125;<br><br>    std::string sql_;<br>    ErrorType error_type_;<br>&#125;;<br><br><span class="hljs-comment">// 业务逻辑层异常</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceException</span> : <span class="hljs-keyword">public</span> BaseException &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">ServiceException</span>(<span class="hljs-type">const</span> std::string&amp; bizMsg, <span class="hljs-type">int</span> bizCode, <span class="hljs-type">const</span> BaseException&amp; cause)<br>        : <span class="hljs-built_in">BaseException</span>(bizMsg, bizCode, &amp;cause) &#123;&#125;<br><br>    <span class="hljs-function">ServiceException* <span class="hljs-title">clone</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">ServiceException</span>(*<span class="hljs-keyword">this</span>);<br>    &#125;<br>&#125;;<br><br><span class="hljs-comment">// 用户界面层异常（最终展示给用户）</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">UIException</span> : <span class="hljs-keyword">public</span> BaseException &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">UIException</span>(<span class="hljs-type">const</span> std::string&amp; userFriendlyMsg)<br>        : <span class="hljs-built_in">BaseException</span>(userFriendlyMsg) &#123;&#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="2-分层处理策略"><strong>2. 分层处理策略</strong></h3>
<h4 id="2-1-数据访问层（DAO-Layer）"><strong>2.1 数据访问层（DAO Layer）</strong></h4>
<ul>
<li><strong>职责</strong>：捕获数据库原生异常，转换为<code>DaoException</code></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDao</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">User <span class="hljs-title">findUser</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">executeQuery</span>(<span class="hljs-string">&quot;SELECT * FROM users WHERE id=&quot;</span> + std::<span class="hljs-built_in">to_string</span>(id));<br>        &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> mysqlpp::Exception&amp; e) &#123; <span class="hljs-comment">// 假设使用MySQL++</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-built_in">DaoException</span>(DaoException::QUERY_ERROR, <br>                             e.<span class="hljs-built_in">query</span>(), e.<span class="hljs-built_in">errnum</span>());<br>        &#125;<br>        <span class="hljs-comment">// ...</span><br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="2-2-业务逻辑层（Service-Layer）"><strong>2.2 业务逻辑层（Service Layer）</strong></h4>
<ul>
<li><strong>职责</strong>：捕获DAO异常，转换为业务语义异常，添加业务上下文</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">transferMoney</span><span class="hljs-params">(<span class="hljs-type">int</span> from, <span class="hljs-type">int</span> to, <span class="hljs-type">double</span> amount)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            UserDao dao;<br>            dao.<span class="hljs-built_in">withdraw</span>(from, amount); <span class="hljs-comment">// 可能抛出DaoException</span><br>            dao.<span class="hljs-built_in">deposit</span>(to, amount);<br>        &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> DaoException&amp; e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-built_in">ServiceException</span>(<span class="hljs-string">&quot;资金转账失败&quot;</span>, <span class="hljs-number">1001</span>, e);<br>        &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::invalid_argument&amp; e) &#123;<br>            <span class="hljs-comment">// 处理参数错误，不包装直接抛出</span><br>            <span class="hljs-keyword">throw</span>;<br>        &#125;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="2-3-用户界面层（UI-Layer）"><strong>2.3 用户界面层（UI Layer）</strong></h4>
<ul>
<li><strong>职责</strong>：捕获所有未处理异常，转换为用户友好提示</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">onTransferButtonClicked</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        UserService service;<br>        service.<span class="hljs-built_in">transferMoney</span>(<span class="hljs-built_in">getFromId</span>(), <span class="hljs-built_in">getToId</span>(), <span class="hljs-built_in">getAmount</span>());<br>        <span class="hljs-built_in">showSuccess</span>(<span class="hljs-string">&quot;转账成功！&quot;</span>);<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> ServiceException&amp; e) &#123;<br>        <span class="hljs-comment">// 解析业务错误码</span><br>        std::string userMsg = <span class="hljs-string">&quot;操作失败: &quot;</span> + std::<span class="hljs-built_in">string</span>(e.<span class="hljs-built_in">what</span>());<br>        <span class="hljs-keyword">if</span> (e.<span class="hljs-built_in">code</span>() == <span class="hljs-number">1001</span>) userMsg += <span class="hljs-string">&quot;（请检查余额）&quot;</span>;<br>        <span class="hljs-built_in">showError</span>(userMsg);<br><br>        <span class="hljs-comment">// 记录详细日志</span><br>        <span class="hljs-built_in">logError</span>(e);<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) &#123;<br>        <span class="hljs-built_in">showError</span>(<span class="hljs-string">&quot;系统错误，请联系管理员&quot;</span>);<br>        <span class="hljs-built_in">logError</span>(e);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 日志记录函数（递归打印异常链）</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">logError</span><span class="hljs-params">(<span class="hljs-type">const</span> BaseException&amp; e)</span> </span>&#123;<br>    std::cerr &lt;&lt; <span class="hljs-string">&quot;ERROR: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; <span class="hljs-string">&quot; [Code: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">code</span>() &lt;&lt; <span class="hljs-string">&quot;]\n&quot;</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> cause = e.<span class="hljs-built_in">cause</span>()) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;Caused by: &quot;</span>;<br>        <span class="hljs-built_in">logError</span>(*cause);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="3-关键技术实现"><strong>3. 关键技术实现</strong></h3>
<h4 id="3-1-异常链（Chain-of-Causality）"><strong>3.1 异常链（Chain of Causality）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 抛出时包装底层异常</span><br><span class="hljs-keyword">try</span> &#123;<br>    dao.<span class="hljs-built_in">update</span>(data);<br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> DaoException&amp; e) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-built_in">ServiceException</span>(<span class="hljs-string">&quot;更新数据失败&quot;</span>, <span class="hljs-number">2001</span>, e);<br>&#125;<br><br><span class="hljs-comment">// 日志输出</span><br>ERROR: 更新数据失败 [Code: <span class="hljs-number">2001</span>]<br>Caused by: DAO Error: 查询失败 SQL: UPDATE ... Code: <span class="hljs-number">1062</span><br></code></pre></td></tr></table></figure>
<h4 id="3-2-资源安全（RAII-异常安全保证）"><strong>3.2 资源安全（RAII + 异常安全保证）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Transaction</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Transaction</span>(Database&amp; db) : <span class="hljs-built_in">db_</span>(db) &#123; db_.<span class="hljs-built_in">begin</span>(); &#125;<br>    ~<span class="hljs-built_in">Transaction</span>() &#123; <span class="hljs-keyword">if</span> (!committed_) db_.<span class="hljs-built_in">rollback</span>(); &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">commit</span><span class="hljs-params">()</span> </span>&#123;<br>        db_.<span class="hljs-built_in">commit</span>();<br>        committed_ = <span class="hljs-literal">true</span>;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    Database&amp; db_;<br>    <span class="hljs-type">bool</span> committed_ = <span class="hljs-literal">false</span>;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">businessOperation</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-function">Transaction <span class="hljs-title">tx</span><span class="hljs-params">(db)</span></span>; <span class="hljs-comment">// RAII管理事务</span><br>    <span class="hljs-comment">// 多个数据库操作...</span><br>    tx.<span class="hljs-built_in">commit</span>(); <span class="hljs-comment">// 无异常则提交</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="4-分层处理决策树"><strong>4. 分层处理决策树</strong></h3>
<pre><code class=" mermaid">graph TD
    A[数据访问操作] --&gt;|抛出| B(DaoException)
    B --&gt;|捕获并转换| C&#123;业务层能否处理?&#125;
    C --&gt;|是| D[业务层处理并恢复]
    C --&gt;|否| E[包装为ServiceException]
    E --&gt;|传递到| F&#123;UI层能否处理?&#125;
    F --&gt;|是| G[显示友好提示]
    F --&gt;|否| H[全局处理器记录日志并终止]
</code></pre>
<hr>
<h3 id="5-性能优化建议"><strong>5. 性能优化建议</strong></h3>
<ol>
<li><strong>避免过度包装</strong>：仅在跨层边界时包装异常</li>
<li><strong>使用noexcept标记</strong>：对不会失败的函数（如简单getter）使用<code>noexcept</code><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">std::string <span class="hljs-title">getErrorMessage</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> msg_;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><strong>错误码替代</strong>：对高频调用的底层函数使用错误码返回<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">ErrorCode <span class="hljs-title">validateInput</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; input)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (input.<span class="hljs-built_in">empty</span>()) <span class="hljs-keyword">return</span> EC_EMPTY_INPUT;<br>    <span class="hljs-keyword">return</span> EC_SUCCESS;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h3 id="6-单元测试策略"><strong>6. 单元测试策略</strong></h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">TEST_CASE</span>(<span class="hljs-string">&quot;DAO层应正确转换数据库异常&quot;</span>) &#123;<br>    UserDao dao;<br>    <span class="hljs-built_in">REQUIRE_THROWS_MATCHES</span>(<br>        dao.<span class="hljs-built_in">findUser</span>(<span class="hljs-number">-1</span>), <br>        DaoException, <br>        Catch::<span class="hljs-built_in">Predicate</span>&lt;DaoException&gt;([](<span class="hljs-type">const</span> DaoException&amp; e) &#123;<br>            <span class="hljs-keyword">return</span> e.<span class="hljs-built_in">error_type</span>() == DaoException::QUERY_ERROR;<br>        &#125;)<br>    );<br>&#125;<br><br><span class="hljs-built_in">TEST_CASE</span>(<span class="hljs-string">&quot;Service层应包装DAO异常&quot;</span>) &#123;<br>    MockUserDao dao; <span class="hljs-comment">// 模拟抛出DaoException</span><br>    <span class="hljs-function">UserService <span class="hljs-title">service</span><span class="hljs-params">(dao)</span></span>;<br>    <span class="hljs-built_in">REQUIRE_THROWS_AS</span>(service.<span class="hljs-built_in">transferMoney</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">100</span>), ServiceException);<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="总结-2"><strong>总结</strong></h3>
<p>通过层次化异常处理设计，可实现：</p>
<ol>
<li><strong>关注点分离</strong>：每层专注处理其职责范围内的错误</li>
<li><strong>信息丰富化</strong>：异常链携带完整错误上下文</li>
<li><strong>用户友好</strong>：UI层隔离技术细节，展示清晰提示</li>
<li><strong>维护性提升</strong>：异常类型与业务语义直接关联</li>
</ol>
<p>关键原则：<strong>底层捕获技术异常，高层处理业务语义，顶层保证用户体验</strong>。建议结合静态分析工具（如Clang-Tidy）检查异常安全，确保设计落地。</p>
<h1>6 保持异常处理的各个部分尽量简洁。</h1>
<p>以下是保持C++异常处理简洁高效的核心实践和示例：</p>
<hr>
<h3 id="1-异常定义简洁化"><strong>1. 异常定义简洁化</strong></h3>
<h4 id="1-1-优先使用标准异常"><strong>1.1 优先使用标准异常</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdexcept&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">validate_age</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (age &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">&quot;年龄不能为负&quot;</span>);<br>    <span class="hljs-keyword">if</span> (age &gt; <span class="hljs-number">150</span>) <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">out_of_range</span>(<span class="hljs-string">&quot;年龄超过合理范围&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="1-2-必要时创建最少量的自定义异常"><strong>1.2 必要时创建最少量的自定义异常</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 仅当需要携带额外数据时创建</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentError</span> : <span class="hljs-keyword">public</span> std::runtime_error &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-type">int</span> amount;  <span class="hljs-comment">// 简洁的额外字段</span><br>    <span class="hljs-built_in">PaymentError</span>(<span class="hljs-type">const</span> std::string&amp; msg, <span class="hljs-type">int</span> amt)<br>        : std::<span class="hljs-built_in">runtime_error</span>(msg), <span class="hljs-built_in">amount</span>(amt) &#123;&#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="2-异常抛出简洁化"><strong>2. 异常抛出简洁化</strong></h3>
<h4 id="2-1-快速失败（Fail-Fast）"><strong>2.1 快速失败（Fail Fast）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process_input</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; input)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (input.<span class="hljs-built_in">empty</span>()) <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">&quot;输入为空&quot;</span>); <span class="hljs-comment">// 首行校验</span><br>    <span class="hljs-comment">// 后续逻辑...</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="2-2-使用noexcept标记不抛异常的函数"><strong>2.2 使用<code>noexcept</code>标记不抛异常的函数</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 明确告知编译器此函数不会抛出</span><br><span class="hljs-function">std::string <span class="hljs-title">format_message</span><span class="hljs-params">(<span class="hljs-type">int</span> code)</span> <span class="hljs-keyword">noexcept</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Error-&quot;</span> + std::<span class="hljs-built_in">to_string</span>(code); <span class="hljs-comment">// 简单操作，确保不抛异常</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="3-异常捕获简洁化"><strong>3. 异常捕获简洁化</strong></h3>
<h4 id="3-1-按层处理，避免过度捕获"><strong>3.1 按层处理，避免过度捕获</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 数据访问层</span><br><span class="hljs-keyword">try</span> &#123;<br>    db.<span class="hljs-built_in">execute</span>(sql);<br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> DatabaseTimeout&amp;) &#123;<br>    <span class="hljs-keyword">throw</span>; <span class="hljs-comment">// 直接重新抛出给业务层</span><br>&#125;<br><br><span class="hljs-comment">// 业务层</span><br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-built_in">process_order</span>();<br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> DatabaseTimeout&amp; e) &#123;<br>    <span class="hljs-built_in">retry_operation</span>(); <span class="hljs-comment">// 业务重试逻辑</span><br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) &#123;<br>    <span class="hljs-built_in">log_error</span>(e.<span class="hljs-built_in">what</span>());<br>    <span class="hljs-keyword">throw</span> <span class="hljs-built_in">ServiceUnavailable</span>(); <span class="hljs-comment">// 转换为业务异常</span><br>&#125;<br><br><span class="hljs-comment">// UI层</span><br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-built_in">start_app</span>();<br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> ServiceUnavailable&amp;) &#123;<br>    <span class="hljs-built_in">show_error</span>(<span class="hljs-string">&quot;服务暂不可用，请稍后重试&quot;</span>);<br>&#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>    <span class="hljs-built_in">show_error</span>(<span class="hljs-string">&quot;发生未知错误&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="4-资源管理简洁化"><strong>4. 资源管理简洁化</strong></h3>
<h4 id="4-1-使用智能指针自动管理"><strong>4.1 使用智能指针自动管理</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">load_data</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">auto</span> file = std::<span class="hljs-built_in">make_unique</span>&lt;std::ifstream&gt;(<span class="hljs-string">&quot;data.bin&quot;</span>);<br>    <span class="hljs-keyword">if</span> (!*file) <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;无法打开文件&quot;</span>); <br>    <span class="hljs-comment">// 无需手动关闭，unique_ptr析构自动处理</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="4-2-利用标准容器"><strong>4.2 利用标准容器</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process_items</span><span class="hljs-params">()</span> </span>&#123;<br>    std::vector&lt;Item&gt; items;<br>    items.<span class="hljs-built_in">reserve</span>(<span class="hljs-number">1000</span>); <span class="hljs-comment">// 预先分配减少异常可能性</span><br>    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">auto</span> item = <span class="hljs-built_in">fetch_item</span>()) &#123;<br>        items.<span class="hljs-built_in">push_back</span>(std::<span class="hljs-built_in">move</span>(item)); <span class="hljs-comment">// 自动内存管理</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="5-异常安全保证简洁化"><strong>5. 异常安全保证简洁化</strong></h3>
<h4 id="5-1-基本保证（Basic-Guarantee）示例"><strong>5.1 基本保证（Basic Guarantee）示例</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span> &#123;<br>    std::map&lt;std::string, std::string&gt; params;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; key, <span class="hljs-type">const</span> std::string&amp; value)</span> </span>&#123;<br>        <span class="hljs-keyword">auto</span> temp = params; <span class="hljs-comment">// 先复制</span><br>        temp[key] = value;   <span class="hljs-comment">// 修改副本</span><br>        params.<span class="hljs-built_in">swap</span>(temp);  <span class="hljs-comment">// 无异常则提交（强保证）</span><br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="6-全局处理简洁化"><strong>6. 全局处理简洁化</strong></h3>
<h4 id="6-1-设置简洁的终止处理器"><strong>6.1 设置简洁的终止处理器</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">terminate_handler</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> ex = std::<span class="hljs-built_in">current_exception</span>()) &#123;<br>            std::<span class="hljs-built_in">rethrow_exception</span>(ex);<br>        &#125;<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;未捕获异常: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; <span class="hljs-string">&quot;\n&quot;</span>;<br>    &#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;未知异常类型\n&quot;</span>;<br>    &#125;<br>    std::<span class="hljs-built_in">abort</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    std::<span class="hljs-built_in">set_terminate</span>(terminate_handler);<br>    <span class="hljs-comment">// 主逻辑...</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="7-测试简洁化"><strong>7. 测试简洁化</strong></h3>
<h4 id="7-1-使用宏简化测试代码"><strong>7.1 使用宏简化测试代码</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> REQUIRE_THROWS_MSG(expr, msg) \</span><br><span class="hljs-meta">    REQUIRE_THROWS_WITH(expr, Catch::Matchers::Contains(msg))</span><br><br><span class="hljs-built_in">TEST_CASE</span>(<span class="hljs-string">&quot;支付金额校验&quot;</span>) &#123;<br>    <span class="hljs-built_in">REQUIRE_THROWS_MSG</span>(<span class="hljs-built_in">process_payment</span>(<span class="hljs-number">-100</span>), <span class="hljs-string">&quot;金额无效&quot;</span>);<br>    <span class="hljs-built_in">REQUIRE_NOTHROW</span>(<span class="hljs-built_in">process_payment</span>(<span class="hljs-number">500</span>));<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="简洁化原则总结"><strong>简洁化原则总结</strong></h3>
<table>
<thead>
<tr>
<th>原则</th>
<th>实现方式</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>避免过度设计</strong></td>
<td>优先使用标准异常类型</td>
<td><code>throw std::invalid_argument</code></td>
</tr>
<tr>
<td><strong>资源自动管理</strong></td>
<td>使用智能指针和容器</td>
<td><code>std::unique_ptr</code>, <code>vector</code></td>
</tr>
<tr>
<td><strong>快速失败</strong></td>
<td>在函数开始处验证参数</td>
<td><code>if (input.empty()) throw...</code></td>
</tr>
<tr>
<td><strong>分层处理</strong></td>
<td>每层只处理自己关心的异常</td>
<td>DAO层不处理业务异常</td>
</tr>
<tr>
<td><strong>减少嵌套</strong></td>
<td>使用RAII替代try-catch嵌套</td>
<td>用<code>unique_ptr</code>而非手动释放</td>
</tr>
<tr>
<td><strong>明确函数契约</strong></td>
<td>用<code>noexcept</code>标记不抛异常的函数</td>
<td><code>void print() noexcept &#123;...&#125;</code></td>
</tr>
</tbody>
</table>
<hr>
<p>通过遵循这些简洁化原则，可在保持代码健壮性的同时，显著提升可读性和维护性。核心思想：<strong>让异常处理逻辑保持简单、直接和专注，避免不必要的复杂性</strong>。</p>
<h1>7 不要试图捕获每个函数的每个异常。</h1>
<p>在C++异常处理中，&quot;不要试图捕获每个函数的每个异常&quot;是保持代码健壮性和可维护性的重要原则。以下为具体实践指南和代码示例：</p>
<hr>
<h3 id="1-分层处理原则"><strong>1. 分层处理原则</strong></h3>
<h4 id="1-1-异常捕获的黄金法则"><strong>1.1 异常捕获的黄金法则</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 错误示例：底层函数过度捕获</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">lowLevelFunc</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">readFromDevice</span>(); <span class="hljs-comment">// 物理设备读取</span><br>    &#125; <span class="hljs-built_in">catch</span> (...) &#123;      <span class="hljs-comment">// ❌ 底层捕获所有异常</span><br>        <span class="hljs-built_in">log</span>(<span class="hljs-string">&quot;设备错误&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 正确做法：允许异常向上传播</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">businessLogic</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">lowLevelFunc</span>();<br>        <span class="hljs-built_in">processData</span>();<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> DeviceException&amp; e) &#123; <span class="hljs-comment">// ✅ 业务层处理</span><br>        <span class="hljs-built_in">retryOrAbort</span>(e);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="1-2-各层职责划分"><strong>1.2 各层职责划分</strong></h4>
<table>
<thead>
<tr>
<th>层级</th>
<th>处理策略</th>
<th>示例操作</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>底层库函数</strong></td>
<td>仅抛出，不处理</td>
<td>文件操作失败抛出<code>io_error</code></td>
</tr>
<tr>
<td><strong>业务逻辑层</strong></td>
<td>捕获可恢复异常，转换业务语义</td>
<td>将数据库异常转为业务错误码</td>
</tr>
<tr>
<td><strong>UI/API层</strong></td>
<td>最终捕获，展示友好信息</td>
<td>弹窗提示&quot;服务不可用&quot;</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="2-资源管理自动化"><strong>2. 资源管理自动化</strong></h3>
<h4 id="2-1-使用智能指针避免手动清理"><strong>2.1 使用智能指针避免手动清理</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 无需try-catch的资源管理</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">processFile</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">auto</span> file = std::<span class="hljs-built_in">make_unique</span>&lt;std::ifstream&gt;(<span class="hljs-string">&quot;data.bin&quot;</span>); <span class="hljs-comment">// RAII</span><br>    <span class="hljs-keyword">if</span> (!*file) <span class="hljs-keyword">throw</span> <span class="hljs-built_in">FileOpenError</span>();<br>    <br>    <span class="hljs-comment">// 即使后续抛出异常，file析构会自动关闭</span><br>    <span class="hljs-built_in">parseContent</span>(*file); <br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="2-2-事务操作模板"><strong>2.2 事务操作模板</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> Func&gt;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">transactionWrapper</span><span class="hljs-params">(Func op)</span> </span>&#123;<br>    <span class="hljs-built_in">beginTransaction</span>(); <span class="hljs-comment">// 事务开始</span><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">op</span>();          <span class="hljs-comment">// 业务操作</span><br>        <span class="hljs-built_in">commit</span>();      <span class="hljs-comment">// 无异常提交</span><br>    &#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>        <span class="hljs-built_in">rollback</span>();    <span class="hljs-comment">// 异常回滚</span><br>        <span class="hljs-keyword">throw</span>;         <span class="hljs-comment">// 继续传播</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 使用示例</span><br><span class="hljs-built_in">transactionWrapper</span>([] &#123;<br>    <span class="hljs-built_in">updateAccount</span>(<span class="hljs-number">1</span>, <span class="hljs-number">-100</span>);  <span class="hljs-comment">// 扣款</span><br>    <span class="hljs-built_in">updateAccount</span>(<span class="hljs-number">2</span>, <span class="hljs-number">+100</span>);  <span class="hljs-comment">// 加款</span><br>&#125;);<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="3-异常传播策略"><strong>3. 异常传播策略</strong></h3>
<h4 id="3-1-只处理能解决的异常"><strong>3.1 只处理能解决的异常</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 中间件层：仅处理特定异常</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">middleware</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">callDownstreamService</span>();<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> TimeoutException&amp;) &#123; <span class="hljs-comment">// 只处理超时重试</span><br>        <span class="hljs-built_in">retry</span>(<span class="hljs-number">3</span>);<br>    &#125; <span class="hljs-comment">// 其他异常继续传播</span><br>&#125;<br><br><span class="hljs-comment">// 调用方</span><br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-built_in">middleware</span>();<br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> ServiceException&amp; e) &#123;<br>    <span class="hljs-built_in">showUserError</span>(e); <span class="hljs-comment">// 最终处理</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="3-2-不可恢复错误快速失败"><strong>3.2 不可恢复错误快速失败</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">validateConfig</span><span class="hljs-params">(<span class="hljs-type">const</span> Config&amp; cfg)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (!cfg.<span class="hljs-built_in">isValid</span>()) &#123;<br>        <span class="hljs-built_in">logFatal</span>(<span class="hljs-string">&quot;配置损坏，无法启动&quot;</span>);<br>        std::<span class="hljs-built_in">terminate</span>(); <span class="hljs-comment">// ❗立即终止</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="4-异常安全保证"><strong>4. 异常安全保证</strong></h3>
<h4 id="4-1-基本异常安全示例"><strong>4.1 基本异常安全示例</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Document</span> &#123;<br>    std::vector&lt;Page&gt; pages_;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">addPage</span><span class="hljs-params">(<span class="hljs-type">const</span> Page&amp; p)</span> </span>&#123;<br>        pages_.<span class="hljs-built_in">push_back</span>(p); <span class="hljs-comment">// 可能抛出bad_alloc</span><br>        <span class="hljs-comment">// 失败时保持原有pages_不变（基本安全）</span><br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="4-2-强异常安全实现"><strong>4.2 强异常安全实现</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">swapContents</span><span class="hljs-params">(Document&amp; doc, <span class="hljs-type">const</span> Page&amp; newPage)</span> </span>&#123;<br>    <span class="hljs-keyword">auto</span> temp = doc.pages_; <span class="hljs-comment">// 操作副本</span><br>    temp.<span class="hljs-built_in">push_back</span>(newPage);<br>    doc.pages_.<span class="hljs-built_in">swap</span>(temp);  <span class="hljs-comment">// 无异常则原子交换（强安全）</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="5-日志与调试辅助"><strong>5. 日志与调试辅助</strong></h3>
<h4 id="5-1-集中式异常日志"><strong>5.1 集中式异常日志</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 全局捕获处理器</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">globalHandler</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// ...重新抛出异常</span><br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) &#123;<br>        <span class="hljs-built_in">logException</span>(e);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isCritical</span>(e)) <span class="hljs-built_in">sendAlert</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 结构化日志记录</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">logException</span><span class="hljs-params">(<span class="hljs-type">const</span> std::exception&amp; e)</span> </span>&#123;<br>    json log = &#123;<br>        &#123;<span class="hljs-string">&quot;timestamp&quot;</span>, <span class="hljs-built_in">getTime</span>()&#125;,<br>        &#123;<span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-built_in">typeid</span>(e).<span class="hljs-built_in">name</span>()&#125;,<br>        &#123;<span class="hljs-string">&quot;message&quot;</span>, e.<span class="hljs-built_in">what</span>()&#125;,<br>        &#123;<span class="hljs-string">&quot;stack&quot;</span>, <span class="hljs-built_in">getStacktrace</span>()&#125;<br>    &#125;;<br>    logger.<span class="hljs-built_in">write</span>(log);<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="关键决策表"><strong>关键决策表</strong></h3>
<table>
<thead>
<tr>
<th>场景</th>
<th>处理方式</th>
<th>代码示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>物理资源操作失败（文件/网络）</td>
<td>抛出技术异常，不捕获</td>
<td><code>throw FileIOException(...)</code></td>
</tr>
<tr>
<td>业务规则校验失败</td>
<td>立即抛出业务异常</td>
<td><code>throw InvalidOrder(...)</code></td>
</tr>
<tr>
<td>第三方库错误</td>
<td>包装为系统异常向上抛</td>
<td><code>throw DatabaseError(...)</code></td>
</tr>
<tr>
<td>内存耗尽等不可恢复错误</td>
<td>记录后终止程序</td>
<td><code>std::terminate()</code></td>
</tr>
<tr>
<td>用户输入校验</td>
<td>立即返回错误码，不使用异常</td>
<td><code>return ErrorCode::Invalid</code></td>
</tr>
</tbody>
</table>
<hr>
<h3 id="最佳实践总结"><strong>最佳实践总结</strong></h3>
<ol>
<li><strong>抛出清晰</strong>：每个异常应携带足够诊断信息（错误码、上下文）</li>
<li><strong>资源无忧</strong>：通过RAII和智能指针确保资源自动释放</li>
<li><strong>层级过滤</strong>：技术异常在底层抛出，业务层转换语义，UI层友好提示</li>
<li><strong>安全保证</strong>：明确函数提供的异常安全等级（基本/强/noexcept）</li>
<li><strong>监控到位</strong>：全局处理器记录未捕获异常，结合日志分析</li>
</ol>
<p>通过遵循这些原则，可在保持代码简洁的同时构建健壮的异常处理体系，避免陷入&quot;异常处理反模式&quot;的陷阱。记住：<strong>好的异常处理是战略性的，而非事无巨细的战术防御</strong>。</p>
<h1>8 至少提供基本保障。</h1>
<p>在C++中，确保代码至少提供 <strong>基本异常安全保证</strong>（Basic Exception Safety Guarantee）是健壮代码设计的底线。基本保证要求：当异常发生时，程序不泄露资源，所有对象仍处于有效状态（可安全析构），且程序状态保持一致性。以下是具体实现策略和代码示例：</p>
<hr>
<h3 id="1-RAII（资源获取即初始化）"><strong>1. RAII（资源获取即初始化）</strong></h3>
<h4 id="1-1-使用智能指针管理动态内存"><strong>1.1 使用智能指针管理动态内存</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process_data</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span> </span>&#123;<br>    <span class="hljs-keyword">auto</span> buffer = std::<span class="hljs-built_in">make_unique</span>&lt;<span class="hljs-type">int</span>[]&gt;(size); <span class="hljs-comment">// 自动管理内存</span><br>    <span class="hljs-comment">// 即使后续操作抛出异常，buffer析构时也会自动释放内存</span><br>    <span class="hljs-built_in">fill_buffer</span>(buffer.<span class="hljs-built_in">get</span>(), size);<br>    <span class="hljs-built_in">save_to_database</span>(buffer.<span class="hljs-built_in">get</span>(), size);<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="1-2-自定义RAII类管理文件句柄"><strong>1.2 自定义RAII类管理文件句柄</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeFile</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">SafeFile</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span> </span><br><span class="hljs-function">        : file_(path, std::ios::binary) &#123;</span><br>        <span class="hljs-keyword">if</span> (!file_) <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;无法打开文件&quot;</span>);<br>    &#125;<br><br>    ~<span class="hljs-built_in">SafeFile</span>() <span class="hljs-keyword">noexcept</span> &#123;<br>        <span class="hljs-keyword">if</span> (file_.<span class="hljs-built_in">is_open</span>()) file_.<span class="hljs-built_in">close</span>();<br>    &#125;<br><br>    <span class="hljs-comment">// 禁用拷贝，允许移动</span><br>    <span class="hljs-built_in">SafeFile</span>(<span class="hljs-type">const</span> SafeFile&amp;) = <span class="hljs-keyword">delete</span>;<br>    SafeFile&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> SafeFile&amp;) = <span class="hljs-keyword">delete</span>;<br>    <span class="hljs-built_in">SafeFile</span>(SafeFile&amp;&amp;) = <span class="hljs-keyword">default</span>;<br>    SafeFile&amp; <span class="hljs-keyword">operator</span>=(SafeFile&amp;&amp;) = <span class="hljs-keyword">default</span>;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; data)</span> </span>&#123;<br>        file_ &lt;&lt; data;<br>        <span class="hljs-keyword">if</span> (!file_.<span class="hljs-built_in">good</span>()) <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;写入失败&quot;</span>);<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    std::ofstream file_;<br>&#125;;<br><br><span class="hljs-comment">// 使用示例</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">log_message</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; msg)</span> </span>&#123;<br>    <span class="hljs-function">SafeFile <span class="hljs-title">logfile</span><span class="hljs-params">(<span class="hljs-string">&quot;app.log&quot;</span>)</span></span>; <span class="hljs-comment">// RAII保证文件关闭</span><br>    logfile.<span class="hljs-built_in">write</span>(msg);<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="2-异常安全的关键操作"><strong>2. 异常安全的关键操作</strong></h3>
<h4 id="2-1-构造函数中的异常安全"><strong>2.1 构造函数中的异常安全</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConnection</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">DatabaseConnection</span>(<span class="hljs-type">const</span> std::string&amp; config) &#123;<br>        handle_ = <span class="hljs-built_in">open_connection</span>(config); <span class="hljs-comment">// 可能失败的操作</span><br>        <span class="hljs-keyword">if</span> (!handle_) &#123;<br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;连接失败&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">// 若此处抛出异常，已分配的handle_会被析构函数释放</span><br>    &#125;<br><br>    ~<span class="hljs-built_in">DatabaseConnection</span>() <span class="hljs-keyword">noexcept</span> &#123;<br>        <span class="hljs-keyword">if</span> (handle_) <span class="hljs-built_in">close_connection</span>(handle_);<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    DBHandle* handle_ = <span class="hljs-literal">nullptr</span>;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="2-2-赋值操作符的异常安全"><strong>2.2 赋值操作符的异常安全</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    Config&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> Config&amp; other) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> != &amp;other) &#123;<br>            <span class="hljs-keyword">auto</span> temp = other.data_;  <span class="hljs-comment">// 先复制数据</span><br>            data_.<span class="hljs-built_in">swap</span>(temp);         <span class="hljs-comment">// 无异常则交换（强保证）</span><br>        &#125;<br>        <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    std::vector&lt;std::string&gt; data_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="3-避免资源泄漏的编码模式"><strong>3. 避免资源泄漏的编码模式</strong></h3>
<h4 id="3-1-确保先分配资源再修改状态"><strong>3.1 确保先分配资源再修改状态</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update_user_profile</span><span class="hljs-params">(User&amp; user, <span class="hljs-type">const</span> Profile&amp; new_profile)</span> </span>&#123;<br>    <span class="hljs-keyword">auto</span>* new_data = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ProfileData</span>(new_profile); <span class="hljs-comment">// 先分配资源</span><br>    <span class="hljs-keyword">delete</span> user.data_;      <span class="hljs-comment">// 再释放旧资源</span><br>    user.data_ = new_data;  <span class="hljs-comment">// 最后更新指针</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="3-2-使用std-lock-guard管理互斥锁"><strong>3.2 使用<code>std::lock_guard</code>管理互斥锁</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span><br><br>std::mutex db_mutex;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">thread_safe_query</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(db_mutex)</span></span>; <span class="hljs-comment">// 自动释放锁</span><br>    <span class="hljs-built_in">execute_query</span>(<span class="hljs-string">&quot;SELECT * FROM users&quot;</span>);       <span class="hljs-comment">// 可能抛出异常</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="4-异常安全的数据结构操作"><strong>4. 异常安全的数据结构操作</strong></h3>
<h4 id="4-1-使用std-vector代替裸数组"><strong>4.1 使用<code>std::vector</code>代替裸数组</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SensorData</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">add_reading</span><span class="hljs-params">(<span class="hljs-type">double</span> value)</span> </span>&#123;<br>        readings_.<span class="hljs-built_in">push_back</span>(value); <span class="hljs-comment">// 可能抛出bad_alloc</span><br>        <span class="hljs-comment">// 若push_back失败，readings_仍保持原有数据</span><br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    std::vector&lt;<span class="hljs-type">double</span>&gt; readings_; <span class="hljs-comment">// 自动管理内存</span><br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="4-2-安全的元素删除（先复制后修改）"><strong>4.2 安全的元素删除（先复制后修改）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">remove_invalid_entries</span><span class="hljs-params">(std::vector&lt;Entry&gt;&amp; entries)</span> </span>&#123;<br>    <span class="hljs-keyword">auto</span> valid_entries = entries; <span class="hljs-comment">// 先创建副本</span><br>    std::<span class="hljs-built_in">erase_if</span>(valid_entries, [](<span class="hljs-type">const</span> Entry&amp; e) &#123; <br>        <span class="hljs-keyword">return</span> !e.<span class="hljs-built_in">is_valid</span>(); <br>    &#125;);<br>    entries.<span class="hljs-built_in">swap</span>(valid_entries);  <span class="hljs-comment">// 无异常则原子交换</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="5-测试异常安全"><strong>5. 测试异常安全</strong></h3>
<h4 id="5-1-验证资源释放"><strong>5.1 验证资源释放</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">TEST_CASE</span>(<span class="hljs-string">&quot;数据库连接异常时释放资源&quot;</span>) &#123;<br>    <span class="hljs-type">bool</span> resource_released = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-function">DatabaseConnection <span class="hljs-title">conn</span><span class="hljs-params">(<span class="hljs-string">&quot;invalid_config&quot;</span>)</span></span>; <span class="hljs-comment">// 构造失败</span><br>    &#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>        resource_released = <span class="hljs-built_in">check_resource_cleanup</span>(); <span class="hljs-comment">// 验证句柄已关闭</span><br>    &#125;<br>    <span class="hljs-built_in">REQUIRE</span>(resource_released);<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="5-2-验证数据一致性"><strong>5.2 验证数据一致性</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">TEST_CASE</span>(<span class="hljs-string">&quot;vector插入失败时保持原数据&quot;</span>) &#123;<br>    std::vector&lt;<span class="hljs-type">int</span>&gt; data = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;;<br>    <span class="hljs-keyword">auto</span> original = data;<br>    <span class="hljs-keyword">try</span> &#123;<br>        data.<span class="hljs-built_in">insert</span>(data.<span class="hljs-built_in">end</span>(), <span class="hljs-number">4</span>); <span class="hljs-comment">// 假设插入失败抛出异常</span><br>    &#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>        <span class="hljs-built_in">REQUIRE</span>(data == original); <span class="hljs-comment">// 数据未损坏</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="关键原则总结"><strong>关键原则总结</strong></h3>
<table>
<thead>
<tr>
<th>原则</th>
<th>实现方法</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>资源自动释放</strong></td>
<td>使用RAII对象（智能指针、容器、自定义类）</td>
<td><code>std::unique_ptr</code>, <code>SafeFile</code></td>
</tr>
<tr>
<td><strong>操作顺序安全</strong></td>
<td>先分配新资源，再释放旧资源</td>
<td><code>new_data</code> → <code>delete old</code></td>
</tr>
<tr>
<td><strong>无副作用修改</strong></td>
<td>先操作副本，成功后再修改主数据</td>
<td><code>temp.swap(data_)</code></td>
</tr>
<tr>
<td><strong>原子性操作</strong></td>
<td>使用<code>swap</code>或<code>move</code>实现无异常操作</td>
<td><code>vector::swap</code></td>
</tr>
<tr>
<td><strong>避免裸资源管理</strong></td>
<td>优先使用标准库容器而非<code>new/delete</code></td>
<td><code>std::vector</code>代替<code>int[]</code></td>
</tr>
</tbody>
</table>
<hr>
<p>通过遵循这些实践，即使代码中发生异常，也能确保：</p>
<ol>
<li><strong>资源不泄漏</strong>：所有已分配的内存、文件句柄、网络连接等都会被正确释放</li>
<li><strong>对象有效</strong>：所有对象处于可安全析构的状态</li>
<li><strong>数据一致性</strong>：关键数据结构不会处于半完成状态</li>
</ol>
<p><strong>最终建议</strong>：在类的设计文档中明确标注每个方法的异常安全等级（基本/强/无异常），作为与团队约定的契约。</p>
<h1>9 除非有足够的理由，否则最好提供强保障。</h1>
<p>在C++中，<strong>强异常安全保证（Strong Exception Safety Guarantee）</strong> 要求操作要么完全成功，要么失败时程序状态与操作开始前完全一致。以下是如何实现这一目标的策略与代码示例：</p>
<hr>
<h3 id="1-强异常安全的核心模式"><strong>1. 强异常安全的核心模式</strong></h3>
<h4 id="1-1-Copy-and-Swap-模式"><strong>1.1 Copy-and-Swap 模式</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; key, <span class="hljs-type">const</span> std::string&amp; value)</span> </span>&#123;<br>        <span class="hljs-keyword">auto</span> temp = data_;      <span class="hljs-comment">// 1. 创建副本</span><br>        temp[key] = value;      <span class="hljs-comment">// 2. 修改副本（可能抛异常）</span><br>        data_.<span class="hljs-built_in">swap</span>(temp);       <span class="hljs-comment">// 3. 无异常则原子交换</span><br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    std::map&lt;std::string, std::string&gt; data_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="1-2-事务性文件写入"><strong>1.2 事务性文件写入</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">safe_write_file</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path, <span class="hljs-type">const</span> std::string&amp; content)</span> </span>&#123;<br>    <span class="hljs-type">const</span> std::string temp_path = path + <span class="hljs-string">&quot;.tmp&quot;</span>;<br>    <br>    &#123; <span class="hljs-comment">// 临时文件作用域</span><br>        <span class="hljs-function">std::ofstream <span class="hljs-title">tmp</span><span class="hljs-params">(temp_path)</span></span>;<br>        <span class="hljs-keyword">if</span> (!tmp) <span class="hljs-keyword">throw</span> <span class="hljs-built_in">FileOpenError</span>(temp_path);<br>        tmp &lt;&lt; content; <span class="hljs-comment">// 可能抛异常</span><br>    &#125; <span class="hljs-comment">// 文件流在此析构，确保内容刷新到磁盘</span><br><br>    <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">rename</span>(temp_path.<span class="hljs-built_in">c_str</span>(), path.<span class="hljs-built_in">c_str</span>()) != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">FileRenameError</span>(temp_path, path);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="2-标准库的强安全操作"><strong>2. 标准库的强安全操作</strong></h3>
<h4 id="2-1-std-vector-的插入操作"><strong>2.1 <code>std::vector</code> 的插入操作</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp">std::vector&lt;<span class="hljs-type">int</span>&gt; data = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;;<br><br><span class="hljs-comment">// 强安全保证的插入方式</span><br>data.<span class="hljs-built_in">reserve</span>(data.<span class="hljs-built_in">size</span>() + <span class="hljs-number">1</span>); <span class="hljs-comment">// 预先分配空间（可能抛bad_alloc）</span><br>data.<span class="hljs-built_in">push_back</span>(<span class="hljs-number">4</span>);             <span class="hljs-comment">// 不会重新分配，保证强安全</span><br></code></pre></td></tr></table></figure>
<h4 id="2-2-std-map-的安全更新"><strong>2.2 <code>std::map</code> 的安全更新</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp">std::map&lt;<span class="hljs-type">int</span>, std::string&gt; registry;<br><br><span class="hljs-comment">// 安全插入或更新</span><br><span class="hljs-keyword">auto</span> hint = registry.<span class="hljs-built_in">find</span>(<span class="hljs-number">42</span>);<br><span class="hljs-keyword">if</span> (hint != registry.<span class="hljs-built_in">end</span>()) &#123;<br>    <span class="hljs-keyword">auto</span> temp = hint-&gt;second;  <span class="hljs-comment">// 创建副本</span><br>    temp += <span class="hljs-string">&quot;_modified&quot;</span>;        <span class="hljs-comment">// 修改副本</span><br>    registry[<span class="hljs-number">42</span>] = std::<span class="hljs-built_in">move</span>(temp); <span class="hljs-comment">// 原子替换</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    registry.<span class="hljs-built_in">emplace</span>(<span class="hljs-number">42</span>, <span class="hljs-string">&quot;new_value&quot;</span>); <span class="hljs-comment">// 无副作用的插入</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="3-移动语义优化"><strong>3. 移动语义优化</strong></h3>
<h4 id="3-1-移动-回滚机制"><strong>3.1 移动+回滚机制</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Transaction</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Transaction</span>() &#123;<br>        backup_ = current_state_; <span class="hljs-comment">// 保存初始状态</span><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">commit</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">// 尝试应用修改（可能抛异常）</span><br>        <span class="hljs-built_in">apply_changes</span>();<br>        committed_ = <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    ~<span class="hljs-built_in">Transaction</span>() &#123;<br>        <span class="hljs-keyword">if</span> (!committed_) &#123;<br>            current_state_ = backup_; <span class="hljs-comment">// 失败时回滚</span><br>        &#125;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">static</span> State current_state_;<br>    State backup_;<br>    <span class="hljs-type">bool</span> committed_ = <span class="hljs-literal">false</span>;<br>&#125;;<br><br><span class="hljs-comment">// 使用示例</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">business_operation</span><span class="hljs-params">()</span> </span>&#123;<br>    Transaction tx;  <span class="hljs-comment">// 进入作用域即开始事务</span><br>    tx.<span class="hljs-built_in">modify_A</span>();   <span class="hljs-comment">// 修改操作</span><br>    tx.<span class="hljs-built_in">modify_B</span>();<br>    tx.<span class="hljs-built_in">commit</span>();     <span class="hljs-comment">// 无异常则提交</span><br>&#125; <span class="hljs-comment">// 析构时自动处理回滚</span><br></code></pre></td></tr></table></figure>
<hr>
<h3 id="4-性能权衡场景"><strong>4. 性能权衡场景</strong></h3>
<h4 id="4-1-可接受的妥协示例"><strong>4.1 可接受的妥协示例</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 场景：高频调用的低延迟函数</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process_packet</span><span class="hljs-params">(NetworkPacket&amp; packet)</span> <span class="hljs-keyword">noexcept</span> </span>&#123;<br>    <span class="hljs-comment">// 禁用异常，使用错误码返回</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">validate</span>(packet)) &#123;<br>        stats_.invalid_packets++; <span class="hljs-comment">// 基本保证：计数器可能少计</span><br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">// 处理逻辑...</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>妥协理由</strong>：</p>
<ul>
<li>每秒处理百万级网络包</li>
<li>错误率低于0.1%</li>
<li>计数器精度损失可接受</li>
</ul>
<hr>
<h3 id="5-强安全测试策略"><strong>5. 强安全测试策略</strong></h3>
<h4 id="5-1-使用std-exception-ptr模拟失败"><strong>5.1 使用<code>std::exception_ptr</code>模拟失败</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">TEST_CASE</span>(<span class="hljs-string">&quot;数据库更新满足强安全保证&quot;</span>) &#123;<br>    Database original = <span class="hljs-built_in">get_current_state</span>();<br><br>    <span class="hljs-type">bool</span> exception_thrown = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 模拟可能失败的操作</span><br>        <span class="hljs-built_in">throw_on_nth_call</span>(<span class="hljs-number">2</span>); <span class="hljs-comment">// 第2次调用抛异常</span><br>        <span class="hljs-built_in">perform_atomic_update</span>();<br>    &#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>        exception_thrown = <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-built_in">REQUIRE</span>(exception_thrown);<br>    <span class="hljs-built_in">REQUIRE</span>(<span class="hljs-built_in">get_current_state</span>() == original); <span class="hljs-comment">// 验证状态回滚</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="实现强安全的关键技术"><strong>实现强安全的关键技术</strong></h3>
<table>
<thead>
<tr>
<th>技术</th>
<th>适用场景</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Copy-and-Swap</strong></td>
<td>对象状态修改</td>
<td><code>vector::push_back</code></td>
</tr>
<tr>
<td><strong>事务模式</strong></td>
<td>多步骤操作</td>
<td>数据库事务</td>
</tr>
<tr>
<td><strong>无副操作</strong></td>
<td>简单查询/只读方法</td>
<td><code>const</code>成员函数</td>
</tr>
<tr>
<td><strong>移动语义</strong></td>
<td>资源所有权转移</td>
<td><code>std::unique_ptr</code>的移动构造</td>
</tr>
<tr>
<td><strong>延迟修改</strong></td>
<td>需要原子性的批量操作</td>
<td>先收集所有修改，最后一次性提交</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="何时可以放宽要求？"><strong>何时可以放宽要求？</strong></h3>
<table>
<thead>
<tr>
<th>场景</th>
<th>可接受的安全等级</th>
<th>理由</th>
</tr>
</thead>
<tbody>
<tr>
<td>性能关键路径</td>
<td>基本保证</td>
<td>强安全开销超过性能预算</td>
</tr>
<tr>
<td>临时对象操作</td>
<td>无保证</td>
<td>对象即将销毁，状态无关紧要</td>
</tr>
<tr>
<td>错误统计</td>
<td>基本保证</td>
<td>计数器误差可接受</td>
</tr>
<tr>
<td>硬件交互</td>
<td>无保证</td>
<td>物理设备状态无法回滚</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="最佳实践总结-2"><strong>最佳实践总结</strong></h3>
<ol>
<li><strong>默认选择强安全</strong>：除非有明确理由否则优先实现</li>
<li><strong>利用标准库设施</strong>：<code>vector::push_back</code>、<code>map::emplace</code>等</li>
<li><strong>事务封装</strong>：对复杂操作使用RAII事务包装器</li>
<li><strong>移动优于拷贝</strong>：用移动语义减少临时对象创建</li>
<li><strong>明确文档契约</strong>：在函数注释中声明安全等级</li>
</ol>
<p>通过遵循这些原则，可以在大多数场景下以合理成本实现强异常安全，构建出既健壮又高效的C++系统。</p>
<h1>10 让构造函数建立不变式，如果不能，则抛出异常。</h1>
<p>在C++中，<strong>构造函数</strong>是建立类不变式（class invariants）的理想位置。如果构造函数无法满足类的不变式要求，应当抛出异常以确保对象不会被部分构造或处于无效状态。以下是具体实现策略和代码示例：</p>
<hr>
<h3 id="1-基本设计原则"><strong>1. 基本设计原则</strong></h3>
<ol>
<li><strong>不变式定义</strong>：明确类在任何时刻必须满足的条件（如<code>0 &lt; month &lt;= 12</code>）。</li>
<li><strong>构造函数验证</strong>：在构造函数中强制检查不变式条件。</li>
<li><strong>异常抛出</strong>：若不变式无法建立，立即抛出异常阻止对象创建。</li>
<li><strong>资源安全</strong>：使用RAII确保已分配资源在抛出异常前自动释放。</li>
</ol>
<hr>
<h3 id="2-标准示例：日期类"><strong>2. 标准示例：日期类</strong></h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdexcept&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Date</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-comment">// 构造函数必须建立&quot;有效日期&quot;的不变式</span><br>    <span class="hljs-built_in">Date</span>(<span class="hljs-type">int</span> year, <span class="hljs-type">int</span> month, <span class="hljs-type">int</span> day) <br>        : <span class="hljs-built_in">year_</span>(year), <span class="hljs-built_in">month_</span>(month), <span class="hljs-built_in">day_</span>(day) <br>    &#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">is_valid</span>(year, month, day)) &#123;<br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">&quot;无效的日期&quot;</span>);<br>        &#125;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">int</span> year_, month_, day_;<br><br>    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">is_valid</span><span class="hljs-params">(<span class="hljs-type">int</span> y, <span class="hljs-type">int</span> m, <span class="hljs-type">int</span> d)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (m &lt; <span class="hljs-number">1</span> || m &gt; <span class="hljs-number">12</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">if</span> (d &lt; <span class="hljs-number">1</span> || d &gt; <span class="hljs-built_in">days_in_month</span>(y, m)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">days_in_month</span><span class="hljs-params">(<span class="hljs-type">int</span> y, <span class="hljs-type">int</span> m)</span> </span>&#123; <span class="hljs-comment">/* ... */</span> &#125;<br>&#125;;<br><br><span class="hljs-comment">// 使用示例</span><br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-function">Date <span class="hljs-title">birthday</span><span class="hljs-params">(<span class="hljs-number">2023</span>, <span class="hljs-number">2</span>, <span class="hljs-number">30</span>)</span></span>; <span class="hljs-comment">// 抛出异常：2月无30日</span><br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::invalid_argument&amp; e) &#123;<br>    std::cerr &lt;&lt; <span class="hljs-string">&quot;错误: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="3-复杂场景：资源管理类"><strong>3. 复杂场景：资源管理类</strong></h3>
<h4 id="3-1-文件句柄管理"><strong>3.1 文件句柄管理</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeFile</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">SafeFile</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span></span><br><span class="hljs-function">        : file_(std::make_unique&lt;std::ifstream&gt;(path)) </span><br><span class="hljs-function">    &#123;</span><br>        <span class="hljs-keyword">if</span> (!file_-&gt;<span class="hljs-built_in">is_open</span>()) &#123;<br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;无法打开文件: &quot;</span> + path);<br>        &#125;<br>        <span class="hljs-comment">// 其他初始化（如读取文件头验证）</span><br>        <span class="hljs-built_in">validate_header</span>();<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    std::unique_ptr&lt;std::ifstream&gt; file_;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">validate_header</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-type">char</span> header[<span class="hljs-number">4</span>];<br>        file_-&gt;<span class="hljs-built_in">read</span>(header, <span class="hljs-number">4</span>);<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">is_valid_header</span>(header)) &#123;<br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;文件头不合法&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;;<br><br><span class="hljs-comment">// 使用示例</span><br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-function">SafeFile <span class="hljs-title">config</span><span class="hljs-params">(<span class="hljs-string">&quot;settings.dat&quot;</span>)</span></span>; <span class="hljs-comment">// 可能抛出两种异常</span><br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) &#123;<br>    <span class="hljs-comment">// 文件打开失败或头验证失败</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="3-2-数据库连接池"><strong>3.2 数据库连接池</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConnection</span> &#123; <span class="hljs-comment">/* ... */</span> &#125;;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionPool</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">ConnectionPool</span>(<span class="hljs-type">size_t</span> pool_size, <span class="hljs-type">const</span> std::string&amp; conn_str)<br>        : <span class="hljs-built_in">connections_</span>()<br>    &#123;<br>        <span class="hljs-keyword">if</span> (pool_size == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">&quot;连接池大小必须&gt;0&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; pool_size; ++i) &#123;<br>                connections_.<span class="hljs-built_in">push_back</span>(<br>                    std::<span class="hljs-built_in">make_unique</span>&lt;DatabaseConnection&gt;(conn_str)<br>                );<br>            &#125;<br>        &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> DatabaseException&amp;) &#123;<br>            <span class="hljs-comment">// 部分连接已创建，但构造函数失败</span><br>            <span class="hljs-comment">// unique_ptr自动释放已分配连接</span><br>            <span class="hljs-keyword">throw</span>; <span class="hljs-comment">// 重新抛出</span><br>        &#125;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    std::vector&lt;std::unique_ptr&lt;DatabaseConnection&gt;&gt; connections_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="4-高级技巧：复合对象构造"><strong>4. 高级技巧：复合对象构造</strong></h3>
<h4 id="4-1-成员对象的异常安全初始化"><strong>4.1 成员对象的异常安全初始化</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserProfile</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">UserProfile</span>(<span class="hljs-type">const</span> std::string&amp; name, <span class="hljs-type">int</span> age)<br>        : <span class="hljs-built_in">name_</span>(<span class="hljs-built_in">validate_name</span>(name)),  <span class="hljs-comment">// 可能抛异常</span><br>          <span class="hljs-built_in">age_</span>(<span class="hljs-built_in">validate_age</span>(age)),     <span class="hljs-comment">// 可能抛异常</span><br>          <span class="hljs-built_in">preferences_</span>(<span class="hljs-built_in">load_prefs</span>())   <span class="hljs-comment">// 可能抛异常</span><br>    &#123;<br>        <span class="hljs-comment">// 所有成员已成功初始化才进入构造函数体</span><br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    std::string name_;<br>    <span class="hljs-type">int</span> age_;<br>    Preferences preferences_;<br><br>    <span class="hljs-function"><span class="hljs-type">static</span> std::string <span class="hljs-title">validate_name</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; name)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (name.<span class="hljs-built_in">empty</span>()) <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">&quot;名字不能为空&quot;</span>);<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">validate_age</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (age &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">&quot;年龄不能为负&quot;</span>);<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">static</span> Preferences <span class="hljs-title">load_prefs</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-comment">/* 可能抛异常 */</span> &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="5-错误处理最佳实践"><strong>5. 错误处理最佳实践</strong></h3>
<table>
<thead>
<tr>
<th>场景</th>
<th>处理策略</th>
<th>代码示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>参数无效</strong></td>
<td>抛出<code>std::invalid_argument</code></td>
<td><code>throw std::invalid_argument(...)</code></td>
</tr>
<tr>
<td><strong>资源分配失败</strong></td>
<td>抛出<code>std::runtime_error</code>或其派生类</td>
<td><code>throw std::runtime_error(...)</code></td>
</tr>
<tr>
<td><strong>依赖项初始化失败</strong></td>
<td>允许异常传播，RAII自动清理</td>
<td>不捕获，依赖析构函数释放资源</td>
</tr>
<tr>
<td><strong>多阶段验证</strong></td>
<td>在成员初始化列表中尽早失败</td>
<td><code>: member(validate(arg))</code></td>
</tr>
</tbody>
</table>
<hr>
<h3 id="关键原则总结-2"><strong>关键原则总结</strong></h3>
<ol>
<li><strong>失败前置</strong>：在构造函数体执行前验证参数（使用成员初始化列表）</li>
<li><strong>原子性构造</strong>：要么完全成功，要么抛出异常（无半构造对象）</li>
<li><strong>资源自治</strong>：每个成员自身管理资源（使用智能指针、容器等）</li>
<li><strong>异常类型明确</strong>：根据错误类型选择标准或自定义异常</li>
<li><strong>禁止吞异常</strong>：构造函数不应捕获无关异常</li>
</ol>
<p>通过遵循这些原则，可以确保类的实例始终处于有效状态，同时保持代码的健壮性和可维护性。</p>
<h1>11 抛出异常前先释放局部资源。</h1>
<p>在C++中，确保在抛出异常前释放局部资源的最佳实践是采用RAII（Resource Acquisition Is Initialization）机制。以下是分步说明和代码示例：</p>
<hr>
<h3 id="1-理解RAII原则"><strong>1. 理解RAII原则</strong></h3>
<ul>
<li><strong>核心思想</strong>：将资源（内存、文件句柄、锁等）的生命周期绑定到对象的生命周期。</li>
<li><strong>构造函数</strong>：获取资源。</li>
<li><strong>析构函数</strong>：释放资源，确保在对象销毁时自动释放。</li>
</ul>
<hr>
<h3 id="2-使用智能指针管理动态内存"><strong>2. 使用智能指针管理动态内存</strong></h3>
<h4 id="示例：避免内存泄漏"><strong>示例：避免内存泄漏</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process_data</span><span class="hljs-params">()</span> </span>&#123;<br>    std::unique_ptr&lt;std::vector&lt;<span class="hljs-type">int</span>&gt;&gt; data = std::make_unique&lt;std::vector&lt;<span class="hljs-type">int</span>&gt;&gt;(<span class="hljs-number">1000</span>);<br>    <span class="hljs-comment">// 操作数据，可能抛出异常</span><br>    data-&gt;<span class="hljs-built_in">push_back</span>(<span class="hljs-number">42</span>);<br>    <span class="hljs-comment">// 无需手动释放内存，unique_ptr析构时自动释放</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="3-封装文件句柄的RAII类"><strong>3. 封装文件句柄的RAII类</strong></h3>
<h4 id="示例：安全处理文件"><strong>示例：安全处理文件</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdio&gt;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">FileRAII</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">FileRAII</span>(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* filename, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* mode) : <span class="hljs-built_in">file_</span>(<span class="hljs-built_in">fopen</span>(filename, mode)) &#123;<br>        <span class="hljs-keyword">if</span> (!file_) <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;无法打开文件&quot;</span>);<br>    &#125;<br><br>    ~<span class="hljs-built_in">FileRAII</span>() <span class="hljs-keyword">noexcept</span> &#123;<br>        <span class="hljs-keyword">if</span> (file_) <span class="hljs-built_in">fclose</span>(file_);<br>    &#125;<br><br>    <span class="hljs-function">FILE* <span class="hljs-title">handle</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> file_; &#125;<br><br>    <span class="hljs-comment">// 禁用拷贝</span><br>    <span class="hljs-built_in">FileRAII</span>(<span class="hljs-type">const</span> FileRAII&amp;) = <span class="hljs-keyword">delete</span>;<br>    FileRAII&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> FileRAII&amp;) = <span class="hljs-keyword">delete</span>;<br><br><span class="hljs-keyword">private</span>:<br>    FILE* file_;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">read_file</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-function">FileRAII <span class="hljs-title">file</span><span class="hljs-params">(<span class="hljs-string">&quot;data.txt&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>)</span></span>; <span class="hljs-comment">// 文件打开成功</span><br>    <span class="hljs-comment">// 读取文件操作，若抛出异常，析构函数自动关闭文件</span><br>    <span class="hljs-type">char</span> buffer[<span class="hljs-number">1024</span>];<br>    <span class="hljs-built_in">fread</span>(buffer, <span class="hljs-number">1</span>, <span class="hljs-built_in">sizeof</span>(buffer), file.<span class="hljs-built_in">handle</span>());<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="4-使用标准库容器管理资源"><strong>4. 使用标准库容器管理资源</strong></h3>
<h4 id="示例：自动释放动态数组"><strong>示例：自动释放动态数组</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">safe_array_operation</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-function">std::vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">array</span><span class="hljs-params">(<span class="hljs-number">1000</span>)</span></span>; <span class="hljs-comment">// 自动管理内存</span><br>    array[<span class="hljs-number">0</span>] = <span class="hljs-number">42</span>;               <span class="hljs-comment">// 操作可能抛出异常</span><br>    <span class="hljs-comment">// 无需手动释放，vector析构时自动释放内存</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="5-锁管理的RAII实现"><strong>5. 锁管理的RAII实现</strong></h3>
<h4 id="示例：避免死锁"><strong>示例：避免死锁</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span><br><br>std::mutex critical_section_mutex;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">thread_safe_operation</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(critical_section_mutex)</span></span>; <span class="hljs-comment">// 自动加锁</span><br>    <span class="hljs-comment">// 临界区操作，可能抛出异常</span><br>    <span class="hljs-comment">// 析构时自动解锁，即使发生异常</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="6-自定义数据库连接的RAII类"><strong>6. 自定义数据库连接的RAII类</strong></h3>
<h4 id="示例：安全释放数据库连接"><strong>示例：安全释放数据库连接</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConnection</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">DatabaseConnection</span>(<span class="hljs-type">const</span> std::string&amp; conn_str) &#123;<br>        <span class="hljs-built_in">connect</span>(conn_str); <span class="hljs-comment">// 可能抛出连接异常</span><br>    &#125;<br><br>    ~<span class="hljs-built_in">DatabaseConnection</span>() <span class="hljs-keyword">noexcept</span> &#123;<br>        <span class="hljs-keyword">if</span> (connected_) <span class="hljs-built_in">disconnect</span>(); <span class="hljs-comment">// 确保关闭连接</span><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; sql)</span> </span>&#123; <span class="hljs-comment">/* 可能抛出查询异常 */</span> &#125;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">bool</span> connected_ = <span class="hljs-literal">false</span>;<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">connect</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; str)</span> </span>&#123; <span class="hljs-comment">/* ... */</span> &#125;<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">disconnect</span><span class="hljs-params">()</span> <span class="hljs-keyword">noexcept</span> </span>&#123; <span class="hljs-comment">/* ... */</span> &#125;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">use_database</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-function">DatabaseConnection <span class="hljs-title">db</span><span class="hljs-params">(<span class="hljs-string">&quot;user=admin;password=1234&quot;</span>)</span></span>; <span class="hljs-comment">// 连接成功</span><br>    db.<span class="hljs-built_in">query</span>(<span class="hljs-string">&quot;SELECT * FROM users&quot;</span>);                   <span class="hljs-comment">// 可能抛出异常</span><br>    <span class="hljs-comment">// 析构时自动断开连接</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="7-手动资源管理的正确方式（不推荐）"><strong>7. 手动资源管理的正确方式（不推荐）</strong></h3>
<h4 id="示例：在try块内释放资源"><strong>示例：在try块内释放资源</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">legacy_code</span><span class="hljs-params">()</span> </span>&#123;<br>    Resource* res = <span class="hljs-built_in">acquire_resource</span>(); <span class="hljs-comment">// 获取资源</span><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">use_resource</span>(res); <span class="hljs-comment">// 可能抛出异常</span><br>    &#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>        <span class="hljs-built_in">release_resource</span>(res); <span class="hljs-comment">// 异常时释放资源</span><br>        <span class="hljs-keyword">throw</span>;                <span class="hljs-comment">// 重新抛出</span><br>    &#125;<br>    <span class="hljs-built_in">release_resource</span>(res); <span class="hljs-comment">// 正常流程释放</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="关键原则总结-3"><strong>关键原则总结</strong></h3>
<table>
<thead>
<tr>
<th>场景</th>
<th>RAII解决方案</th>
<th>优势</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>动态内存</strong></td>
<td><code>std::unique_ptr</code>, <code>std::vector</code></td>
<td>自动释放内存，避免泄漏</td>
</tr>
<tr>
<td><strong>文件操作</strong></td>
<td>自定义<code>FileRAII</code>类或<code>std::fstream</code></td>
<td>异常安全地关闭文件句柄</td>
</tr>
<tr>
<td><strong>多线程锁</strong></td>
<td><code>std::lock_guard</code></td>
<td>自动解锁，防止死锁</td>
</tr>
<tr>
<td><strong>网络/数据库连接</strong></td>
<td>封装连接的RAII类</td>
<td>确保连接最终关闭</td>
</tr>
<tr>
<td><strong>第三方C库资源</strong></td>
<td>自定义RAII包装器</td>
<td>将C风格资源转换为异常安全对象</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="为何RAII优于手动释放？"><strong>为何RAII优于手动释放？</strong></h3>
<ol>
<li><strong>异常安全</strong>：即使抛出异常，析构函数仍会调用。</li>
<li><strong>代码简洁</strong>：消除重复的<code>try-catch</code>和<code>delete</code>/<code>free</code>调用。</li>
<li><strong>维护性强</strong>：资源生命周期清晰可见。</li>
<li><strong>性能优化</strong>：减少冗余错误检查代码。</li>
</ol>
<hr>
<h3 id="验证RAII的异常安全性"><strong>验证RAII的异常安全性</strong></h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cassert&gt;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">TestRAII</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">TestRAII</span>(<span class="hljs-type">bool</span> fail) : <span class="hljs-built_in">valid_</span>(<span class="hljs-literal">true</span>) &#123;<br>        <span class="hljs-keyword">if</span> (fail) <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;构造失败&quot;</span>);<br>    &#125;<br><br>    ~<span class="hljs-built_in">TestRAII</span>() &#123; valid_ = <span class="hljs-literal">false</span>; &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">is_valid</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> valid_; &#125;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">bool</span> valid_;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-function">TestRAII <span class="hljs-title">obj</span><span class="hljs-params">(<span class="hljs-literal">true</span>)</span></span>; <span class="hljs-comment">// 构造时抛出异常</span><br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp;) &#123;<br>        <span class="hljs-comment">// 对象未被完全构造，析构函数不会执行</span><br>    &#125;<br><br>    <span class="hljs-function">TestRAII <span class="hljs-title">normal_obj</span><span class="hljs-params">(<span class="hljs-literal">false</span>)</span></span>;<br>    <span class="hljs-built_in">assert</span>(normal_obj.<span class="hljs-built_in">is_valid</span>()); <span class="hljs-comment">// 正常构造</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 析构函数调用，valid_变为false</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<p>通过遵循RAII原则，您可以确保所有局部资源在异常发生时被正确释放，从而编写出健壮且易于维护的C++代码。</p>
<h1>12 谨记在构造函数中抛出异常前释放所有已获取的资源。</h1>
<p>在C++中，当构造函数抛出异常时，<strong>已完全构造的成员变量和基类子对象的析构函数会被调用</strong>，但当前对象的析构函数不会执行。因此，必须通过RAII机制确保资源自动释放。以下是关键原则和代码示例：</p>
<hr>
<h3 id="1-基本原则：分层获取资源"><strong>1. 基本原则：分层获取资源</strong></h3>
<h4 id="1-1-成员变量按声明顺序初始化"><strong>1.1 成员变量按声明顺序初始化</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConnection</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-comment">// RAII成员按声明顺序初始化</span><br>    <span class="hljs-built_in">DatabaseConnection</span>(<span class="hljs-type">const</span> std::string&amp; conn_str)<br>        : <span class="hljs-built_in">logger_</span>(<span class="hljs-string">&quot;db.log&quot;</span>),      <span class="hljs-comment">// 1. 先初始化日志文件（RAII）</span><br>          <span class="hljs-built_in">handle_</span>(<span class="hljs-built_in">connect</span>(conn_str)) <span class="hljs-comment">// 2. 再获取数据库连接</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (!handle_) &#123;<br>            <span class="hljs-comment">// ❌ 错误：此时logger_已初始化，无法阻止其析构函数调用</span><br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;连接失败&quot;</span>);<br>        &#125;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    FileRAII logger_;  <span class="hljs-comment">// RAII成员，自动管理文件资源</span><br>    DBHandle* handle_; <span class="hljs-comment">// ❌ 危险：裸指针需手动释放</span><br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="修正方案：所有资源由RAII成员管理"><strong>修正方案：所有资源由RAII成员管理</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConnection</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">DatabaseConnection</span>(<span class="hljs-type">const</span> std::string&amp; conn_str)<br>        : <span class="hljs-built_in">logger_</span>(<span class="hljs-string">&quot;db.log&quot;</span>),<br>          <span class="hljs-built_in">handle_</span>(<span class="hljs-built_in">make_connection</span>(conn_str)) <span class="hljs-comment">// handle_是unique_ptr</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (!handle_) &#123;<br>            <span class="hljs-comment">// ✅ 无需手动释放，handle_析构函数自动处理</span><br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;连接失败&quot;</span>);<br>        &#125;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    FileRAII logger_;<br>    std::unique_ptr&lt;DBHandle&gt; handle_; <span class="hljs-comment">// RAII管理数据库连接</span><br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="2-分步资源获取策略"><strong>2. 分步资源获取策略</strong></h3>
<h4 id="2-1-每个资源对应一个RAII成员"><strong>2.1 每个资源对应一个RAII成员</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SecureSession</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">SecureSession</span>(<span class="hljs-type">const</span> std::string&amp; user)<br>        : <span class="hljs-built_in">auth_token_</span>(<span class="hljs-built_in">authenticate</span>(user)), <span class="hljs-comment">// RAII成员1：令牌</span><br>          <span class="hljs-built_in">encryptor_</span>(<span class="hljs-built_in">init_encryption</span>()),  <span class="hljs-comment">// RAII成员2：加密器</span><br>          <span class="hljs-built_in">log_stream_</span>(<span class="hljs-string">&quot;session.log&quot;</span>)      <span class="hljs-comment">// RAII成员3：日志文件</span><br>    &#123;<br>        <span class="hljs-comment">// 所有资源通过成员初始化列表获取</span><br>        <span class="hljs-comment">// 任一成员构造失败都会导致已构造成员的析构</span><br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    AuthTokenRAII auth_token_;<br>    EncryptionRAII encryptor_;<br>    FileRAII log_stream_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="2-2-动态资源管理"><strong>2.2 动态资源管理</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ImageProcessor</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">ImageProcessor</span>(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)<br>        : <span class="hljs-built_in">buffer1_</span>(std::<span class="hljs-built_in">make_unique</span>&lt;<span class="hljs-type">uint8_t</span>[]&gt;(width * height)),<br>          <span class="hljs-built_in">buffer2_</span>(std::<span class="hljs-built_in">make_unique</span>&lt;<span class="hljs-type">uint8_t</span>[]&gt;(width * height)) <br>    &#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">validate_buffers</span>()) &#123;<br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;缓冲区初始化失败&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">// ✅ 异常安全：unique_ptr自动释放内存</span><br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    std::unique_ptr&lt;<span class="hljs-type">uint8_t</span>[]&gt; buffer1_;<br>    std::unique_ptr&lt;<span class="hljs-type">uint8_t</span>[]&gt; buffer2_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="3-异常安全构造函数模板"><strong>3. 异常安全构造函数模板</strong></h3>
<h4 id="3-1-正确模式"><strong>3.1 正确模式</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeResourceOwner</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">SafeResourceOwner</span>()<br>        : <span class="hljs-built_in">res1_</span>(<span class="hljs-built_in">acquire_resource_1</span>()),  <span class="hljs-comment">// RAII成员1</span><br>          <span class="hljs-built_in">res2_</span>(<span class="hljs-built_in">acquire_resource_2</span>())   <span class="hljs-comment">// RAII成员2</span><br>    &#123;<br>        <span class="hljs-comment">// 仅在所有资源就绪后进行额外操作</span><br>        <span class="hljs-built_in">perform_initialization</span>();<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    ResourceRAII res1_;<br>    ResourceRAII res2_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="3-2-错误模式（手动管理）"><strong>3.2 错误模式（手动管理）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DangerousResourceOwner</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">DangerousResourceOwner</span>() &#123;<br>        res1_ = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Resource</span>(); <span class="hljs-comment">// ❌ 裸指针</span><br>        <span class="hljs-keyword">if</span> (!res1_-&gt;<span class="hljs-built_in">ok</span>()) &#123;<br>            <span class="hljs-keyword">delete</span> res1_; <span class="hljs-comment">// ⚠️ 必须手动释放</span><br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;资源1失败&quot;</span>);<br>        &#125;<br><br>        res2_ = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Resource</span>(); <span class="hljs-comment">// ❌ 第二个资源</span><br>        <span class="hljs-keyword">if</span> (!res2_-&gt;<span class="hljs-built_in">ok</span>()) &#123;<br>            <span class="hljs-keyword">delete</span> res1_; <span class="hljs-comment">// ⚠️ 需要手动释放res1_</span><br>            <span class="hljs-keyword">delete</span> res2_;<br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;资源2失败&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    ~<span class="hljs-built_in">DangerousResourceOwner</span>() &#123;<br>        <span class="hljs-keyword">delete</span> res1_;<br>        <span class="hljs-keyword">delete</span> res2_;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    Resource* res1_;<br>    Resource* res2_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="4-无法使用RAII时的处理"><strong>4. 无法使用RAII时的处理</strong></h3>
<h4 id="4-1-手动清理（不推荐，应急用）"><strong>4.1 手动清理（不推荐，应急用）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LegacyWrapper</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">LegacyWrapper</span>() &#123;<br>        handle1_ = <span class="hljs-built_in">legacy_init_1</span>(); <span class="hljs-comment">// C风格API</span><br>        <span class="hljs-keyword">if</span> (!handle1_) &#123;<br>            <span class="hljs-built_in">legacy_cleanup_1</span>(handle1_); <span class="hljs-comment">// 手动清理</span><br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;初始化1失败&quot;</span>);<br>        &#125;<br><br>        handle2_ = <span class="hljs-built_in">legacy_init_2</span>();<br>        <span class="hljs-keyword">if</span> (!handle2_) &#123;<br>            <span class="hljs-built_in">legacy_cleanup_1</span>(handle1_); <span class="hljs-comment">// 清理已分配资源</span><br>            <span class="hljs-built_in">legacy_cleanup_2</span>(handle2_);<br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;初始化2失败&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    ~<span class="hljs-built_in">LegacyWrapper</span>() &#123;<br>        <span class="hljs-built_in">legacy_cleanup_2</span>(handle2_);<br>        <span class="hljs-built_in">legacy_cleanup_1</span>(handle1_);<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    LegacyHandle handle1_;<br>    LegacyHandle handle2_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="关键原则总结-4"><strong>关键原则总结</strong></h3>
<table>
<thead>
<tr>
<th>场景</th>
<th>正确做法</th>
<th>错误做法</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>成员资源初始化</strong></td>
<td>通过RAII成员在初始化列表中获取资源</td>
<td>在构造函数体内用<code>new</code>分配</td>
</tr>
<tr>
<td><strong>多资源依赖</strong></td>
<td>每个资源对应一个RAII成员，按依赖顺序声明</td>
<td>手动管理多个资源的释放顺序</td>
</tr>
<tr>
<td><strong>第三方库集成</strong></td>
<td>编写RAII包装类封装C风格资源</td>
<td>直接使用裸指针或句柄</td>
</tr>
<tr>
<td><strong>异常处理</strong></td>
<td>依赖析构函数自动清理</td>
<td><code>try-catch</code>块内手动<code>delete</code></td>
</tr>
</tbody>
</table>
<hr>
<h3 id="验证工具"><strong>验证工具</strong></h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 使用valgrind检测资源泄漏</span><br>valgrind --leak-check=full ./your_program<br><br><span class="hljs-comment">// 编译时开启额外警告</span><br>g++ -Wall -Wextra -Werror your_code.cpp<br></code></pre></td></tr></table></figure>
<p>通过严格遵循RAII原则，可以确保即使构造函数抛出异常，所有已获取的资源也能被安全释放，避免内存泄漏和资源滞留。</p>
<h1>13 如果局部控制结构足以满足要求，不要使用异常。</h1>
<p>在C++中，异常机制应仅用于处理 <strong>不可恢复的错误</strong> 或 <strong>跨多层调用传递错误</strong>。对于可通过局部逻辑处理的常规错误，优先使用控制结构（如<code>if-else</code>、<code>while</code>）而非异常。以下是具体场景和最佳实践：</p>
<hr>
<h3 id="1-优先使用控制结构的场景"><strong>1. 优先使用控制结构的场景</strong></h3>
<h4 id="1-1-参数校验（可预期错误）"><strong>1.1 参数校验（可预期错误）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// ✅ 正确：使用if直接处理</span><br><span class="hljs-function">std::optional&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">safe_divide</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (b == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> std::<span class="hljs-literal">nullopt</span>; <span class="hljs-comment">// 预期内的错误</span><br>    <span class="hljs-keyword">return</span> a / b;<br>&#125;<br><br><span class="hljs-comment">// ❌ 错误：滥用异常</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">unsafe_divide</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (b == <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">&quot;除零错误&quot;</span>);<br>    <span class="hljs-keyword">return</span> a / b;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="1-2-用户输入验证"><strong>1.2 用户输入验证</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// ✅ 正确：通过循环和条件重试</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">read_positive_number</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-type">int</span> num;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;输入正整数: &quot;</span>;<br>        <span class="hljs-keyword">if</span> (std::cin &gt;&gt; num &amp;&amp; num &gt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> num;<br>        std::cin.<span class="hljs-built_in">clear</span>();<br>        std::cin.<span class="hljs-built_in">ignore</span>(std::numeric_limits&lt;std::streamsize&gt;::<span class="hljs-built_in">max</span>(), <span class="hljs-string">&#x27;\n&#x27;</span>);<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;输入无效，请重试\n&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// ❌ 错误：输入错误时抛出异常（过度设计）</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">bad_read_number</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-type">int</span> num;<br>    <span class="hljs-keyword">if</span> (!(std::cin &gt;&gt; num)) <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;输入错误&quot;</span>);<br>    <span class="hljs-keyword">return</span> num;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="2-错误码与状态标记"><strong>2. 错误码与状态标记</strong></h3>
<h4 id="2-1-返回错误码"><strong>2.1 返回错误码</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">enum class</span> <span class="hljs-title class_">ErrorCode</span> &#123; Success, FileNotFound, InvalidData &#125;;<br><br><span class="hljs-function">ErrorCode <span class="hljs-title">process_file</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">file_exists</span>(path)) <span class="hljs-keyword">return</span> ErrorCode::FileNotFound;<br>    <span class="hljs-comment">// 处理文件内容...</span><br>    <span class="hljs-keyword">return</span> ErrorCode::Success;<br>&#125;<br><br><span class="hljs-comment">// 调用方处理</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> code = <span class="hljs-built_in">process_file</span>(<span class="hljs-string">&quot;data.txt&quot;</span>); code != ErrorCode::Success) &#123;<br>    <span class="hljs-built_in">log_error</span>(code);<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="2-2-使用std-expected（C-23）"><strong>2.2 使用<code>std::expected</code>（C++23）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;expected&gt;</span></span><br><br><span class="hljs-function">std::expected&lt;std::string, ErrorCode&gt; <span class="hljs-title">load_config</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">file_exists</span>(path)) <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">unexpected</span>(ErrorCode::FileNotFound);<br>    <span class="hljs-comment">// 读取配置...</span><br>    <span class="hljs-keyword">return</span> config_data;<br>&#125;<br><br><span class="hljs-comment">// 调用方</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> config = <span class="hljs-built_in">load_config</span>(<span class="hljs-string">&quot;app.cfg&quot;</span>); config) &#123;<br>    <span class="hljs-built_in">use_config</span>(*config);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">handle_error</span>(config.<span class="hljs-built_in">error</span>());<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="3-资源管理（无需异常）"><strong>3. 资源管理（无需异常）</strong></h3>
<h4 id="3-1-RAII自动释放"><strong>3.1 RAII自动释放</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FileHandler</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">FileHandler</span>(<span class="hljs-type">const</span> std::string&amp; path) : <span class="hljs-built_in">file_</span>(<span class="hljs-built_in">fopen</span>(path.<span class="hljs-built_in">c_str</span>(), <span class="hljs-string">&quot;r&quot;</span>)) &#123;<br>        <span class="hljs-keyword">if</span> (!file_) <span class="hljs-built_in">log_error</span>(<span class="hljs-string">&quot;打开文件失败&quot;</span>); <span class="hljs-comment">// 记录但不抛异常</span><br>    &#125;<br>    ~<span class="hljs-built_in">FileHandler</span>() &#123; <span class="hljs-keyword">if</span> (file_) <span class="hljs-built_in">fclose</span>(file_); &#125;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-keyword">operator</span> <span class="hljs-title">bool</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> file_ != <span class="hljs-literal">nullptr</span>; &#125;<br><br><span class="hljs-keyword">private</span>:<br>    FILE* file_;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-function">FileHandler <span class="hljs-title">file</span><span class="hljs-params">(<span class="hljs-string">&quot;data.txt&quot;</span>)</span></span>;<br>    <span class="hljs-keyword">if</span> (!file) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 提前退出</span><br>    <span class="hljs-comment">// 使用文件...</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="4-性能敏感场景"><strong>4. 性能敏感场景</strong></h3>
<h4 id="4-1-高频调用函数"><strong>4.1 高频调用函数</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// ✅ 正确：避免异常开销</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">validate_packet</span><span class="hljs-params">(<span class="hljs-type">const</span> Packet&amp; pkt)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (pkt.size &gt; MAX_SIZE) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">if</span> (pkt.checksum != <span class="hljs-built_in">calculate_checksum</span>(pkt)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-comment">// ❌ 错误：异常不适用于高频路径</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">bad_validate</span><span class="hljs-params">(<span class="hljs-type">const</span> Packet&amp; pkt)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (pkt.size &gt; MAX_SIZE) <span class="hljs-keyword">throw</span> <span class="hljs-built_in">InvalidPacket</span>();<br>    <span class="hljs-keyword">if</span> (pkt.checksum != <span class="hljs-built_in">calculate_checksum</span>(pkt)) <span class="hljs-keyword">throw</span> <span class="hljs-built_in">InvalidPacket</span>();<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="5-替代异常的常用模式"><strong>5. 替代异常的常用模式</strong></h3>
<table>
<thead>
<tr>
<th>场景</th>
<th>替代方案</th>
<th>工具/技巧</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>可恢复错误</strong></td>
<td>返回错误码或<code>bool</code>状态</td>
<td><code>std::optional</code>, <code>std::expected</code></td>
</tr>
<tr>
<td><strong>可选值缺失</strong></td>
<td><code>std::optional&lt;T&gt;</code></td>
<td>C++17标准库</td>
</tr>
<tr>
<td><strong>多错误类型</strong></td>
<td><code>std::variant&lt;T, Error&gt;</code></td>
<td>C++17联合类型</td>
</tr>
<tr>
<td><strong>输入验证</strong></td>
<td>循环+条件重试</td>
<td><code>while</code> + <code>std::cin.fail()</code></td>
</tr>
<tr>
<td><strong>资源不可用</strong></td>
<td>RAII类+状态检查</td>
<td>自定义资源管理类</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="何时应使用异常？"><strong>何时应使用异常？</strong></h3>
<table>
<thead>
<tr>
<th>场景</th>
<th>示例</th>
<th>理由</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>内存耗尽</strong></td>
<td><code>new</code>失败</td>
<td>程序无法继续运行</td>
</tr>
<tr>
<td><strong>硬件故障</strong></td>
<td>磁盘写入失败</td>
<td>无法通过局部逻辑恢复</td>
</tr>
<tr>
<td><strong>第三方库崩溃</strong></td>
<td>数据库连接突然断开</td>
<td>跨层级错误传递</td>
</tr>
<tr>
<td><strong>不可恢复的逻辑错误</strong></td>
<td>程序不变量被破坏</td>
<td>需要立即终止或重启</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="代码可维护性对比"><strong>代码可维护性对比</strong></h3>
<h4 id="异常滥用代码"><strong>异常滥用代码</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">auto</span> data = <span class="hljs-built_in">parse_input</span>();<br>    <span class="hljs-built_in">save_to_db</span>(data);<br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> InvalidInput&amp;) &#123;<br>    <span class="hljs-built_in">log</span>(<span class="hljs-string">&quot;输入错误&quot;</span>);<br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> DatabaseTimeout&amp;) &#123;<br>    <span class="hljs-built_in">retry</span>();<br>&#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>    <span class="hljs-built_in">log</span>(<span class="hljs-string">&quot;未知错误&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="控制结构优化代码"><strong>控制结构优化代码</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> input = <span class="hljs-built_in">read_input</span>(); input.<span class="hljs-built_in">valid</span>()) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> conn = db.<span class="hljs-built_in">connect</span>(); conn.<span class="hljs-built_in">active</span>()) &#123;<br>        conn.<span class="hljs-built_in">save</span>(input.<span class="hljs-built_in">data</span>());<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">handle_db_error</span>(conn.<span class="hljs-built_in">status</span>());<br>    &#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">ask_for_retry</span>();<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="总结：选择错误处理策略的决策树"><strong>总结：选择错误处理策略的决策树</strong></h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs">错误是否可预期且频繁发生？<br>├── 是 → 使用控制结构（if/返回码）<br>└── 否 → 错误是否会导致程序无法继续？<br>    ├── 是 → 抛出异常<br>    └── 否 → 错误是否需要跨多层传递？<br>        ├── 是 → 使用异常<br>        └── 否 → 使用局部处理<br></code></pre></td></tr></table></figure>
<p>通过合理选择错误处理策略，可显著提升代码性能和可维护性。记住：<strong>异常应作为“最后防线”，而非常规控制流工具</strong>。</p>
<h1>14 用“资源获取即初始化”技术管理资源。</h1>
<p>在C++中，“资源获取即初始化”（<strong>RAII</strong>, Resource Acquisition Is Initialization）是管理资源的黄金准则。以下是分步骤的详细说明和代码示例：</p>
<hr>
<h3 id="1-RAII核心思想"><strong>1. RAII核心思想</strong></h3>
<p>将 <strong>资源生命周期</strong> 与 <strong>对象生命周期</strong> 绑定：</p>
<ul>
<li><strong>构造函数</strong>：获取资源</li>
<li><strong>析构函数</strong>：释放资源</li>
<li><strong>无论程序流程如何（包括异常）</strong>，资源都能自动释放</li>
</ul>
<hr>
<h3 id="2-基本实现模板"><strong>2. 基本实现模板</strong></h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RAIIWrapper</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-comment">// 构造函数获取资源</span><br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">RAIIWrapper</span><span class="hljs-params">(ResourceParams params)</span></span><br><span class="hljs-function">        : resource_(acquire_resource(params)) </span><br><span class="hljs-function">    &#123;</span><br>        <span class="hljs-keyword">if</span> (!resource_) <span class="hljs-keyword">throw</span> <span class="hljs-built_in">ResourceAcquisitionFailed</span>();<br>    &#125;<br><br>    <span class="hljs-comment">// 析构函数释放资源</span><br>    ~<span class="hljs-built_in">RAIIWrapper</span>() <span class="hljs-keyword">noexcept</span> &#123;<br>        <span class="hljs-keyword">if</span> (resource_) <span class="hljs-built_in">release_resource</span>(resource_);<br>    &#125;<br><br>    <span class="hljs-comment">// 禁用拷贝（根据需要实现移动语义）</span><br>    <span class="hljs-built_in">RAIIWrapper</span>(<span class="hljs-type">const</span> RAIIWrapper&amp;) = <span class="hljs-keyword">delete</span>;<br>    RAIIWrapper&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> RAIIWrapper&amp;) = <span class="hljs-keyword">delete</span>;<br><br>    <span class="hljs-comment">// 可选：提供资源访问接口</span><br>    <span class="hljs-function">ResourceHandle <span class="hljs-title">get</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>&#123; <span class="hljs-keyword">return</span> resource_; &#125;<br><br><span class="hljs-keyword">private</span>:<br>    ResourceHandle resource_; <span class="hljs-comment">// 资源句柄（指针、文件描述符等）</span><br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="3-典型应用场景"><strong>3. 典型应用场景</strong></h3>
<h4 id="3-1-管理动态内存"><strong>3.1 管理动态内存</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 使用标准库智能指针（无需自定义）</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process_data</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span> </span>&#123;<br>    <span class="hljs-keyword">auto</span> buffer = std::<span class="hljs-built_in">make_unique</span>&lt;<span class="hljs-type">int</span>[]&gt;(size); <span class="hljs-comment">// RAII自动管理</span><br>    <span class="hljs-comment">// 使用buffer...</span><br>    <span class="hljs-comment">// 无需手动delete，离开作用域自动释放</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="3-2-管理文件句柄"><strong>3.2 管理文件句柄</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FileRAII</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">FileRAII</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* mode = <span class="hljs-string">&quot;r&quot;</span>)</span></span><br><span class="hljs-function">        : file_(fopen(path.c_str(), mode)) </span><br><span class="hljs-function">    &#123;</span><br>        <span class="hljs-keyword">if</span> (!file_) <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;无法打开文件&quot;</span>);<br>    &#125;<br><br>    ~<span class="hljs-built_in">FileRAII</span>() <span class="hljs-keyword">noexcept</span> &#123; <br>        <span class="hljs-keyword">if</span> (file_) <span class="hljs-built_in">fclose</span>(file_); <br>    &#125;<br><br>    <span class="hljs-function">FILE* <span class="hljs-title">handle</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>&#123; <span class="hljs-keyword">return</span> file_; &#125;<br><br>    <span class="hljs-comment">// 启用移动语义</span><br>    <span class="hljs-built_in">FileRAII</span>(FileRAII&amp;&amp; other) <span class="hljs-keyword">noexcept</span> <br>        : <span class="hljs-built_in">file_</span>(std::<span class="hljs-built_in">exchange</span>(other.file_, <span class="hljs-literal">nullptr</span>)) &#123;&#125;<br>    <br>    FileRAII&amp; <span class="hljs-keyword">operator</span>=(FileRAII&amp;&amp; other) <span class="hljs-keyword">noexcept</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> != &amp;other) &#123;<br>            <span class="hljs-keyword">if</span> (file_) <span class="hljs-built_in">fclose</span>(file_);<br>            file_ = std::<span class="hljs-built_in">exchange</span>(other.file_, <span class="hljs-literal">nullptr</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    FILE* file_;<br>&#125;;<br><br><span class="hljs-comment">// 使用示例</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">read_file</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-function">FileRAII <span class="hljs-title">file</span><span class="hljs-params">(<span class="hljs-string">&quot;data.txt&quot;</span>)</span></span>;<br>    <span class="hljs-type">char</span> buffer[<span class="hljs-number">1024</span>];<br>    <span class="hljs-built_in">fread</span>(buffer, <span class="hljs-number">1</span>, <span class="hljs-built_in">sizeof</span>(buffer), file.<span class="hljs-built_in">handle</span>());<br>    <span class="hljs-comment">// 文件自动关闭</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="3-3-管理互斥锁"><strong>3.3 管理互斥锁</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">CriticalSection</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">safe_operation</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mutex_)</span></span>; <span class="hljs-comment">// RAII自动加锁</span><br>        <span class="hljs-comment">// 临界区操作...</span><br>        <span class="hljs-comment">// 离开作用域自动解锁</span><br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    std::mutex mutex_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="4-高级应用技巧"><strong>4. 高级应用技巧</strong></h3>
<h4 id="4-1-延迟初始化"><strong>4.1 延迟初始化</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LazyResource</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">initialize</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (!resource_) &#123;<br>            resource_ = <span class="hljs-built_in">acquire_resource</span>();<br>            <span class="hljs-keyword">if</span> (!resource_) <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">bad_alloc</span>();<br>        &#125;<br>    &#125;<br><br>    ~<span class="hljs-built_in">LazyResource</span>() &#123;<br>        <span class="hljs-keyword">if</span> (resource_) <span class="hljs-built_in">release_resource</span>(resource_);<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    ResourceHandle resource_ = <span class="hljs-literal">nullptr</span>;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="4-2-组合RAII对象"><strong>4.2 组合RAII对象</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseTransaction</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">DatabaseTransaction</span>(Database&amp; db)<br>        : <span class="hljs-built_in">conn_</span>(db.<span class="hljs-built_in">acquire_connection</span>()), <span class="hljs-comment">// RAII成员1：连接</span><br>          <span class="hljs-built_in">lock_</span>(conn_.<span class="hljs-built_in">mutex</span>())            <span class="hljs-comment">// RAII成员2：锁</span><br>    &#123;<br>        conn_.<span class="hljs-built_in">begin_transaction</span>();<br>    &#125;<br><br>    ~<span class="hljs-built_in">DatabaseTransaction</span>() &#123;<br>        <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">uncaught_exceptions</span>() &gt; <span class="hljs-number">0</span>) &#123;<br>            conn_.<span class="hljs-built_in">rollback</span>();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            conn_.<span class="hljs-built_in">commit</span>();<br>        &#125;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    DatabaseConnectionRAII conn_;<br>    std::lock_guard&lt;std::mutex&gt; lock_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="5-标准库RAII工具"><strong>5. 标准库RAII工具</strong></h3>
<table>
<thead>
<tr>
<th>资源类型</th>
<th>标准库工具</th>
<th>头文件</th>
</tr>
</thead>
<tbody>
<tr>
<td>动态内存</td>
<td><code>std::unique_ptr</code>, <code>std::shared_ptr</code></td>
<td><code>&lt;memory&gt;</code></td>
</tr>
<tr>
<td>文件流</td>
<td><code>std::fstream</code>, <code>std::ofstream</code></td>
<td><code>&lt;fstream&gt;</code></td>
</tr>
<tr>
<td>互斥锁</td>
<td><code>std::lock_guard</code>, <code>std::unique_lock</code></td>
<td><code>&lt;mutex&gt;</code></td>
</tr>
<tr>
<td>线程</td>
<td><code>std::jthread</code> (C++20)</td>
<td><code>&lt;thread&gt;</code></td>
</tr>
<tr>
<td>临时文件/目录</td>
<td><code>std::filesystem::directory_entry</code></td>
<td><code>&lt;filesystem&gt;</code></td>
</tr>
</tbody>
</table>
<hr>
<h3 id="6-异常安全保证"><strong>6. 异常安全保证</strong></h3>
<table>
<thead>
<tr>
<th>等级</th>
<th>描述</th>
<th>实现方法</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>基本保证</strong></td>
<td>资源不泄漏，对象状态有效</td>
<td>析构函数正确释放资源</td>
</tr>
<tr>
<td><strong>强保证</strong></td>
<td>操作要么完全成功，要么无影响</td>
<td>Copy-and-Swap + RAII</td>
</tr>
<tr>
<td><strong>无抛出保证</strong></td>
<td>操作不会抛出异常</td>
<td><code>noexcept</code> + 简单操作</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="7-验证RAII正确性"><strong>7. 验证RAII正确性</strong></h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 测试用例：验证资源释放</span><br><span class="hljs-built_in">TEST_CASE</span>(<span class="hljs-string">&quot;FileRAII自动关闭文件&quot;</span>) &#123;<br>    FILE* raw_handle = <span class="hljs-literal">nullptr</span>;<br>    &#123;<br>        <span class="hljs-function">FileRAII <span class="hljs-title">file</span><span class="hljs-params">(<span class="hljs-string">&quot;test.txt&quot;</span>, <span class="hljs-string">&quot;w&quot;</span>)</span></span>;<br>        raw_handle = file.<span class="hljs-built_in">handle</span>();<br>        <span class="hljs-built_in">REQUIRE</span>(<span class="hljs-built_in">fileno</span>(raw_handle) != <span class="hljs-number">-1</span>); <span class="hljs-comment">// 文件已打开</span><br>    &#125; <span class="hljs-comment">// RAII对象析构</span><br><br>    <span class="hljs-built_in">REQUIRE</span>(<span class="hljs-built_in">fclose</span>(raw_handle) == EOF); <span class="hljs-comment">// 文件已关闭，再次关闭失败</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="总结-3"><strong>总结</strong></h3>
<p>通过RAII技术：</p>
<ol>
<li><strong>消除手动资源管理</strong>：避免<code>new/delete</code>、<code>open/close</code>的配对问题</li>
<li><strong>保证异常安全</strong>：即使发生异常，资源也能正确释放</li>
<li><strong>提升代码可读性</strong>：资源生命周期清晰可见</li>
<li><strong>支持更复杂的资源策略</strong>：通过组合RAII对象实现事务操作</li>
</ol>
<p>建议将RAII作为C++资源管理的默认方式，仅在极少数需要手动控制的场景（如性能关键路径）才考虑其他方案。</p>
<h1>15 尽量减少使用try块。</h1>
<p>在C++中，<strong>资源获取即初始化（RAII）</strong> 是管理资源（如内存、文件句柄、网络连接等）的核心技术，通过将资源生命周期与对象生命周期绑定，确保资源自动释放。以下是具体实现策略和代码示例：</p>
<hr>
<h3 id="1-RAII-核心原则"><strong>1. RAII 核心原则</strong></h3>
<ul>
<li><strong>构造函数获取资源</strong>：资源在对象构造时初始化。</li>
<li><strong>析构函数释放资源</strong>：对象销毁时自动释放资源。</li>
<li><strong>异常安全</strong>：即使程序抛出异常，资源也能正确释放。</li>
</ul>
<hr>
<h3 id="2-基础模板：自定义RAII类"><strong>2. 基础模板：自定义RAII类</strong></h3>
<h4 id="2-1-管理文件句柄"><strong>2.1 管理文件句柄</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdio&gt;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">FileRAII</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-comment">// 构造函数打开文件</span><br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">FileRAII</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* mode = <span class="hljs-string">&quot;r&quot;</span>)</span> </span><br><span class="hljs-function">        : file_(fopen(path, mode)) &#123;</span><br>        <span class="hljs-keyword">if</span> (!file_) <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;无法打开文件&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 析构函数关闭文件</span><br>    ~<span class="hljs-built_in">FileRAII</span>() <span class="hljs-keyword">noexcept</span> &#123;<br>        <span class="hljs-keyword">if</span> (file_) <span class="hljs-built_in">fclose</span>(file_);<br>    &#125;<br><br>    <span class="hljs-comment">// 禁用拷贝，允许移动</span><br>    <span class="hljs-built_in">FileRAII</span>(<span class="hljs-type">const</span> FileRAII&amp;) = <span class="hljs-keyword">delete</span>;<br>    FileRAII&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> FileRAII&amp;) = <span class="hljs-keyword">delete</span>;<br>    <span class="hljs-built_in">FileRAII</span>(FileRAII&amp;&amp; other) <span class="hljs-keyword">noexcept</span> : <span class="hljs-built_in">file_</span>(other.file_) &#123;<br>        other.file_ = <span class="hljs-literal">nullptr</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 提供资源访问接口</span><br>    <span class="hljs-function">FILE* <span class="hljs-title">handle</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>&#123; <span class="hljs-keyword">return</span> file_; &#125;<br><br><span class="hljs-keyword">private</span>:<br>    FILE* file_;<br>&#125;;<br><br><span class="hljs-comment">// 使用示例</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">read_file</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-function">FileRAII <span class="hljs-title">file</span><span class="hljs-params">(<span class="hljs-string">&quot;data.txt&quot;</span>)</span></span>; <span class="hljs-comment">// 打开文件</span><br>    <span class="hljs-type">char</span> buffer[<span class="hljs-number">1024</span>];<br>    <span class="hljs-built_in">fread</span>(buffer, <span class="hljs-number">1</span>, <span class="hljs-built_in">sizeof</span>(buffer), file.<span class="hljs-built_in">handle</span>());<br>    <span class="hljs-comment">// 离开作用域时，file析构自动关闭文件</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="2-2-管理动态数组"><strong>2.2 管理动态数组</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicArrayRAII</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">DynamicArrayRAII</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span> </span><br><span class="hljs-function">        : data_(new T[size]), size_(size) &#123;</span>&#125;<br>    <br>    ~<span class="hljs-built_in">DynamicArrayRAII</span>() <span class="hljs-keyword">noexcept</span> &#123; <span class="hljs-keyword">delete</span>[] data_; &#125;<br><br>    T&amp; <span class="hljs-keyword">operator</span>[](<span class="hljs-type">size_t</span> index) &#123; <span class="hljs-keyword">return</span> data_[index]; &#125;<br><br><span class="hljs-keyword">private</span>:<br>    T* data_;<br>    <span class="hljs-type">size_t</span> size_;<br>&#125;;<br><br><span class="hljs-comment">// 使用示例</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process_data</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-function">DynamicArrayRAII&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">arr</span><span class="hljs-params">(<span class="hljs-number">1000</span>)</span></span>; <span class="hljs-comment">// 分配内存</span><br>    arr[<span class="hljs-number">0</span>] = <span class="hljs-number">42</span>;<br>    <span class="hljs-comment">// 离开作用域时内存自动释放</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="3-标准库RAII工具"><strong>3. 标准库RAII工具</strong></h3>
<h4 id="3-1-智能指针管理内存"><strong>3.1 智能指针管理内存</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">safe_memory_management</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">auto</span> ptr = std::<span class="hljs-built_in">make_unique</span>&lt;<span class="hljs-type">int</span>[]&gt;(<span class="hljs-number">1000</span>); <span class="hljs-comment">// unique_ptr自动释放</span><br>    <span class="hljs-keyword">auto</span> shared = std::<span class="hljs-built_in">make_shared</span>&lt;Resource&gt;(); <span class="hljs-comment">// shared_ptr引用计数</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="3-2-互斥锁管理（多线程安全）"><strong>3.2 互斥锁管理（多线程安全）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadSafeCounter</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mutex_)</span></span>; <span class="hljs-comment">// 自动加锁/解锁</span><br>        ++count_;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">int</span> count_ = <span class="hljs-number">0</span>;<br>    std::mutex mutex_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="4-高级应用场景"><strong>4. 高级应用场景</strong></h3>
<h4 id="4-1-管理数据库连接"><strong>4.1 管理数据库连接</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseSession</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">DatabaseSession</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; conn_str)</span> </span>&#123;<br>        session_ = <span class="hljs-built_in">connect</span>(conn_str); <span class="hljs-comment">// 可能抛异常</span><br>        <span class="hljs-keyword">if</span> (!session_.<span class="hljs-built_in">active</span>()) <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;连接失败&quot;</span>);<br>    &#125;<br><br>    ~<span class="hljs-built_in">DatabaseSession</span>() &#123; <br>        <span class="hljs-keyword">if</span> (session_.<span class="hljs-built_in">active</span>()) <span class="hljs-built_in">disconnect</span>(session_); <br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; sql)</span> </span>&#123; <span class="hljs-comment">/* ... */</span> &#125;<br><br><span class="hljs-keyword">private</span>:<br>    DatabaseHandle session_;<br>&#125;;<br><br><span class="hljs-comment">// 使用示例</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">run_query</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-function">DatabaseSession <span class="hljs-title">db</span><span class="hljs-params">(<span class="hljs-string">&quot;user=admin;password=1234&quot;</span>)</span></span>;<br>    db.<span class="hljs-built_in">query</span>(<span class="hljs-string">&quot;SELECT * FROM users&quot;</span>);<br>    <span class="hljs-comment">// 离开作用域时自动断开连接</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="4-2-组合RAII对象（事务操作）"><strong>4.2 组合RAII对象（事务操作）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Transaction</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Transaction</span>(Database&amp; db) <br>        : <span class="hljs-built_in">conn_</span>(db.<span class="hljs-built_in">acquire_connection</span>()), <span class="hljs-comment">// RAII成员1：连接</span><br>          <span class="hljs-built_in">lock_</span>(conn_.<span class="hljs-built_in">mutex</span>())            <span class="hljs-comment">// RAII成员2：锁</span><br>    &#123;<br>        conn_.<span class="hljs-built_in">begin</span>();<br>    &#125;<br><br>    ~<span class="hljs-built_in">Transaction</span>() &#123;<br>        <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">uncaught_exceptions</span>() &gt; <span class="hljs-number">0</span>) conn_.<span class="hljs-built_in">rollback</span>();<br>        <span class="hljs-keyword">else</span> conn_.<span class="hljs-built_in">commit</span>();<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    DatabaseConnectionRAII conn_;<br>    std::lock_guard&lt;std::mutex&gt; lock_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="5-RAII设计原则"><strong>5. RAII设计原则</strong></h3>
<table>
<thead>
<tr>
<th>原则</th>
<th>实现方式</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>资源获取即初始化</strong></td>
<td>构造函数中获取资源</td>
<td><code>FileRAII</code>构造函数打开文件</td>
</tr>
<tr>
<td><strong>资源释放即析构</strong></td>
<td>析构函数中释放资源（标记为<code>noexcept</code>）</td>
<td><code>~FileRAII()</code>关闭文件</td>
</tr>
<tr>
<td><strong>禁用拷贝，支持移动</strong></td>
<td>删除拷贝构造函数，实现移动语义</td>
<td><code>FileRAII(FileRAII&amp;&amp;)</code></td>
</tr>
<tr>
<td><strong>异常安全</strong></td>
<td>构造函数失败时抛出异常，析构函数确保释放资源</td>
<td>构造函数中<code>throw</code>，析构中<code>fclose</code></td>
</tr>
<tr>
<td><strong>提供访问接口</strong></td>
<td>通过成员函数暴露资源</td>
<td><code>handle()</code>返回文件指针</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="6-常见问题解决"><strong>6. 常见问题解决</strong></h3>
<h4 id="6-1-构造函数中部分资源初始化失败"><strong>6.1 构造函数中部分资源初始化失败</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiResource</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">MultiResource</span>() <br>        : <span class="hljs-built_in">res1_</span>(<span class="hljs-built_in">acquire_resource_1</span>()), <span class="hljs-comment">// 若此处失败，无资源需释放</span><br>          <span class="hljs-built_in">res2_</span>(<span class="hljs-built_in">acquire_resource_2</span>())  <span class="hljs-comment">// 若此处失败，res1_的析构函数自动释放</span><br>    &#123;&#125;<br><br><span class="hljs-keyword">private</span>:<br>    ResourceRAII res1_;<br>    ResourceRAII res2_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="6-2-延迟资源初始化"><strong>6.2 延迟资源初始化</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LazyResource</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">initialize</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (!resource_) &#123;<br>            resource_ = <span class="hljs-built_in">acquire_resource</span>(); <span class="hljs-comment">// 延迟获取资源</span><br>            <span class="hljs-keyword">if</span> (!resource_) <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">bad_alloc</span>();<br>        &#125;<br>    &#125;<br><br>    ~<span class="hljs-built_in">LazyResource</span>() &#123; <span class="hljs-keyword">if</span> (resource_) <span class="hljs-built_in">release_resource</span>(resource_); &#125;<br><br><span class="hljs-keyword">private</span>:<br>    ResourceHandle resource_ = <span class="hljs-literal">nullptr</span>;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="7-RAII与异常安全等级"><strong>7. RAII与异常安全等级</strong></h3>
<table>
<thead>
<tr>
<th>安全等级</th>
<th>描述</th>
<th>RAII实现方式</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>基本异常安全</strong></td>
<td>资源不泄漏，对象状态有效</td>
<td>析构函数正确释放资源</td>
</tr>
<tr>
<td><strong>强异常安全</strong></td>
<td>操作要么完全成功，要么无副作用</td>
<td>Copy-and-Swap + RAII成员</td>
</tr>
<tr>
<td><strong>无抛出保证</strong></td>
<td>操作绝不抛异常</td>
<td><code>noexcept</code> + 简单操作</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="总结-4"><strong>总结</strong></h3>
<p>通过RAII技术，可以：</p>
<ol>
<li><strong>消除手动资源管理</strong>：避免<code>new/delete</code>、<code>open/close</code>的配对错误。</li>
<li><strong>保证异常安全</strong>：即使发生异常，资源也能正确释放。</li>
<li><strong>提升代码可读性</strong>：资源生命周期与对象作用域一致。</li>
<li><strong>支持复杂资源策略</strong>：通过组合RAII对象实现事务、延迟初始化等高级功能。</li>
</ol>
<p><strong>推荐实践</strong>：</p>
<ul>
<li>优先使用标准库RAII工具（如智能指针、<code>lock_guard</code>）。</li>
<li>对第三方库资源（如OpenGL纹理、数据库连接）封装自定义RAII类。</li>
<li>在构造函数中完成所有资源初始化，避免部分初始化状态。</li>
</ul>
<h1>16 并非所有程序都需要异常安全。</h1>
<p>在C++开发中，确实存在不需要追求异常安全性的场景。以下是分层说明和具体实践指南：</p>
<hr>
<h3 id="一、不需要异常安全的典型场景"><strong>一、不需要异常安全的典型场景</strong></h3>
<h4 id="1-性能敏感型代码"><strong>1. 性能敏感型代码</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 高频交易系统的核心循环</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process_market_data</span><span class="hljs-params">(Packet&amp; pkt)</span> <span class="hljs-keyword">noexcept</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (pkt.size != VALID_SIZE) <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// 直接返回错误码</span><br>    <span class="hljs-built_in">calculate_indicators</span>(pkt.data);     <span class="hljs-comment">// 禁用异常开销</span><br>    <span class="hljs-built_in">send_to_engine</span>(pkt);                <span class="hljs-comment">// 要求绝对低延迟</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>特点</strong>：</p>
<ul>
<li>使用<code>noexcept</code>标记函数</li>
<li>错误处理通过返回值或状态位完成</li>
<li>牺牲错误信息丰富性换取纳秒级性能</li>
</ul>
<hr>
<h4 id="2-嵌入式实时系统"><strong>2. 嵌入式实时系统</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 电机控制固件</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">control_motor</span><span class="hljs-params">(RPM target)</span> </span>&#123;<br>    <span class="hljs-type">uint16_t</span> current = <span class="hljs-built_in">read_sensor</span>();  <span class="hljs-comment">// 无异常支持的硬件操作</span><br>    <span class="hljs-keyword">if</span> (current &gt; MAX_SAFE_VALUE) &#123;<br>        <span class="hljs-built_in">emergency_shutdown</span>();          <span class="hljs-comment">// 直接终止异常状态</span><br>        <span class="hljs-keyword">return</span> ERROR_CODE;<br>    &#125;<br>    <span class="hljs-built_in">adjust_pwm</span>(target);               <span class="hljs-comment">// 确定性时序要求</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>特点</strong>：</p>
<ul>
<li>编译器禁用异常（<code>-fno-exceptions</code>）</li>
<li>通过LED闪烁或看门狗复位处理严重错误</li>
<li>错误处理路径必须保证在微秒级完成</li>
</ul>
<hr>
<h4 id="3-简单命令行工具"><strong>3. 简单命令行工具</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 一次性数据处理工具</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">2</span>) &#123;<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Usage: %s &lt;file&gt;\n&quot;</span>, argv[<span class="hljs-number">0</span>]);<br>        <span class="hljs-keyword">return</span> EXIT_FAILURE;  <span class="hljs-comment">// 直接退出无需恢复状态</span><br>    &#125;<br>    <span class="hljs-built_in">process_file</span>(argv[<span class="hljs-number">1</span>]);    <span class="hljs-comment">// 单次执行无需回滚</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>特点</strong>：</p>
<ul>
<li>错误直接导致程序终止</li>
<li>无长期运行状态需要维护</li>
<li>资源管理依赖操作系统自动回收</li>
</ul>
<hr>
<h3 id="二、非异常安全代码编写规范"><strong>二、非异常安全代码编写规范</strong></h3>
<h4 id="1-资源管理策略"><strong>1. 资源管理策略</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// C风格手动管理（需严格配对）</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">legacy_image_processing</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-type">uint8_t</span>* buffer = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>);<br>    <span class="hljs-keyword">if</span> (!buffer) <span class="hljs-keyword">return</span>;<br><br>    FILE* fp = <span class="hljs-built_in">fopen</span>(<span class="hljs-string">&quot;data.raw&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br>    <span class="hljs-keyword">if</span> (!fp) &#123;<br>        <span class="hljs-built_in">free</span>(buffer);  <span class="hljs-comment">// 必须手动释放</span><br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-built_in">process</span>(buffer, fp);<br>    <span class="hljs-built_in">fclose</span>(fp);<br>    <span class="hljs-built_in">free</span>(buffer);<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>要点</strong>：</p>
<ul>
<li>每个<code>malloc</code>必须有对应的<code>free</code></li>
<li>每个<code>open</code>必须有对应的<code>close</code></li>
<li>错误路径需手工回滚资源分配</li>
</ul>
<hr>
<h4 id="2-错误码传递规范"><strong>2. 错误码传递规范</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Error</span> &#123; SUCCESS, FILE_ERROR, NETWORK_ERROR &#125;;<br><br><span class="hljs-function">Error <span class="hljs-title">download_file</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* url)</span> </span>&#123;<br>    CURL* curl = <span class="hljs-built_in">curl_easy_init</span>();<br>    <span class="hljs-keyword">if</span> (!curl) <span class="hljs-keyword">return</span> NETWORK_ERROR;<br><br>    FILE* fp = <span class="hljs-built_in">fopen</span>(<span class="hljs-string">&quot;temp.tmp&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>);<br>    <span class="hljs-keyword">if</span> (!fp) &#123;<br>        <span class="hljs-built_in">curl_easy_cleanup</span>(curl);  <span class="hljs-comment">// 手动清理</span><br>        <span class="hljs-keyword">return</span> FILE_ERROR;<br>    &#125;<br><br>    <span class="hljs-comment">//...传输操作...</span><br>    <br>    <span class="hljs-built_in">fclose</span>(fp);<br>    <span class="hljs-built_in">curl_easy_cleanup</span>(curl);<br>    <span class="hljs-keyword">return</span> SUCCESS;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>要点</strong>：</p>
<ul>
<li>定义清晰的错误码枚举</li>
<li>每个函数必须返回执行状态</li>
<li>调用方需检查所有返回值</li>
</ul>
<hr>
<h4 id="3-断言辅助调试"><strong>3. 断言辅助调试</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 快速失败策略用于开发阶段</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">unsafe_optimization</span><span class="hljs-params">(<span class="hljs-type">float</span>* data)</span> </span>&#123;<br>    <span class="hljs-built_in">assert</span>(data != <span class="hljs-literal">nullptr</span> &amp;&amp; <span class="hljs-string">&quot;空指针传递给算法核心&quot;</span>);  <span class="hljs-comment">// 调试期检查</span><br>    <span class="hljs-built_in">simd_processing</span>(data);  <span class="hljs-comment">// Release模式可能产生未定义行为</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>特点</strong>：</p>
<ul>
<li><code>NDEBUG</code>发布版自动移除检查</li>
<li>仅用于捕捉开发阶段明显错误</li>
<li>不处理运行时不可预测错误</li>
</ul>
<hr>
<h3 id="三、异常安全与RAII的替代方案"><strong>三、异常安全与RAII的替代方案</strong></h3>
<h4 id="1-作用域退出自动执行"><strong>1. 作用域退出自动执行</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;experimental/scope&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modern_without_exceptions</span><span class="hljs-params">()</span> </span>&#123;<br>    FILE* fp = <span class="hljs-built_in">fopen</span>(<span class="hljs-string">&quot;data.txt&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">auto</span> file_guard = std::experimental::<span class="hljs-built_in">make_scope_exit</span>([&amp;]&#123;<br>        <span class="hljs-keyword">if</span> (fp) <span class="hljs-built_in">fclose</span>(fp);<br>    &#125;);<br><br>    <span class="hljs-built_in">process_content</span>(fp);  <span class="hljs-comment">// 无论是否出错都会关闭文件</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>优势</strong>：</p>
<ul>
<li>类似RAII的局部资源管理</li>
<li>无需定义完整包装类</li>
<li>支持C风格资源管理</li>
</ul>
<hr>
<h4 id="2-状态标记对象"><strong>2. 状态标记对象</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkController</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">connect</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; ip)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (!hardware_ready_) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 状态检查</span><br>        <span class="hljs-comment">//...物理层操作...</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">disconnect</span><span class="hljs-params">()</span> <span class="hljs-keyword">noexcept</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (connected_) <span class="hljs-built_in">release_port</span>();<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">bool</span> hardware_ready_ = <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">bool</span> connected_ = <span class="hljs-literal">false</span>;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p><strong>优势</strong>：</p>
<ul>
<li>对象始终保持有效状态</li>
<li>方法返回操作是否成功</li>
<li>析构函数保证基础清理</li>
</ul>
<hr>
<h3 id="四、禁用异常的工程配置"><strong>四、禁用异常的工程配置</strong></h3>
<h4 id="1-编译器参数设置"><strong>1. 编译器参数设置</strong></h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># GCC/Clang禁用异常</span><br>g++ -fno-exceptions -stdlib=libc++ app.cpp<br><br><span class="hljs-comment"># MSVC禁用异常（需配合宏）</span><br>cl /EHsc- app.cpp<br></code></pre></td></tr></table></figure>
<h4 id="2-标准库行为调整"><strong>2. 标准库行为调整</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 重载operator new为不抛出版本</span><br><span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> ptr = <span class="hljs-built_in">malloc</span>(size)) <span class="hljs-keyword">return</span> ptr;<br>    std::<span class="hljs-built_in">abort</span>();  <span class="hljs-comment">// 内存耗尽直接终止</span><br>&#125;<br><br><span class="hljs-comment">// 使用无异常容器</span><br>std::vector&lt;<span class="hljs-type">int</span>, non_throw_allocator&lt;<span class="hljs-type">int</span>&gt;&gt; safe_vec;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="五、决策流程图"><strong>五、决策流程图</strong></h3>
<pre><code class=" mermaid">graph TD
    A&#123;需要跨多层处理错误?&#125; --&gt;|是| B[使用异常]
    A --&gt;|否| C&#123;代码运行在实时系统?&#125;
    C --&gt;|是| D[禁用异常,用错误码]
    C --&gt;|否| E&#123;性能要求&gt;200ns/op?&#125;
    E --&gt;|是| D
    E --&gt;|否| F[可选RAII+错误码]
</code></pre>
<hr>
<h3 id="总结-5"><strong>总结</strong></h3>
<p>当开发一次性工具、实时系统、性能关键型组件时，可放弃异常安全机制，通过：</p>
<ol>
<li>严格配对手工资源管理</li>
<li>清晰错误码传递体系</li>
<li>断言辅助调试</li>
<li>作用域守卫工具<br>
来构建可靠系统。但需在项目文档中明确标注非异常安全模块，限制其使用范围。</li>
</ol>
<h1>17 用“资源获取即初始化”技术和异常处理程序维护不变式。</h1>
<p>在C++中，通过 <strong>资源获取即初始化（RAII）</strong> 结合 <strong>异常处理</strong>，可以有效地维护类的不变式（Class Invariants），确保对象始终处于有效状态。以下是具体实现策略和代码示例：</p>
<hr>
<h3 id="1-核心原则"><strong>1. 核心原则</strong></h3>
<ul>
<li><strong>构造函数建立不变式</strong>：若无法满足不变式，立即抛出异常。</li>
<li><strong>析构函数释放资源</strong>：确保对象销毁时清理资源。</li>
<li><strong>成员变量RAII化</strong>：所有资源由RAII对象管理，避免手动清理。</li>
</ul>
<hr>
<h3 id="2-基础示例：文件管理类"><strong>2. 基础示例：文件管理类</strong></h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdexcept&gt;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeFile</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-comment">// 构造函数：尝试打开文件，失败则抛出异常</span><br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">SafeFile</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span> </span><br><span class="hljs-function">        : file_(path, std::ios::binary) </span><br><span class="hljs-function">    &#123;</span><br>        <span class="hljs-keyword">if</span> (!file_.<span class="hljs-built_in">is_open</span>()) &#123;<br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;无法打开文件: &quot;</span> + path);<br>        &#125;<br>        <span class="hljs-built_in">validate_header</span>(); <span class="hljs-comment">// 可能抛出自定义异常</span><br>    &#125;<br><br>    <span class="hljs-comment">// 析构函数：自动关闭文件（无需手动操作）</span><br>    ~<span class="hljs-built_in">SafeFile</span>() <span class="hljs-keyword">noexcept</span> = <span class="hljs-keyword">default</span>;<br><br>    <span class="hljs-comment">// 成员函数：确保操作后仍满足不变式</span><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; data)</span> </span>&#123;<br>        std::string temp = <span class="hljs-built_in">encrypt</span>(data); <span class="hljs-comment">// 可能抛异常</span><br>        file_ &lt;&lt; temp;<br>        <span class="hljs-keyword">if</span> (file_.<span class="hljs-built_in">fail</span>()) &#123;<br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;写入失败&quot;</span>);<br>        &#125;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    std::ofstream file_;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">validate_header</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-type">char</span> header[<span class="hljs-number">4</span>];<br>        file_.<span class="hljs-built_in">read</span>(header, <span class="hljs-built_in">sizeof</span>(header));<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">is_valid</span>(header)) &#123;<br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">&quot;无效文件头&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="3-复合对象：数据库事务"><strong>3. 复合对象：数据库事务</strong></h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseTransaction</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-comment">// 构造函数：按顺序初始化RAII成员</span><br>    <span class="hljs-built_in">DatabaseTransaction</span>(<span class="hljs-type">const</span> std::string&amp; conn_str)<br>        : <span class="hljs-built_in">logger_</span>(<span class="hljs-string">&quot;transaction.log&quot;</span>),   <span class="hljs-comment">// RAII成员1：日志文件</span><br>          <span class="hljs-built_in">conn_</span>(<span class="hljs-built_in">connect</span>(conn_str)),     <span class="hljs-comment">// RAII成员2：数据库连接</span><br>          <span class="hljs-built_in">lock_</span>(conn_.<span class="hljs-built_in">mutex</span>())          <span class="hljs-comment">// RAII成员3：互斥锁</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (!conn_.<span class="hljs-built_in">is_active</span>()) &#123;<br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;数据库连接失败&quot;</span>);<br>        &#125;<br>        conn_.<span class="hljs-built_in">begin</span>(); <span class="hljs-comment">// 开启事务</span><br>    &#125;<br><br>    <span class="hljs-comment">// 析构函数：根据事务成功与否提交或回滚</span><br>    ~<span class="hljs-built_in">DatabaseTransaction</span>() <span class="hljs-keyword">noexcept</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">uncaught_exceptions</span>() &gt; <span class="hljs-number">0</span> || !committed_) &#123;<br>                conn_.<span class="hljs-built_in">rollback</span>();<br>            &#125;<br>        &#125; <span class="hljs-built_in">catch</span> (...) &#123;&#125; <span class="hljs-comment">// 确保析构函数不抛出</span><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">commit</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-built_in">validate_operations</span>(); <span class="hljs-comment">// 可能抛异常</span><br>        conn_.<span class="hljs-built_in">commit</span>();<br>        committed_ = <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">execute</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; sql)</span> </span>&#123;<br>        conn_.<span class="hljs-built_in">execute</span>(sql); <span class="hljs-comment">// 可能抛异常</span><br>        operations_.<span class="hljs-built_in">push_back</span>(sql);<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    FileRAII logger_;           <span class="hljs-comment">// 日志文件RAII管理</span><br>    DatabaseConnection conn_;  <span class="hljs-comment">// 数据库连接RAII对象</span><br>    std::unique_lock&lt;std::mutex&gt; lock_; <span class="hljs-comment">// 锁RAII管理</span><br>    std::vector&lt;std::string&gt; operations_;<br>    <span class="hljs-type">bool</span> committed_ = <span class="hljs-literal">false</span>;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="4-强异常安全保证：Copy-and-Swap"><strong>4. 强异常安全保证：Copy-and-Swap</strong></h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigManager</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-comment">// 修改配置（强异常安全保证）</span><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; key, <span class="hljs-type">const</span> std::string&amp; value)</span> </span>&#123;<br>        <span class="hljs-keyword">auto</span> temp = data_;          <span class="hljs-comment">// 1. 创建副本</span><br>        temp[key] = value;          <span class="hljs-comment">// 2. 修改副本（可能抛异常）</span><br>        data_.<span class="hljs-built_in">swap</span>(temp);           <span class="hljs-comment">// 3. 无异常则原子交换</span><br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    std::map&lt;std::string, std::string&gt; data_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="5-维护不变式的关键点"><strong>5. 维护不变式的关键点</strong></h3>
<h4 id="5-1-构造函数中的异常处理"><strong>5.1 构造函数中的异常处理</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TemperatureSensor</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">TemperatureSensor</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> </span><br><span class="hljs-function">        : handle_(init_sensor(id)) // RAII成员初始化</span><br><span class="hljs-function">    &#123;</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">get_current_temp</span>() &lt; ABSOLUTE_ZERO) &#123; <span class="hljs-comment">// 违反不变式</span><br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">logic_error</span>(<span class="hljs-string">&quot;传感器数据异常&quot;</span>);<br>        &#125;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    SensorHandleRAII handle_; <span class="hljs-comment">// 传感器资源由RAII管理</span><br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="5-2-成员函数的异常安全"><strong>5.2 成员函数的异常安全</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Account</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">transfer</span><span class="hljs-params">(Account&amp; to, <span class="hljs-type">double</span> amount)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (amount &lt;= <span class="hljs-number">0</span> || balance_ &lt; amount) &#123;<br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">&quot;无效金额&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">auto</span> temp_from = balance_ - amount; <span class="hljs-comment">// 不直接修改成员</span><br>        <span class="hljs-keyword">auto</span> temp_to = to.balance_ + amount;<br>        <br>        balance_ = temp_from;  <span class="hljs-comment">// 无异常则提交修改</span><br>        to.balance_ = temp_to;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">double</span> balance_ = <span class="hljs-number">0.0</span>;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="6-异常处理与资源释放"><strong>6. 异常处理与资源释放</strong></h3>
<h4 id="6-1-多层调用中的资源传递"><strong>6.1 多层调用中的资源传递</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process_data</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-function">SafeFile <span class="hljs-title">input</span><span class="hljs-params">(<span class="hljs-string">&quot;input.dat&quot;</span>)</span></span>; <span class="hljs-comment">// RAII对象1</span><br>    <span class="hljs-function">SafeFile <span class="hljs-title">output</span><span class="hljs-params">(<span class="hljs-string">&quot;output.dat&quot;</span>)</span></span>; <span class="hljs-comment">// RAII对象2</span><br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">auto</span> data = <span class="hljs-built_in">parse</span>(input); <span class="hljs-comment">// 可能抛异常</span><br>        <span class="hljs-built_in">transform</span>(data);<br>        output.<span class="hljs-built_in">write</span>(data);<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> ParseError&amp; e) &#123;<br>        <span class="hljs-built_in">log_error</span>(<span class="hljs-string">&quot;解析失败: &quot;</span>, e.<span class="hljs-built_in">what</span>());<br>        <span class="hljs-keyword">throw</span>; <span class="hljs-comment">// 重新抛出，input/output自动关闭</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="7-设计原则总结"><strong>7. 设计原则总结</strong></h3>
<table>
<thead>
<tr>
<th>原则</th>
<th>实现方法</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>构造函数建立不变式</strong></td>
<td>若初始化失败，立即抛出异常</td>
<td><code>throw std::runtime_error(...)</code></td>
</tr>
<tr>
<td><strong>析构函数释放资源</strong></td>
<td>所有资源由RAII成员管理，析构函数标记为<code>noexcept</code></td>
<td><code>~FileRAII() noexcept</code></td>
</tr>
<tr>
<td><strong>成员函数强异常安全</strong></td>
<td>使用Copy-and-Swap或事务模式</td>
<td><code>temp.swap(data_)</code></td>
</tr>
<tr>
<td><strong>资源获取顺序</strong></td>
<td>按声明顺序初始化RAII成员</td>
<td><code>logger_</code>先于<code>conn_</code>初始化</td>
</tr>
<tr>
<td><strong>异常传播</strong></td>
<td>仅在能处理的层级捕获异常</td>
<td>UI层捕获并显示错误</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="错误处理决策树"><strong>错误处理决策树</strong></h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs">是否违反类不变式？<br>├── 是 → 抛出异常阻止对象创建<br>└── 否 → 操作是否可能失败？<br>    ├── 是 → 使用RAII + 异常传递<br>    └── 否 → 直接执行操作<br></code></pre></td></tr></table></figure>
<hr>
<p>通过结合RAII和异常处理，可以确保：</p>
<ol>
<li><strong>资源安全</strong>：无论是否发生异常，资源都会被正确释放。</li>
<li><strong>状态一致性</strong>：对象始终保持有效状态。</li>
<li><strong>代码简洁性</strong>：消除冗余的错误检查代码。</li>
</ol>
<p><strong>关键准则</strong>：每个类的设计都应明确其不变式，并通过RAII和异常处理在构造函数、成员函数中强制维护这些不变式。</p>
<h1>18 资源句柄优于弱结构化的finally。</h1>
<p>在C++中，使用 <strong>资源句柄（RAII）</strong> 相比类似<code>finally</code>的弱结构化清理机制具有显著优势，尤其在资源管理、代码安全性和可维护性方面。以下是关键对比和具体示例：</p>
<hr>
<h3 id="1-作用域控制的天然优势"><strong>1. 作用域控制的天然优势</strong></h3>
<h4 id="资源句柄（RAII）示例"><strong>资源句柄（RAII）示例</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process_file</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-function">std::ifstream <span class="hljs-title">file</span><span class="hljs-params">(<span class="hljs-string">&quot;data.txt&quot;</span>)</span></span>; <span class="hljs-comment">// 资源句柄：文件打开即初始化</span><br>    <span class="hljs-built_in">parse</span>(file);                   <span class="hljs-comment">// 使用资源</span><br>&#125; <span class="hljs-comment">// 此处自动调用~ifstream()关闭文件</span><br></code></pre></td></tr></table></figure>
<h4 id="类finally结构示例（伪代码）"><strong>类finally结构示例（伪代码）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">unsafe_process</span><span class="hljs-params">()</span> </span>&#123;<br>    FILE* fp = <span class="hljs-built_in">fopen</span>(<span class="hljs-string">&quot;data.txt&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">parse</span>(fp);<br>    &#125; finally &#123; <span class="hljs-comment">// 虚构语法</span><br>        <span class="hljs-built_in">fclose</span>(fp); <span class="hljs-comment">// 需要显式清理</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>核心差异</strong>：</p>
<ul>
<li>RAII资源生命周期与代码块作用域 <strong>严格绑定</strong></li>
<li>finally需要 <strong>手动指定</strong> 清理代码位置，易遗漏或误用</li>
</ul>
<hr>
<h3 id="2-多资源管理复杂度对比"><strong>2. 多资源管理复杂度对比</strong></h3>
<h4 id="RAII自动处理资源依赖"><strong>RAII自动处理资源依赖</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">secure_operation</span><span class="hljs-params">()</span> </span>&#123;<br>    std::mutex mtx;<br>    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mtx)</span></span>;  <span class="hljs-comment">// 资源1：互斥锁</span><br>    <span class="hljs-function">std::ofstream <span class="hljs-title">log</span><span class="hljs-params">(<span class="hljs-string">&quot;audit.log&quot;</span>)</span></span>;         <span class="hljs-comment">// 资源2：日志文件</span><br>    <span class="hljs-built_in">db_operation</span>();                        <span class="hljs-comment">// 可能抛异常</span><br>&#125; <span class="hljs-comment">// 自动先释放log，再释放lock（逆初始化顺序）</span><br></code></pre></td></tr></table></figure>
<h4 id="finally结构的繁琐管理"><strong>finally结构的繁琐管理</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">error_prone_operation</span><span class="hljs-params">()</span> </span>&#123;<br>    Mutex mtx;<br>    FileHandle log;<br>    <span class="hljs-keyword">try</span> &#123;<br>        mtx.<span class="hljs-built_in">lock</span>();<br>        log = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;audit.log&quot;</span>);<br>        <span class="hljs-built_in">db_operation</span>();<br>    &#125; finally &#123;<br>        log.<span class="hljs-built_in">close</span>(); <span class="hljs-comment">// 需注意释放顺序</span><br>        mtx.<span class="hljs-built_in">unlock</span>(); <span class="hljs-comment">// 与加锁顺序相反</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>问题暴露</strong>：</p>
<ul>
<li>finally块中需 <strong>手动维护资源释放顺序</strong>（与获取顺序相反）</li>
<li>新增资源时需修改多处代码，易出错</li>
</ul>
<hr>
<h3 id="3-异常安全性的根本差异"><strong>3. 异常安全性的根本差异</strong></h3>
<h4 id="RAII在异常时的行为"><strong>RAII在异常时的行为</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">raii_example</span><span class="hljs-params">()</span> </span>&#123;<br>    ResourceA a;          <span class="hljs-comment">// 构造成功</span><br>    ResourceB b;          <span class="hljs-comment">// 构造失败，抛出异常</span><br>&#125; <span class="hljs-comment">// a的析构函数自动调用，资源释放</span><br></code></pre></td></tr></table></figure>
<h4 id="finally在异常时的陷阱"><strong>finally在异常时的陷阱</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">finally_example</span><span class="hljs-params">()</span> </span>&#123;<br>    ResourceA* a = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ResourceA</span>();<br>    <span class="hljs-keyword">try</span> &#123;<br>        ResourceB* b = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ResourceB</span>(); <span class="hljs-comment">// 抛异常</span><br>    &#125; finally &#123;<br>        <span class="hljs-keyword">delete</span> a; <span class="hljs-comment">// 执行，但b未被释放（未进入try块）</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>关键缺陷</strong>：</p>
<ul>
<li>finally无法处理 <strong>构造函数内抛出的异常</strong>（如<code>ResourceB</code>构造失败）</li>
<li>RAII在 <strong>任何控制流退出路径</strong>（包括异常）都能触发析构</li>
</ul>
<hr>
<h3 id="4-代码可维护性对比"><strong>4. 代码可维护性对比</strong></h3>
<h4 id="RAII的自我文档化"><strong>RAII的自我文档化</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EncryptedConnection</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">EncryptedConnection</span>(<span class="hljs-type">const</span> Endpoint&amp; ep)<br>        : <span class="hljs-built_in">socket_</span>(ep.address),  <span class="hljs-comment">// 先建立socket</span><br>          <span class="hljs-built_in">cipher_</span>(<span class="hljs-built_in">generate_key</span>()) <span class="hljs-comment">// 再初始化加密</span><br>    &#123;&#125; <span class="hljs-comment">// 明确资源初始化顺序</span><br><br><span class="hljs-keyword">private</span>:<br>    TcpSocket socket_;   <span class="hljs-comment">// 资源1：网络连接</span><br>    CipherContext cipher_; <span class="hljs-comment">// 资源2：加密上下文</span><br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="finally的隐式依赖"><strong>finally的隐式依赖</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">connect</span><span class="hljs-params">()</span> </span>&#123;<br>    Socket s = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Socket</span>();<br>    <span class="hljs-keyword">try</span> &#123;<br>        Cipher c = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Cipher</span>();<br>        <span class="hljs-keyword">try</span> &#123;<br>            s.<span class="hljs-built_in">connect</span>(endpoint);<br>            c.<span class="hljs-built_in">init</span>(s.<span class="hljs-built_in">getKey</span>());<br>        &#125; finally &#123;<br>            c.<span class="hljs-built_in">release</span>(); <span class="hljs-comment">// 需了解c依赖s</span><br>        &#125;<br>    &#125; finally &#123;<br>        s.<span class="hljs-built_in">close</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>维护成本</strong>：</p>
<ul>
<li>finally要求开发者 <strong>显式记忆资源依赖关系</strong></li>
<li>修改资源初始化顺序需重构多个finally块</li>
</ul>
<hr>
<h3 id="5-性能与编译器优化"><strong>5. 性能与编译器优化</strong></h3>
<h4 id="RAII的零开销抽象"><strong>RAII的零开销抽象</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 编译后代码（伪汇编）：</span><br>process_file:<br>    call std::ifstream constructor<br>    call parse<br>    call std::ifstream destructor<br>    ret<br></code></pre></td></tr></table></figure>
<h4 id="finally的运行时成本"><strong>finally的运行时成本</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 伪代码：finally实现需要额外状态跟踪</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">function</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-built_in">register_cleanup</span>(cleanup_code); <span class="hljs-comment">// 运行时注册清理函数</span><br>    <span class="hljs-comment">// ...主逻辑...</span><br>    <span class="hljs-built_in">execute_cleanup</span>(); <span class="hljs-comment">// 退出时执行</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>性能差异</strong>：</p>
<ul>
<li>RAII依赖编译时生成的析构函数调用，<strong>无运行时开销</strong></li>
<li>finally通常需要 <strong>运行时栈记录清理操作</strong>，影响性能</li>
</ul>
<hr>
<h3 id="6-复杂控制流中的可靠性"><strong>6. 复杂控制流中的可靠性</strong></h3>
<h4 id="RAII处理提前返回"><strong>RAII处理提前返回</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">early_return_example</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-function">AuditLog <span class="hljs-title">log</span><span class="hljs-params">(<span class="hljs-string">&quot;ops.log&quot;</span>)</span></span>; <span class="hljs-comment">// 构造即管理</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">check_permission</span>()) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 自动清理log</span><br>    <span class="hljs-built_in">critical_operation</span>();<br>&#125; <span class="hljs-comment">// log在此处析构</span><br></code></pre></td></tr></table></figure>
<h4 id="finally需覆盖所有出口"><strong>finally需覆盖所有出口</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">finally_risky</span><span class="hljs-params">()</span> </span>&#123;<br>    File f = <span class="hljs-built_in">openFile</span>();<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">checkPerm</span>()) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 直接返回，跳过finally</span><br>        <span class="hljs-comment">// ...操作...</span><br>    &#125; finally &#123;<br>        f.<span class="hljs-built_in">close</span>(); <span class="hljs-comment">// 仅在try块退出时执行</span><br>    &#125;<br>    <span class="hljs-comment">// 此处f未关闭！</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong>：</p>
<ul>
<li>finally仅处理 <strong>try块退出</strong>，无法捕获函数中其他返回路径</li>
<li>RAII覆盖 <strong>所有可能的控制流路径</strong></li>
</ul>
<hr>
<h3 id="总结：资源句柄的核心优势"><strong>总结：资源句柄的核心优势</strong></h3>
<table>
<thead>
<tr>
<th>特性</th>
<th>RAII资源句柄</th>
<th>finally结构</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>作用域管理</strong></td>
<td>自动绑定生命周期</td>
<td>需手动指定清理位置</td>
</tr>
<tr>
<td><strong>多资源顺序</strong></td>
<td>依赖声明顺序，自动逆序析构</td>
<td>需手动维护释放顺序</td>
</tr>
<tr>
<td><strong>异常安全性</strong></td>
<td>构造函数失败仍能清理已初始化的资源</td>
<td>无法处理try块外的构造函数异常</td>
</tr>
<tr>
<td><strong>代码简洁性</strong></td>
<td>资源获取即管理，无需显式清理</td>
<td>每个资源需配套try-finally块</td>
</tr>
<tr>
<td><strong>性能</strong></td>
<td>零运行时开销</td>
<td>需额外状态跟踪</td>
</tr>
<tr>
<td><strong>维护成本</strong></td>
<td>低（新增资源不影响现有代码）</td>
<td>高（需修改多个finally块）</td>
</tr>
</tbody>
</table>
<p><strong>结论</strong>：在C++中，RAII资源句柄通过</p>
<ol>
<li><strong>作用域绑定</strong></li>
<li><strong>自动析构顺序</strong></li>
<li><strong>异常安全保证</strong></li>
<li><strong>零开销抽象</strong><br>
成为资源管理的首选方案，远优于需要手动维护的<code>finally</code>模式。对于从其他语言转向C++的开发者，理解并应用RAII是编写工业级健壮代码的关键。</li>
</ol>
<h1>19 为你的不变式设计错误处理策略。</h1>
<p>在C++中，为类的不变式（Class Invariants）设计错误处理策略需要结合 <strong>异常处理</strong> 和 <strong>RAII技术</strong>，确保对象始终处于有效状态。以下是分层的错误处理方案和具体实现示例：</p>
<hr>
<h3 id="一、不变式验证的核心策略">一、不变式验证的核心策略</h3>
<h4 id="1-构造函数强制校验">1. <strong>构造函数强制校验</strong></h4>
<p><strong>原则</strong>：构造函数必须完成所有不变式的校验，失败时抛出异常，阻止创建无效对象。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TemperatureSensor</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">TemperatureSensor</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> </span><br><span class="hljs-function">        : handle_(init_sensor(id))  // RAII管理硬件资源</span><br><span class="hljs-function">    &#123;</span><br>        <span class="hljs-comment">// 校验传感器初始读数是否符合不变式</span><br>        <span class="hljs-type">float</span> initial = <span class="hljs-built_in">read_temperature</span>();<br>        <span class="hljs-keyword">if</span> (initial &lt; <span class="hljs-number">-273.15f</span>) &#123;<br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">logic_error</span>(<span class="hljs-string">&quot;传感器读数违反物理定律&quot;</span>);<br>        &#125;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    SensorHandle handle_;  <span class="hljs-comment">// RAII成员，自动释放资源</span><br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="2-成员函数的强异常安全">2. <strong>成员函数的强异常安全</strong></h4>
<p><strong>原则</strong>：修改对象状态的操作必须保证 <strong>强异常安全</strong>（要么成功，要么不影响原状态）。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BankAccount</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">transfer</span><span class="hljs-params">(BankAccount&amp; to, <span class="hljs-type">double</span> amount)</span> </span>&#123;<br>        <span class="hljs-comment">// 1. 校验不变式：金额必须非负且足够</span><br>        <span class="hljs-keyword">if</span> (amount &lt;= <span class="hljs-number">0</span> || balance_ &lt; amount) &#123;<br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">&quot;无效转账金额&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 2. 操作副本，避免直接修改成员变量</span><br>        <span class="hljs-type">double</span> new_from = balance_ - amount;<br>        <span class="hljs-type">double</span> new_to = to.balance_ + amount;<br><br>        <span class="hljs-comment">// 3. 无异常则提交修改（原子操作）</span><br>        balance_ = new_from;<br>        to.balance_ = new_to;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">double</span> balance_ = <span class="hljs-number">0.0</span>;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="二、错误处理分层设计">二、错误处理分层设计</h3>
<h4 id="1-底层（资源层）">1. <strong>底层（资源层）</strong></h4>
<ul>
<li><strong>目标</strong>：确保资源正确获取和释放。</li>
<li><strong>策略</strong>：使用RAII类封装资源，构造函数失败时抛出异常。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConnection</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">DatabaseConnection</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; conn_str)</span></span><br><span class="hljs-function">        : conn_handle_(connect(conn_str))  // 可能抛异常</span><br><span class="hljs-function">    &#123;</span><br>        <span class="hljs-keyword">if</span> (!conn_handle_.<span class="hljs-built_in">active</span>()) &#123;<br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;数据库连接失败&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 析构函数自动断开连接（noexcept）</span><br>    ~<span class="hljs-built_in">DatabaseConnection</span>() <span class="hljs-keyword">noexcept</span> &#123;<br>        <span class="hljs-keyword">if</span> (conn_handle_.<span class="hljs-built_in">active</span>()) <span class="hljs-built_in">disconnect</span>(conn_handle_);<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    ConnHandle conn_handle_;  <span class="hljs-comment">// RAII资源句柄</span><br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="2-中间层（业务逻辑）">2. <strong>中间层（业务逻辑）</strong></h4>
<ul>
<li><strong>目标</strong>：转换技术异常为业务语义异常，添加上下文信息。</li>
<li><strong>策略</strong>：捕获底层异常，包装后重新抛出。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderProcessor</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process_order</span><span class="hljs-params">(<span class="hljs-type">const</span> Order&amp; order)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-function">DatabaseConnection <span class="hljs-title">db</span><span class="hljs-params">(<span class="hljs-string">&quot;user=admin;password=1234&quot;</span>)</span></span>;<br>            db.<span class="hljs-built_in">execute</span>(order.<span class="hljs-built_in">to_sql</span>());<br>        &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> DatabaseException&amp; e) &#123;<br>            <span class="hljs-comment">// 添加业务上下文后重新抛出</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-built_in">OrderException</span>(<span class="hljs-string">&quot;订单处理失败: &quot;</span> + order.<span class="hljs-built_in">id</span>(), e);<br>        &#125;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="3-顶层（UI-API层）">3. <strong>顶层（UI/API层）</strong></h4>
<ul>
<li><strong>目标</strong>：最终处理异常，展示友好信息或记录日志。</li>
<li><strong>策略</strong>：集中捕获所有未处理异常，确保程序优雅降级。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        OrderProcessor processor;<br>        processor.<span class="hljs-built_in">run</span>();<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> OrderException&amp; e) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;业务错误: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;<br>        <span class="hljs-built_in">log_error</span>(e);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;系统错误: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;<br>        <span class="hljs-built_in">log_critical</span>(e);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="三、进阶错误处理技术">三、进阶错误处理技术</h3>
<h4 id="1-自定义异常类">1. <strong>自定义异常类</strong></h4>
<p><strong>用途</strong>：携带更多错误上下文（错误码、时间戳、业务ID等）。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkException</span> : <span class="hljs-keyword">public</span> std::runtime_error &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">NetworkException</span>(<span class="hljs-type">const</span> std::string&amp; msg, <span class="hljs-type">int</span> error_code, std::string url)<br>        : std::<span class="hljs-built_in">runtime_error</span>(msg), <br>          <span class="hljs-built_in">error_code_</span>(error_code),<br>          <span class="hljs-built_in">url_</span>(std::<span class="hljs-built_in">move</span>(url)),<br>          <span class="hljs-built_in">timestamp_</span>(std::chrono::system_clock::<span class="hljs-built_in">now</span>()) &#123;&#125;<br><br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">code</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>&#123; <span class="hljs-keyword">return</span> error_code_; &#125;<br>    <span class="hljs-function"><span class="hljs-type">const</span> std::string&amp; <span class="hljs-title">url</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> url_; &#125;<br>    <span class="hljs-function">std::<span class="hljs-type">time_t</span> <span class="hljs-title">time</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <br>        <span class="hljs-keyword">return</span> std::chrono::system_clock::<span class="hljs-built_in">to_time_t</span>(timestamp_);<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">int</span> error_code_;<br>    std::string url_;<br>    std::chrono::system_clock::time_point timestamp_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="2-不变式恢复机制">2. <strong>不变式恢复机制</strong></h4>
<p><strong>场景</strong>：在关键系统中尝试自动恢复（如重新连接硬件）。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RoboticArmController</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">move_to</span><span class="hljs-params">(Position target)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">internal_move</span>(target);<br>        &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> HardwareException&amp; e) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">attempt_recovery</span>()) &#123;  <span class="hljs-comment">// 尝试恢复不变式</span><br>                <span class="hljs-built_in">internal_move</span>(target); <span class="hljs-comment">// 重试操作</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">throw</span>;  <span class="hljs-comment">// 恢复失败，传递异常</span><br>            &#125;<br>        &#125;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">attempt_recovery</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-built_in">reset_driver</span>();  <span class="hljs-comment">// 尝试重置硬件驱动</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">calibrate</span>();  <span class="hljs-comment">// 返回是否恢复成功</span><br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="四、错误处理决策树">四、错误处理决策树</h3>
<pre><code class=" mermaid">graph TD
    A[检测到不变式违反] --&gt; B&#123;是否在构造函数中?&#125;
    B --&gt;|是| C[抛出异常,阻止对象创建]
    B --&gt;|否| D&#123;是否可恢复?&#125;
    D --&gt;|是| E[尝试恢复并重试]
    D --&gt;|否| F[记录日志并抛出异常]
    F --&gt; G[顶层捕获并优雅终止]
</code></pre>
<hr>
<h3 id="五、最佳实践总结">五、最佳实践总结</h3>
<table>
<thead>
<tr>
<th>原则</th>
<th>实现方式</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>构造函数严格校验</strong></td>
<td>失败时抛出异常，阻止无效对象生成</td>
<td><code>throw std::invalid_argument</code></td>
</tr>
<tr>
<td><strong>成员函数强安全</strong></td>
<td>先操作副本，再原子提交修改</td>
<td><code>temp.swap(data_)</code></td>
</tr>
<tr>
<td><strong>异常信息丰富化</strong></td>
<td>自定义异常类携带错误上下文</td>
<td><code>NetworkException</code></td>
</tr>
<tr>
<td><strong>资源自动释放</strong></td>
<td>RAII成员管理资源，析构函数标记为<code>noexcept</code></td>
<td><code>~DatabaseConnection() noexcept</code></td>
</tr>
<tr>
<td><strong>分层处理</strong></td>
<td>技术异常在底层抛出，业务层转换语义</td>
<td><code>catch (DBException&amp;)</code> 转 <code>OrderException</code></td>
</tr>
</tbody>
</table>
<p>通过遵循这些策略，可以构建出 <strong>高鲁棒性</strong> 的C++系统，确保不变式被破坏时程序行为可预测且安全。</p>
<h1>20 能在编译时检查的东西最好在编译时检查(使用static_assert)。</h1>
<p>在C++中，利用 <code>static_assert</code> 在编译时进行条件检查，可以提前捕获潜在错误，提升代码健壮性并消除运行时开销。以下是关键应用场景和代码示例：</p>
<hr>
<h3 id="一、基础类型约束">一、基础类型约束</h3>
<h4 id="1-验证类型大小">1. <strong>验证类型大小</strong></h4>
<p>确保类型满足特定内存布局要求：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 必须为4字节类型（如int32_t）</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">PacketHeader</span> &#123;<br>    <span class="hljs-type">uint32_t</span> type;<br>    <span class="hljs-type">uint32_t</span> length;<br>    <span class="hljs-built_in">static_assert</span>(<span class="hljs-built_in">sizeof</span>(PacketHeader) == <span class="hljs-number">8</span>, <span class="hljs-string">&quot;PacketHeader大小必须为8字节&quot;</span>);<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="2-检查平台兼容性">2. <strong>检查平台兼容性</strong></h4>
<p>确保类型在不同平台上的表现一致：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 验证指针大小为8字节（64位系统）</span><br><span class="hljs-built_in">static_assert</span>(<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">void</span>*) == <span class="hljs-number">8</span>, <span class="hljs-string">&quot;仅支持64位架构&quot;</span>);<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="二、模板元编程约束">二、模板元编程约束</h3>
<h4 id="1-限制模板参数类型">1. <strong>限制模板参数类型</strong></h4>
<p>确保模板参数为整数类型：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">IntegerWrapper</span> &#123;<br>    <span class="hljs-built_in">static_assert</span>(std::is_integral_v&lt;T&gt;, <span class="hljs-string">&quot;T必须是整数类型&quot;</span>);<br><span class="hljs-keyword">public</span>:<br>    T value;<br>&#125;;<br><span class="hljs-comment">// 合法使用</span><br>IntegerWrapper&lt;<span class="hljs-type">int</span>&gt; iw_ok&#123;<span class="hljs-number">42</span>&#125;;<br><span class="hljs-comment">// 编译错误：类型不匹配</span><br>IntegerWrapper&lt;<span class="hljs-type">float</span>&gt; iw_err&#123;<span class="hljs-number">3.14f</span>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="2-验证模板参数关系">2. <strong>验证模板参数关系</strong></h4>
<p>确保模板参数之间有正确的继承关系：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> Base, <span class="hljs-keyword">typename</span> Derived&gt;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">safe_cast</span><span class="hljs-params">(Derived&amp; d)</span> </span>&#123;<br>    <span class="hljs-built_in">static_assert</span>(std::is_base_of_v&lt;Base, Derived&gt;, <br>        <span class="hljs-string">&quot;Derived必须继承自Base&quot;</span>);<br>    <span class="hljs-comment">// 安全转换逻辑...</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="三、常量表达式验证">三、常量表达式验证</h3>
<h4 id="1-数组大小合法性">1. <strong>数组大小合法性</strong></h4>
<p>编译时验证数组维度：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> MatrixSize = <span class="hljs-number">16</span>;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Matrix</span> &#123;<br>    <span class="hljs-type">float</span> data[MatrixSize][MatrixSize];<br>    <span class="hljs-built_in">static_assert</span>(MatrixSize &gt; <span class="hljs-number">0</span> &amp;&amp; (MatrixSize &amp; (MatrixSize - <span class="hljs-number">1</span>)) == <span class="hljs-number">0</span>, <br>        <span class="hljs-string">&quot;矩阵大小必须是2的幂&quot;</span>);<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="2-枚举值范围检查">2. <strong>枚举值范围检查</strong></h4>
<p>确保枚举值在有效范围内：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">enum class</span> <span class="hljs-title class_">Color</span> : <span class="hljs-type">uint8_t</span> &#123; Red = <span class="hljs-number">1</span>, Green = <span class="hljs-number">2</span>, Blue = <span class="hljs-number">3</span> &#125;;<br><span class="hljs-keyword">template</span> &lt;Color C&gt;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ColorInfo</span> &#123;<br>    <span class="hljs-built_in">static_assert</span>(C &gt;= Color::Red &amp;&amp; C &lt;= Color::Blue, <br>        <span class="hljs-string">&quot;无效的颜色值&quot;</span>);<br>    <span class="hljs-comment">// 颜色处理逻辑...</span><br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="四、自定义类型特征检查">四、自定义类型特征检查</h3>
<h4 id="1-验证特定接口存在">1. <strong>验证特定接口存在</strong></h4>
<p>使用SFINAE或C++20概念约束：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 检查类型是否有serialize方法</span><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">has_serialize</span> &#123;<br>    <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> U&gt;<br>    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">auto</span> <span class="hljs-title">test</span><span class="hljs-params">(U*)</span> -&gt; <span class="hljs-title">decltype</span><span class="hljs-params">(std::declval&lt;U&gt;().serialize(), std::true_type&#123;&#125;)</span></span>;<br>    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">auto</span> <span class="hljs-title">test</span><span class="hljs-params">(...)</span> -&gt; std::false_type</span>;<br>    <span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">bool</span> value = <span class="hljs-keyword">decltype</span>(<span class="hljs-built_in">test</span>((T*)<span class="hljs-literal">nullptr</span>))::value;<br>&#125;;<br><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">save</span><span class="hljs-params">(<span class="hljs-type">const</span> T&amp; obj)</span> </span>&#123;<br>    <span class="hljs-built_in">static_assert</span>(has_serialize&lt;T&gt;::value, <span class="hljs-string">&quot;T必须实现serialize方法&quot;</span>);<br>    obj.<span class="hljs-built_in">serialize</span>();<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="2-确保移动语义正确性">2. <strong>确保移动语义正确性</strong></h4>
<p>验证类型是否为可移动构造：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">OptimizedContainer</span> &#123;<br>    <span class="hljs-built_in">static_assert</span>(std::is_move_constructible_v&lt;T&gt;, <br>        <span class="hljs-string">&quot;T必须支持移动构造&quot;</span>);<br>    <span class="hljs-comment">// 使用移动语义优化存储...</span><br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="五、配置参数校验">五、配置参数校验</h3>
<h4 id="1-编译时配置文件验证">1. <strong>编译时配置文件验证</strong></h4>
<p>确保配置参数合法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> MaxConnections = <span class="hljs-number">100</span>;<br><span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> CurrentConnections = <span class="hljs-number">150</span>;<br><br><span class="hljs-comment">// 检查连接数是否超限</span><br><span class="hljs-built_in">static_assert</span>(CurrentConnections &lt;= MaxConnections, <br>    <span class="hljs-string">&quot;当前连接数超过最大限制&quot;</span>);<br></code></pre></td></tr></table></figure>
<h4 id="2-算法参数约束">2. <strong>算法参数约束</strong></h4>
<p>验证算法参数的数学有效性：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span> &lt;<span class="hljs-type">int</span> N&gt;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Factorial</span> &#123;<br>    <span class="hljs-built_in">static_assert</span>(N &gt;= <span class="hljs-number">0</span>, <span class="hljs-string">&quot;阶乘参数必须非负&quot;</span>);<br>    <span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> value = N * Factorial&lt;N<span class="hljs-number">-1</span>&gt;::value;<br>&#125;;<br><span class="hljs-keyword">template</span> &lt;&gt;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Factorial</span>&lt;<span class="hljs-number">0</span>&gt; &#123; <span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> value = <span class="hljs-number">1</span>; &#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="六、错误处理策略对比">六、错误处理策略对比</h3>
<table>
<thead>
<tr>
<th>检查类型</th>
<th>编译时检查 (<code>static_assert</code>)</th>
<th>运行时检查 (<code>assert</code>或异常)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>触发时机</strong></td>
<td>编译阶段</td>
<td>程序运行时</td>
</tr>
<tr>
<td><strong>性能影响</strong></td>
<td>无额外开销</td>
<td>可能引入分支判断和异常处理开销</td>
</tr>
<tr>
<td><strong>错误定位</strong></td>
<td>直接定位源码位置</td>
<td>需调试或日志分析</td>
</tr>
<tr>
<td><strong>适用场景</strong></td>
<td>类型特征、常量表达式、模板参数等确定性问题</td>
<td>用户输入、文件状态等动态不确定性问题</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="七、最佳实践总结">七、最佳实践总结</h3>
<ol>
<li><strong>优先编译时检查</strong>：对类型、常量表达式等确定性问题使用<code>static_assert</code></li>
<li><strong>结合类型特征库</strong>：利用<code>&lt;type_traits&gt;</code>中的工具简化约束条件</li>
<li><strong>明确错误信息</strong>：提供清晰的静态断言消息，方便开发者定位问题</li>
<li><strong>避免滥用</strong>：动态条件（如用户输入）仍需运行时检查</li>
</ol>
<p>通过将尽可能多的检查移至编译时，可以显著提升代码质量和运行效率，减少调试成本。</p>
<h1>21 用你的错误处理策略执行不同层级的检查。</h1>
<p>在C++中，通过分层错误处理策略可以在不同层级执行针对性检查，确保系统的健壮性和可维护性。以下为分层的错误处理方案及代码示例：</p>
<hr>
<h3 id="一、分层错误处理策略">一、分层错误处理策略</h3>
<table>
<thead>
<tr>
<th>层级</th>
<th>检查目标</th>
<th>技术手段</th>
<th>错误处理方式</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>编译时</strong></td>
<td>类型安全、静态约束</td>
<td><code>static_assert</code>、概念约束</td>
<td>编译失败，阻止生成可执行文件</td>
</tr>
<tr>
<td><strong>数据访问层</strong></td>
<td>资源有效性、技术异常（如数据库连接）</td>
<td>RAII + 自定义异常类</td>
<td>抛出技术异常</td>
</tr>
<tr>
<td><strong>业务逻辑层</strong></td>
<td>业务规则有效性（如订单状态）</td>
<td>防御性编程 + 业务异常</td>
<td>捕获技术异常，抛出业务异常</td>
</tr>
<tr>
<td><strong>UI/API层</strong></td>
<td>输入合法性、展示友好错误</td>
<td>参数校验 + 全局异常处理器</td>
<td>转换异常为HTTP状态码/弹窗</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="二、编译时检查（静态约束）">二、编译时检查（静态约束）</h3>
<h4 id="1-验证模板参数合法性">1. 验证模板参数合法性</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Vector3D</span> &#123;<br>    <span class="hljs-built_in">static_assert</span>(std::is_arithmetic_v&lt;T&gt;, <br>        <span class="hljs-string">&quot;Vector3D元素类型必须是算术类型&quot;</span>);<br><span class="hljs-keyword">public</span>:<br>    T x, y, z;<br>&#125;;<br><br><span class="hljs-comment">// 合法使用</span><br>Vector3D&lt;<span class="hljs-type">float</span>&gt; v1;<br><span class="hljs-comment">// 编译错误：static_assert失败</span><br>Vector3D&lt;std::string&gt; v2; <br></code></pre></td></tr></table></figure>
<h4 id="2-确保平台特性">2. 确保平台特性</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 验证是否为小端序架构</span><br><span class="hljs-built_in">static_assert</span>(std::endian::native == std::endian::little,<br>    <span class="hljs-string">&quot;本系统仅支持小端序架构&quot;</span>);<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="三、数据访问层（RAII-技术异常）">三、数据访问层（RAII + 技术异常）</h3>
<h4 id="1-数据库连接管理">1. 数据库连接管理</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConnection</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">DatabaseConnection</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; conn_str)</span> </span><br><span class="hljs-function">        : handle_(connect(conn_str)) // RAII初始化</span><br><span class="hljs-function">    &#123;</span><br>        <span class="hljs-keyword">if</span> (!handle_.<span class="hljs-built_in">active</span>()) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-built_in">DatabaseException</span>(<span class="hljs-string">&quot;连接失败&quot;</span>, conn_str, errno);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">execute</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; sql)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> code = handle_.<span class="hljs-built_in">query</span>(sql); code != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-built_in">QueryException</span>(<span class="hljs-string">&quot;查询失败&quot;</span>, sql, code);<br>        &#125;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    DBHandleRAII handle_; <span class="hljs-comment">// RAII管理连接生命周期</span><br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="2-文件操作异常">2. 文件操作异常</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">parse_config</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span> </span>&#123;<br>    <span class="hljs-function">SafeFile <span class="hljs-title">file</span><span class="hljs-params">(path)</span></span>; <span class="hljs-comment">// RAII自动开/关文件</span><br>    <span class="hljs-keyword">if</span> (!file.<span class="hljs-built_in">validate_signature</span>()) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">FileFormatException</span>(<span class="hljs-string">&quot;无效文件签名&quot;</span>, path);<br>    &#125;<br>    <span class="hljs-comment">// 解析操作...</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="四、业务逻辑层（业务异常转换）">四、业务逻辑层（业务异常转换）</h3>
<h4 id="1-订单处理">1. 订单处理</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderProcessor</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process</span><span class="hljs-params">(<span class="hljs-type">const</span> Order&amp; order)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">check_inventory</span>(order); <span class="hljs-comment">// 可能抛DatabaseException</span><br>            <span class="hljs-built_in">deduct_stock</span>(order);<br>            <span class="hljs-built_in">create_shipping</span>(order);<br>        &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> DatabaseException&amp; e) &#123;<br>            <span class="hljs-comment">// 添加业务上下文后重新抛出</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-built_in">OrderProcessingException</span>(<span class="hljs-string">&quot;订单处理失败&quot;</span>, order.<span class="hljs-built_in">id</span>(), e);<br>        &#125;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">check_inventory</span><span class="hljs-params">(<span class="hljs-type">const</span> Order&amp; order)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (order.<span class="hljs-built_in">quantity</span>() &lt;= <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-built_in">InvalidOrderException</span>(<span class="hljs-string">&quot;订单数量无效&quot;</span>, order.<span class="hljs-built_in">id</span>());<br>        &#125;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="2-支付网关调用">2. 支付网关调用</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentService</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">Receipt <span class="hljs-title">charge</span><span class="hljs-params">(CreditCard card, <span class="hljs-type">double</span> amount)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (amount &lt;= <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-built_in">InvalidAmountException</span>(<span class="hljs-string">&quot;金额必须为正数&quot;</span>, amount);<br>        &#125;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> gateway_.<span class="hljs-built_in">charge</span>(card, amount); <span class="hljs-comment">// 可能抛NetworkException</span><br>        &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> NetworkException&amp; e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-built_in">PaymentFailedException</span>(<span class="hljs-string">&quot;支付网关错误&quot;</span>, e.<span class="hljs-built_in">details</span>());<br>        &#125;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="五、UI-API层（全局异常处理）">五、UI/API层（全局异常处理）</h3>
<h4 id="1-REST-API错误处理">1. REST API错误处理</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 全局异常处理器（基于Crow框架示例）</span><br><span class="hljs-built_in">CROW_ROUTE</span>(app, <span class="hljs-string">&quot;/api/order&quot;</span>)([](<span class="hljs-type">const</span> crow::request&amp; req)&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        Order order = <span class="hljs-built_in">parse_order</span>(req.body);<br>        <span class="hljs-built_in">OrderProcessor</span>().<span class="hljs-built_in">process</span>(order);<br>        <span class="hljs-keyword">return</span> crow::<span class="hljs-built_in">response</span>(<span class="hljs-number">200</span>);<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> OrderProcessingException&amp; e) &#123;<br>        <span class="hljs-comment">// 业务异常：返回4xx状态码</span><br>        <span class="hljs-keyword">return</span> crow::<span class="hljs-built_in">response</span>(<span class="hljs-number">400</span>, json&#123;&#123;<span class="hljs-string">&quot;error&quot;</span>, e.<span class="hljs-built_in">what</span>()&#125;&#125;);<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) &#123;<br>        <span class="hljs-comment">// 系统异常：记录日志，返回5xx</span><br>        <span class="hljs-built_in">log_critical</span>(e.<span class="hljs-built_in">what</span>());<br>        <span class="hljs-keyword">return</span> crow::<span class="hljs-built_in">response</span>(<span class="hljs-number">500</span>);<br>    &#125;<br>&#125;);<br></code></pre></td></tr></table></figure>
<h4 id="2-GUI应用错误提示">2. GUI应用错误提示</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">MainWindow::onSubmitOrder</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        Order order = <span class="hljs-built_in">ui_gather_input</span>();<br>        order_processor_.<span class="hljs-built_in">submit</span>(order);<br>        <span class="hljs-built_in">show_success</span>(<span class="hljs-string">&quot;订单提交成功&quot;</span>);<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> InvalidInputException&amp; e) &#123;<br>        <span class="hljs-built_in">show_error</span>(<span class="hljs-string">&quot;输入错误&quot;</span>, e.<span class="hljs-built_in">field_hint</span>());<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> PaymentFailedException&amp; e) &#123;<br>        <span class="hljs-built_in">show_retry_dialog</span>(e.<span class="hljs-built_in">retry_advice</span>());<br>    &#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>        <span class="hljs-built_in">show_fatal_error</span>(<span class="hljs-string">&quot;系统发生未知错误&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="六、错误处理工具链">六、错误处理工具链</h3>
<table>
<thead>
<tr>
<th>工具/技术</th>
<th>适用层级</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>static_assert</code></td>
<td>编译时</td>
<td>强制类型/平台约束</td>
</tr>
<tr>
<td>自定义异常体系</td>
<td>所有运行时层</td>
<td>传递丰富错误上下文</td>
</tr>
<tr>
<td>RAII包装类</td>
<td>数据访问层</td>
<td>自动资源清理</td>
</tr>
<tr>
<td>全局异常捕获</td>
<td>UI/API层</td>
<td>防止崩溃，统一错误格式化</td>
</tr>
<tr>
<td>日志系统</td>
<td>所有层</td>
<td>错误追踪和审计</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="七、分层策略优势">七、分层策略优势</h3>
<ol>
<li><strong>关注点分离</strong>：每层仅处理职责内的错误类型</li>
<li><strong>错误信息丰富化</strong>：异常在传递过程中携带更多上下文</li>
<li><strong>资源安全</strong>：RAII确保任何层级抛出异常都不会泄漏资源</li>
<li><strong>用户体验优化</strong>：顶层将技术细节转换为友好提示</li>
<li><strong>维护性提升</strong>：编译时检查减少运行时错误可能性</li>
</ol>
<p>通过这种分层策略，可以构建出既健壮又易于维护的C++系统，各层级错误处理职责明确，且能有效协作。</p>
<h1>22 如果函数不会抛出异常，把它声明成noexcept的。</h1>
<p>在C++中，如果一个函数确实不会抛出任何异常，将其声明为<code>noexcept</code>具有多重优势，但也需谨慎评估其适用性。以下是分步骤的总结和建议：</p>
<h3 id="1-确定函数是否真正不会抛出异常"><strong>1. 确定函数是否真正不会抛出异常</strong></h3>
<ul>
<li><strong>检查所有内部操作</strong>：确认函数内部调用的所有函数、操作符和构造函数均不会抛出异常。
<ul>
<li>基础类型操作（如算术运算）通常不会抛出异常。</li>
<li>动态内存分配（<code>new</code>）、标准库容器操作（如<code>std::vector::push_back</code>）可能抛出<code>std::bad_alloc</code>等异常。</li>
<li>文件、网络等I/O操作可能因外部因素失败并抛出异常。</li>
</ul>
</li>
<li><strong>处理潜在异常</strong>：若函数内部可能抛出异常，但已通过<code>try-catch</code>块完全捕获并处理，确保无异常传播到函数外。</li>
</ul>
<h3 id="2-声明函数为noexcept"><strong>2. 声明函数为<code>noexcept</code></strong></h3>
<ul>
<li><strong>语法示例</strong>：<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">safe_function</span><span class="hljs-params">()</span> <span class="hljs-keyword">noexcept</span> </span>&#123;<br>    <span class="hljs-comment">// 确保此处代码不会抛出异常</span><br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><strong>移动构造函数/赋值运算符</strong>：<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">MyClass</span>(MyClass&amp;&amp; other) <span class="hljs-keyword">noexcept</span> &#123;<br>        <span class="hljs-comment">// 移动资源，保证不抛出异常</span><br>    &#125;<br>    <br>    MyClass&amp; <span class="hljs-keyword">operator</span>=(MyClass&amp;&amp; other) <span class="hljs-keyword">noexcept</span> &#123;<br>        <span class="hljs-comment">// 移动赋值，保证不抛出异常</span><br>        <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<ul>
<li>标准库（如<code>std::vector</code>）会优先使用<code>noexcept</code>移动操作提升性能。</li>
</ul>
</li>
</ul>
<h3 id="3-性能与优化"><strong>3. 性能与优化</strong></h3>
<ul>
<li><strong>编译器优化</strong>：<code>noexcept</code>允许编译器省略异常处理机制（如栈展开表），生成更高效的代码。</li>
<li><strong>标准库优化</strong>：
<ul>
<li>容器操作（如<code>std::vector</code>扩容）在元素类型支持<code>noexcept</code>移动时，优先使用移动而非复制。</li>
<li>算法（如<code>std::sort</code>）可能因<code>noexcept</code>获得性能提升。</li>
</ul>
</li>
</ul>
<h3 id="4-接口设计与文档"><strong>4. 接口设计与文档</strong></h3>
<ul>
<li><strong>明确契约</strong>：<code>noexcept</code>是函数接口的一部分，告知调用者无需准备异常处理。</li>
<li><strong>维护约束</strong>：一旦声明<code>noexcept</code>，后续修改必须维持其不抛出异常的承诺，否则导致未定义行为。</li>
</ul>
<h3 id="5-特殊情况处理"><strong>5. 特殊情况处理</strong></h3>
<ul>
<li><strong>虚函数</strong>：若基类虚函数声明为<code>noexcept</code>，所有派生类重写版本也必须保持<code>noexcept</code>，否则编译错误。<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">()</span> <span class="hljs-keyword">noexcept</span> </span>= <span class="hljs-number">0</span>;<br>&#125;;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Derived</span> : <span class="hljs-keyword">public</span> Base &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">()</span> <span class="hljs-keyword">noexcept</span> <span class="hljs-keyword">override</span> </span>&#123; <span class="hljs-comment">/* ... */</span> &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
</li>
<li><strong>条件性<code>noexcept</code></strong>：在模板中，根据类型特性动态决定是否<code>noexcept</code>。<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">swap</span><span class="hljs-params">(T&amp; a, T&amp; b)</span> <span class="hljs-title">noexcept</span><span class="hljs-params">(<span class="hljs-keyword">noexcept</span>(T(std::move(a))) &amp;&amp; <span class="hljs-keyword">noexcept</span>(a = std::move(b)))</span> </span>&#123;<br>    <span class="hljs-comment">// 根据T的移动操作是否noexcept决定自身异常规范</span><br>&#125;<br></code></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="6-风险与注意事项"><strong>6. 风险与注意事项</strong></h3>
<ul>
<li><strong>错误使用后果</strong>：若函数实际可能抛出异常却被声明为<code>noexcept</code>，异常触发时直接调用<code>std::terminate()</code>终止程序。</li>
<li><strong>维护成本</strong>：修改函数实现时，需重新验证<code>noexcept</code>的适用性，避免破坏契约。</li>
</ul>
<h3 id="7-推荐实践"><strong>7. 推荐实践</strong></h3>
<ul>
<li><strong>简单函数</strong>：如纯算术运算、获取器（getters）等明显无异常的函数，应声明<code>noexcept</code>。</li>
<li><strong>移动操作</strong>：移动构造函数和赋值运算符应尽量实现为<code>noexcept</code>。</li>
<li><strong>避免滥用</strong>：对于可能抛出异常或涉及外部资源的函数，谨慎评估后再决定。</li>
<li><strong>静态分析工具</strong>：使用Clang-Tidy等工具检查<code>noexcept</code>的误用。</li>
</ul>
<h3 id="示例对比"><strong>示例对比</strong></h3>
<p><strong>未使用<code>noexcept</code>：</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process_data</span><span class="hljs-params">()</span> </span>&#123;<br>    std::vector&lt;<span class="hljs-type">int</span>&gt; data;<br>    data.<span class="hljs-built_in">reserve</span>(<span class="hljs-number">1000</span>); <span class="hljs-comment">// 可能抛出std::bad_alloc</span><br>    <span class="hljs-comment">// ...其他操作...</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>使用<code>noexcept</code>（错误示例，可能导致崩溃）：</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process_data</span><span class="hljs-params">()</span> <span class="hljs-keyword">noexcept</span> </span>&#123;<br>    std::vector&lt;<span class="hljs-type">int</span>&gt; data;<br>    data.<span class="hljs-built_in">reserve</span>(<span class="hljs-number">1000</span>); <span class="hljs-comment">// 若抛出异常，程序直接终止</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>正确做法（处理异常或避免<code>noexcept</code>）：</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process_data</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        std::vector&lt;<span class="hljs-type">int</span>&gt; data;<br>        data.<span class="hljs-built_in">reserve</span>(<span class="hljs-number">1000</span>);<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::bad_alloc&amp; e) &#123;<br>        <span class="hljs-comment">// 处理内存不足，如降级方案</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="总结-6"><strong>总结</strong></h3>
<ul>
<li><strong>优先声明</strong>：对明确无异常的函数（如简单计算、移动操作）使用<code>noexcept</code>，提升性能和代码质量。</li>
<li><strong>谨慎评估</strong>：涉及资源操作的函数需确保异常被完全处理，避免误用<code>noexcept</code>导致程序不稳定。</li>
<li><strong>团队规范</strong>：统一项目的<code>noexcept</code>使用标准，结合代码审查和静态分析确保正确性。</li>
</ul>
<h1>23 不要使用异常说明。</h1>
<p>在C++中，动态异常规范（例如 <code>void func() throw(int);</code>）已在C++11中被标记为<strong>废弃</strong>，并在C++17中<strong>完全移除</strong>。以下是避免使用异常说明的详细原因及现代替代方案：</p>
<hr>
<h3 id="一、为什么不使用异常说明？">一、为什么不使用异常说明？</h3>
<h4 id="1-运行时检查而非编译时">1. <strong>运行时检查而非编译时</strong></h4>
<ul>
<li><strong>问题</strong>：动态异常规范在运行时验证，若函数抛出未声明的异常类型，会触发 <code>std::unexpected()</code>，导致程序终止。</li>
<li><strong>示例</strong>：<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">()</span> <span class="hljs-title">throw</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span> </span>&#123; <br>    <span class="hljs-keyword">throw</span> <span class="hljs-string">&quot;error&quot;</span>; <span class="hljs-comment">// 抛出const char*，但未在声明中列出</span><br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>编译通过，但运行时会崩溃。</li>
</ul>
</li>
</ul>
<h4 id="2-性能开销">2. <strong>性能开销</strong></h4>
<ul>
<li><strong>问题</strong>：编译器需生成额外代码来检查异常类型，即使未抛出任何异常。</li>
<li><strong>对比</strong>：<code>noexcept</code>无运行时开销，仅影响编译优化。</li>
</ul>
<h4 id="3-维护成本高">3. <strong>维护成本高</strong></h4>
<ul>
<li><strong>问题</strong>：修改函数可能抛出的异常类型时，需手动更新所有相关声明，易出错。</li>
<li><strong>示例</strong>：<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 旧声明</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process</span><span class="hljs-params">()</span> <span class="hljs-title">throw</span><span class="hljs-params">(FileError)</span></span>;<br><br><span class="hljs-comment">// 修改后需抛出NetworkError</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process</span><span class="hljs-params">()</span> <span class="hljs-title">throw</span><span class="hljs-params">(FileError, NetworkError)</span></span>; <span class="hljs-comment">// 需手动更新</span><br></code></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="4-无法与模板协同">4. <strong>无法与模板协同</strong></h4>
<ul>
<li><strong>问题</strong>：模板函数无法为所有可能的类型指定动态异常规范。</li>
<li><strong>示例</strong>：<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">swap</span><span class="hljs-params">(T&amp; a, T&amp; b)</span> <span class="hljs-title">throw</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">// 不现实，因T的拷贝可能抛出异常</span><br></code></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="二、替代方案：现代C-异常处理策略">二、替代方案：现代C++异常处理策略</h3>
<h4 id="1-使用-noexcept-明确不抛异常">1. <strong>使用 <code>noexcept</code> 明确不抛异常</strong></h4>
<ul>
<li><strong>用途</strong>：声明函数不会抛出任何异常。</li>
<li><strong>优势</strong>：
<ul>
<li>编译时标记，无运行时开销。</li>
<li>允许编译器优化（如移动语义优化）。</li>
</ul>
</li>
<li><strong>示例</strong>：<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">safe_operation</span><span class="hljs-params">()</span> <span class="hljs-keyword">noexcept</span> </span>&#123;<br>    <span class="hljs-comment">// 确保此处代码不会抛出异常</span><br>&#125;<br></code></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="2-强异常安全保证">2. <strong>强异常安全保证</strong></h4>
<ul>
<li><strong>原则</strong>：通过RAII和<code>noexcept</code>移动操作实现强异常安全。</li>
<li><strong>示例</strong>：<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DataContainer</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">DataContainer</span>(DataContainer&amp;&amp; other) <span class="hljs-keyword">noexcept</span> <br>        : <span class="hljs-built_in">data_</span>(std::<span class="hljs-built_in">move</span>(other.data_)) &#123;&#125;<br>    <br>    <span class="hljs-comment">// 强保证：要么完全成功，要么无副作用</span><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">auto</span> temp = data_;  <span class="hljs-comment">// 先操作副本</span><br>        temp.<span class="hljs-built_in">modify</span>();<br>        data_.<span class="hljs-built_in">swap</span>(temp);   <span class="hljs-comment">// 无异常则提交</span><br>    &#125;<br><span class="hljs-keyword">private</span>:<br>    std::vector&lt;<span class="hljs-type">int</span>&gt; data_;<br>&#125;;<br></code></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="3-基于契约的编程">3. <strong>基于契约的编程</strong></h4>
<ul>
<li><strong>工具</strong>：使用<code>assert</code>或<code>static_assert</code>在关键位置验证前置/后置条件。</li>
<li><strong>示例</strong>：<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process</span><span class="hljs-params">(<span class="hljs-type">int</span>* ptr)</span> </span>&#123;<br>    <span class="hljs-built_in">assert</span>(ptr != <span class="hljs-literal">nullptr</span> &amp;&amp; <span class="hljs-string">&quot;指针不能为空&quot;</span>);<br>    <span class="hljs-comment">// 安全操作ptr</span><br>&#125;<br></code></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="4-错误码-结构化返回">4. <strong>错误码 + 结构化返回</strong></h4>
<ul>
<li><strong>场景</strong>：性能敏感或禁用异常的环境（如嵌入式系统）。</li>
<li><strong>示例</strong>：<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">enum class</span> <span class="hljs-title class_">Error</span> &#123; Success, InvalidInput, Timeout &#125;;<br><br><span class="hljs-function">std::pair&lt;Result, Error&gt; <span class="hljs-title">safe_operation</span><span class="hljs-params">(Input input)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (!input.<span class="hljs-built_in">valid</span>()) <span class="hljs-keyword">return</span> &#123; &#123;&#125;, Error::InvalidInput &#125;;<br>    <span class="hljs-comment">// 处理逻辑...</span><br>    <span class="hljs-keyword">return</span> &#123; result, Error::Success &#125;;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="5-自定义异常体系">5. <strong>自定义异常体系</strong></h4>
<ul>
<li><strong>原则</strong>：通过继承<code>std::exception</code>定义清晰的异常类型，传递上下文信息。</li>
<li><strong>示例</strong>：<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkException</span> : <span class="hljs-keyword">public</span> std::runtime_error &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">NetworkException</span>(<span class="hljs-type">const</span> std::string&amp; url, <span class="hljs-type">int</span> code)<br>        : std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;Network error: &quot;</span> + url), <br>          <span class="hljs-built_in">error_code_</span>(code) &#123;&#125;<br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">code</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>&#123; <span class="hljs-keyword">return</span> error_code_; &#125;<br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">int</span> error_code_;<br>&#125;;<br></code></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="三、迁移旧代码中的异常说明">三、迁移旧代码中的异常说明</h3>
<h4 id="1-替换-throw-为-noexcept">1. <strong>替换 <code>throw()</code> 为 <code>noexcept</code></strong></h4>
<ul>
<li><strong>旧代码</strong>：<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">legacy_func</span><span class="hljs-params">()</span> <span class="hljs-title">throw</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">// C++03风格</span><br></code></pre></td></tr></table></figure>
</li>
<li><strong>新代码</strong>：<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">legacy_func</span><span class="hljs-params">()</span> <span class="hljs-keyword">noexcept</span></span>; <span class="hljs-comment">// C++11+风格</span><br></code></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="2-删除具体异常类型声明">2. <strong>删除具体异常类型声明</strong></h4>
<ul>
<li><strong>旧代码</strong>：<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">parse</span><span class="hljs-params">()</span> <span class="hljs-title">throw</span><span class="hljs-params">(FileError, FormatError)</span></span>; <span class="hljs-comment">// 已废弃</span><br></code></pre></td></tr></table></figure>
</li>
<li><strong>新代码</strong>：<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">parse</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">// 不限制异常类型，但需在文档中说明可能抛出的异常</span><br></code></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="3-使用静态分析工具">3. <strong>使用静态分析工具</strong></h4>
<ul>
<li><strong>工具</strong>：Clang-Tidy的 <a target="_blank" rel="noopener" href="https://clang.llvm.org/extra/clang-tidy/checks/modernize-use-noexcept.html"><code>modernize-use-noexcept</code></a> 检查项可自动替换<code>throw()</code>为<code>noexcept</code>。</li>
</ul>
<hr>
<h3 id="四、总结：最佳实践">四、总结：最佳实践</h3>
<table>
<thead>
<tr>
<th>场景</th>
<th>处理方式</th>
<th>工具/技术</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>函数绝不抛异常</strong></td>
<td>使用<code>noexcept</code></td>
<td>移动构造函数、简单工具函数</td>
</tr>
<tr>
<td><strong>可能抛异常</strong></td>
<td>明确异常类型（继承<code>std::exception</code>）</td>
<td>自定义异常类 + 文档说明</td>
</tr>
<tr>
<td><strong>资源管理</strong></td>
<td>RAII + 智能指针</td>
<td><code>std::unique_ptr</code>, 自定义RAII类</td>
</tr>
<tr>
<td><strong>输入校验</strong></td>
<td>断言 + 错误码</td>
<td><code>assert</code>, <code>std::optional</code></td>
</tr>
<tr>
<td><strong>高性能场景</strong></td>
<td>禁用异常 + 错误码</td>
<td>编译器选项<code>-fno-exceptions</code></td>
</tr>
</tbody>
</table>
<hr>
<p>通过避免过时的异常说明，采用现代C++的异常处理策略，可以显著提升代码的<strong>安全性</strong>、<strong>性能</strong>和<strong>可维护性</strong>。</p>
<h1>24 用引用的方式捕获层次体系中的异常。</h1>
<p>在C++中，当处理具有层次结构的异常体系时，通过<strong>引用捕获异常</strong>（<code>catch (const BaseException&amp; e)</code>）是最安全、最灵活的方式。这种方式能够保持异常的多态性，避免对象切片（Object Slicing），同时允许高效访问异常信息。以下是详细说明和最佳实践：</p>
<hr>
<h3 id="1-异常层次结构设计"><strong>1. 异常层次结构设计</strong></h3>
<h4 id="定义基类异常"><strong>定义基类异常</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdexcept&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><br><span class="hljs-comment">// 基类异常，继承自标准异常</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseException</span> : <span class="hljs-keyword">public</span> std::exception &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">BaseException</span>(<span class="hljs-type">const</span> std::string&amp; msg, <span class="hljs-type">int</span> code = <span class="hljs-number">0</span>)<br>        : <span class="hljs-built_in">msg_</span>(msg), <span class="hljs-built_in">code_</span>(code) &#123;&#125;<br><br>    <span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-title">what</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> <span class="hljs-keyword">override</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> msg_.<span class="hljs-built_in">c_str</span>();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">code</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>&#123; <span class="hljs-keyword">return</span> code_; &#125;<br><br><span class="hljs-keyword">private</span>:<br>    std::string msg_;<br>    <span class="hljs-type">int</span> code_;<br>&#125;;<br><br><span class="hljs-comment">// 派生异常类：文件操作异常</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">FileException</span> : <span class="hljs-keyword">public</span> BaseException &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">FileException</span>(<span class="hljs-type">const</span> std::string&amp; path, <span class="hljs-type">int</span> errno_code)<br>        : <span class="hljs-built_in">BaseException</span>(<span class="hljs-string">&quot;文件错误: &quot;</span> + path, errno_code), <span class="hljs-built_in">path_</span>(path) &#123;&#125;<br><br>    <span class="hljs-function"><span class="hljs-type">const</span> std::string&amp; <span class="hljs-title">path</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> path_; &#125;<br><br><span class="hljs-keyword">private</span>:<br>    std::string path_;<br>&#125;;<br><br><span class="hljs-comment">// 派生异常类：网络异常</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkException</span> : <span class="hljs-keyword">public</span> BaseException &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">NetworkException</span>(<span class="hljs-type">const</span> std::string&amp; url, <span class="hljs-type">int</span> http_status)<br>        : <span class="hljs-built_in">BaseException</span>(<span class="hljs-string">&quot;网络错误: &quot;</span> + url, http_status), <span class="hljs-built_in">url_</span>(url) &#123;&#125;<br><br>    <span class="hljs-function"><span class="hljs-type">const</span> std::string&amp; <span class="hljs-title">url</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> url_; &#125;<br><br><span class="hljs-keyword">private</span>:<br>    std::string url_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="2-抛出异常-2"><strong>2. 抛出异常</strong></h3>
<p>在需要的地方抛出具体的派生类异常：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">load_file</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">file_exists</span>(path)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">FileException</span>(path, ENOENT); <span class="hljs-comment">// 抛出文件不存在异常</span><br>    &#125;<br>    <span class="hljs-comment">// ...其他操作...</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">fetch_data</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; url)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">http_get</span>(url).status != <span class="hljs-number">200</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">NetworkException</span>(url, <span class="hljs-number">500</span>); <span class="hljs-comment">// 抛出网络异常</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="3-通过引用捕获异常"><strong>3. 通过引用捕获异常</strong></h3>
<h4 id="3-1-基本捕获方式"><strong>3.1 基本捕获方式</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">load_file</span>(<span class="hljs-string">&quot;data.txt&quot;</span>);<br>        <span class="hljs-built_in">fetch_data</span>(<span class="hljs-string">&quot;https://example.com&quot;</span>);<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> FileException&amp; e) &#123;<br>        <span class="hljs-comment">// 捕获文件异常</span><br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;文件错误: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() <br>                  &lt;&lt; <span class="hljs-string">&quot;\n路径: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">path</span>() <br>                  &lt;&lt; <span class="hljs-string">&quot;\n错误码: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">code</span>() &lt;&lt; std::endl;<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> NetworkException&amp; e) &#123;<br>        <span class="hljs-comment">// 捕获网络异常</span><br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;网络错误: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() <br>                  &lt;&lt; <span class="hljs-string">&quot;\nURL: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">url</span>() <br>                  &lt;&lt; <span class="hljs-string">&quot;\nHTTP状态码: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">code</span>() &lt;&lt; std::endl;<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> BaseException&amp; e) &#123;<br>        <span class="hljs-comment">// 捕获基类异常（其他派生类）</span><br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;基础错误: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() <br>                  &lt;&lt; <span class="hljs-string">&quot;\n错误码: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">code</span>() &lt;&lt; std::endl;<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) &#123;<br>        <span class="hljs-comment">// 捕获标准异常</span><br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;标准异常: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;<br>    &#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>        <span class="hljs-comment">// 捕获所有其他异常</span><br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;未知异常&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="3-2-关键优势"><strong>3.2 关键优势</strong></h4>
<ul>
<li>
<p><strong>避免对象切片</strong>：<br>
如果通过值捕获（<code>catch (BaseException e)</code>），派生类对象会被切割为基类对象，丢失派生类特有数据（如<code>FileException::path_</code>）。</p>
</li>
<li>
<p><strong>支持多态访问</strong>：<br>
通过引用可以正确调用派生类的虚函数（如<code>what()</code>）。</p>
</li>
<li>
<p><strong>高效性</strong>：<br>
引用捕获避免了拷贝异常对象的开销。</p>
</li>
</ul>
<hr>
<h3 id="4-捕获顺序与原则"><strong>4. 捕获顺序与原则</strong></h3>
<h4 id="4-1-从具体到一般"><strong>4.1 从具体到一般</strong></h4>
<p>捕获顺序应<strong>从最具体的异常到最通用的异常</strong>，确保每个异常类型都能被正确处理：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// ...可能抛出FileException、NetworkException...</span><br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> FileException&amp; e) &#123;       <span class="hljs-comment">// 先捕获具体异常</span><br>    <span class="hljs-built_in">handle_file_error</span>(e);<br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> NetworkException&amp; e) &#123;    <span class="hljs-comment">// 再捕获其他具体异常</span><br>    <span class="hljs-built_in">handle_network_error</span>(e);<br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> BaseException&amp; e) &#123;       <span class="hljs-comment">// 最后捕获基类异常</span><br>    <span class="hljs-built_in">handle_generic_error</span>(e);<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="4-2-不要忽略基类捕获"><strong>4.2 不要忽略基类捕获</strong></h4>
<p>即使所有已知异常都已处理，也应保留基类或<code>std::exception</code>的捕获块，避免未处理的异常导致程序终止：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// ...</span><br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> FileException&amp; e) &#123;<br>    <span class="hljs-comment">// 处理文件异常</span><br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> BaseException&amp; e) &#123;<br>    <span class="hljs-comment">// 处理其他自定义异常</span><br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) &#123;<br>    <span class="hljs-comment">// 处理标准库异常</span><br>&#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>    <span class="hljs-comment">// 处理未知异常（如第三方库抛出的int、字符串等）</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="5-动态类型检查（dynamic-cast）"><strong>5. 动态类型检查（<code>dynamic_cast</code>）</strong></h3>
<p>如果需要根据异常类型执行不同逻辑，可通过<code>dynamic_cast</code>安全转换：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// ...</span><br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> BaseException&amp; e) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span>* file_ex = <span class="hljs-built_in">dynamic_cast</span>&lt;<span class="hljs-type">const</span> FileException*&gt;(&amp;e)) &#123;<br>        <span class="hljs-comment">// 处理文件异常</span><br>        std::cout &lt;&lt; <span class="hljs-string">&quot;文件路径: &quot;</span> &lt;&lt; file_ex-&gt;<span class="hljs-built_in">path</span>() &lt;&lt; std::endl;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span>* net_ex = <span class="hljs-built_in">dynamic_cast</span>&lt;<span class="hljs-type">const</span> NetworkException*&gt;(&amp;e)) &#123;<br>        <span class="hljs-comment">// 处理网络异常</span><br>        std::cout &lt;&lt; <span class="hljs-string">&quot;请求URL: &quot;</span> &lt;&lt; net_ex-&gt;<span class="hljs-built_in">url</span>() &lt;&lt; std::endl;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 其他基类异常</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="6-最佳实践总结"><strong>6. 最佳实践总结</strong></h3>
<table>
<thead>
<tr>
<th>原则</th>
<th>实现方式</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>异常设计</strong></td>
<td>构建层次化的异常体系，继承自<code>std::exception</code></td>
<td><code>class FileException : public BaseException</code></td>
</tr>
<tr>
<td><strong>抛出异常</strong></td>
<td>在适当位置抛出具体的派生类异常</td>
<td><code>throw FileException(path, errno)</code></td>
</tr>
<tr>
<td><strong>引用捕获</strong></td>
<td>使用<code>const&amp;</code>捕获异常</td>
<td><code>catch (const FileException&amp; e)</code></td>
</tr>
<tr>
<td><strong>捕获顺序</strong></td>
<td>从具体到一般</td>
<td>先<code>FileException</code>，后<code>BaseException</code></td>
</tr>
<tr>
<td><strong>避免对象切片</strong></td>
<td>绝不通过值捕获多态异常</td>
<td>不用<code>catch (BaseException e)</code></td>
</tr>
<tr>
<td><strong>异常安全</strong></td>
<td>结合RAII管理资源</td>
<td><code>std::lock_guard</code>, 智能指针</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="7-错误处理决策树"><strong>7. 错误处理决策树</strong></h3>
<pre><code class=" mermaid">graph TD
    A[捕获异常] --&gt; B&#123;是否已知具体类型?&#125;
    B --&gt;|是| C[直接处理具体异常]
    B --&gt;|否| D&#123;是否为自定义基类异常?&#125;
    D --&gt;|是| E[使用dynamic_cast检查具体类型]
    D --&gt;|否| F&#123;是否为std::exception?&#125;
    F --&gt;|是| G[处理标准异常]
    F --&gt;|否| H[处理未知异常]
</code></pre>
<hr>
<p>通过引用捕获层次化的异常，结合清晰的异常类型设计，可以构建出既灵活又安全的错误处理系统。</p>
<h1>25 并非每个异常都派生自exception类。</h1>
<p>在C++中，确实存在不继承自<code>std::exception</code>的异常类型。这些异常可能是基础类型（如<code>int</code>、字符串字面量）、自定义类或第三方库定义的异常。为确保程序能正确处理所有可能的异常，需采用更灵活的捕获策略。以下是分层次的解决方案和代码示例：</p>
<hr>
<h3 id="1-基础类型异常处理"><strong>1. 基础类型异常处理</strong></h3>
<h4 id="示例：捕获int错误码"><strong>示例：捕获<code>int</code>错误码</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">if</span> (error_condition) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-number">404</span>; <span class="hljs-comment">// 抛出整型错误码</span><br>    &#125;<br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">int</span> code) &#123;<br>    std::cerr &lt;&lt; <span class="hljs-string">&quot;错误码: &quot;</span> &lt;&lt; code &lt;&lt; std::endl;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="示例：捕获const-char-字符串"><strong>示例：捕获<code>const char*</code>字符串</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-string">&quot;未知错误发生&quot;</span>; <span class="hljs-comment">// 抛出C风格字符串</span><br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> <span class="hljs-type">char</span>* msg) &#123;<br>    std::cerr &lt;&lt; <span class="hljs-string">&quot;错误信息: &quot;</span> &lt;&lt; msg &lt;&lt; std::endl;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="2-第三方库异常处理"><strong>2. 第三方库异常处理</strong></h3>
<h4 id="示例：处理第三方库抛出的异常"><strong>示例：处理第三方库抛出的异常</strong></h4>
<p>假设第三方库<code>ThirdPartyLib</code>可能抛出其自定义的<code>LibException</code>类：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">try</span> &#123;<br>    ThirdPartyLib::<span class="hljs-built_in">operation</span>(); <span class="hljs-comment">// 可能抛出LibException</span><br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> ThirdPartyLib::LibException&amp; e) &#123;<br>    <span class="hljs-comment">// 直接处理第三方异常</span><br>    std::cerr &lt;&lt; <span class="hljs-string">&quot;第三方库错误: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;<br>&#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>    <span class="hljs-comment">// 兜底处理其他未知异常</span><br>    std::cerr &lt;&lt; <span class="hljs-string">&quot;未知第三方错误&quot;</span> &lt;&lt; std::endl;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="3-统一异常接口设计"><strong>3. 统一异常接口设计</strong></h3>
<h4 id="3-1-封装非标准异常"><strong>3.1 封装非标准异常</strong></h4>
<p>将第三方或基础类型异常封装为继承自<code>std::exception</code>的自定义异常：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UnifiedException</span> : <span class="hljs-keyword">public</span> std::exception &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">UnifiedException</span>(<span class="hljs-type">const</span> std::string&amp; msg) : <span class="hljs-built_in">msg_</span>(msg) &#123;&#125;<br>    <span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-title">what</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> <span class="hljs-keyword">override</span> </span>&#123; <span class="hljs-keyword">return</span> msg_.<span class="hljs-built_in">c_str</span>(); &#125;<br><span class="hljs-keyword">private</span>:<br>    std::string msg_;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">safe_third_party_call</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        ThirdPartyLib::<span class="hljs-built_in">operation</span>();<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> ThirdPartyLib::LibException&amp; e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">UnifiedException</span>(<span class="hljs-string">&quot;第三方错误: &quot;</span> + std::<span class="hljs-built_in">string</span>(e.<span class="hljs-built_in">what</span>()));<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">int</span> code) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">UnifiedException</span>(<span class="hljs-string">&quot;错误码: &quot;</span> + std::<span class="hljs-built_in">to_string</span>(code));<br>    &#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">UnifiedException</span>(<span class="hljs-string">&quot;未知第三方异常&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 使用示例</span><br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-built_in">safe_third_party_call</span>();<br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) &#123;<br>    <span class="hljs-comment">// 统一处理为std::exception</span><br>    std::cerr &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="3-2-使用std-exception-ptr（C-11-）"><strong>3.2 使用<code>std::exception_ptr</code>（C++11+）</strong></h4>
<p>跨层传递任意类型的异常：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp">std::exception_ptr eptr;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">risky_operation</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        ThirdPartyLib::<span class="hljs-built_in">operation</span>(); <span class="hljs-comment">// 可能抛出任何类型</span><br>    &#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>        eptr = std::<span class="hljs-built_in">current_exception</span>(); <span class="hljs-comment">// 捕获异常指针</span><br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">handle_exception</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (eptr) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            std::<span class="hljs-built_in">rethrow_exception</span>(eptr);<br>        &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) &#123;<br>            std::cerr &lt;&lt; <span class="hljs-string">&quot;标准异常: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;<br>        &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">int</span> code) &#123;<br>            std::cerr &lt;&lt; <span class="hljs-string">&quot;错误码: &quot;</span> &lt;&lt; code &lt;&lt; std::endl;<br>        &#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>            std::cerr &lt;&lt; <span class="hljs-string">&quot;未知异常类型&quot;</span> &lt;&lt; std::endl;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="4-全面捕获策略"><strong>4. 全面捕获策略</strong></h3>
<h4 id="4-1-从具体到一般的catch顺序"><strong>4.1 从具体到一般的<code>catch</code>顺序</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// 可能抛出多种异常</span><br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> MyCustomException&amp; e) &#123;<br>    <span class="hljs-comment">// 处理最具体的自定义异常</span><br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> ThirdPartyLib::LibException&amp; e) &#123;<br>    <span class="hljs-comment">// 处理第三方异常</span><br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) &#123;<br>    <span class="hljs-comment">// 处理标准异常</span><br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> <span class="hljs-type">char</span>* msg) &#123;<br>    <span class="hljs-comment">// 处理字符串异常</span><br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">int</span> code) &#123;<br>    <span class="hljs-comment">// 处理整型错误码</span><br>&#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>    <span class="hljs-comment">// 兜底处理其他所有异常</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="4-2-记录未知异常"><strong>4.2 记录未知异常</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// ...</span><br>&#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>    std::cerr &lt;&lt; <span class="hljs-string">&quot;发生未知异常，程序将终止&quot;</span> &lt;&lt; std::endl;<br>    std::<span class="hljs-built_in">terminate</span>(); <span class="hljs-comment">// 或执行其他恢复逻辑</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="5-异常安全与资源管理"><strong>5. 异常安全与资源管理</strong></h3>
<p>结合RAII确保资源安全释放：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FileRAII</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">FileRAII</span>(<span class="hljs-type">const</span> std::string&amp; path) : <span class="hljs-built_in">file_</span>(<span class="hljs-built_in">fopen</span>(path.<span class="hljs-built_in">c_str</span>(), <span class="hljs-string">&quot;r&quot;</span>)) &#123;<br>        <span class="hljs-keyword">if</span> (!file_) <span class="hljs-keyword">throw</span> <span class="hljs-built_in">UnifiedException</span>(<span class="hljs-string">&quot;无法打开文件&quot;</span>);<br>    &#125;<br>    ~<span class="hljs-built_in">FileRAII</span>() &#123; <span class="hljs-keyword">if</span> (file_) <span class="hljs-built_in">fclose</span>(file_); &#125;<br><span class="hljs-keyword">private</span>:<br>    FILE* file_;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process_file</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-function">FileRAII <span class="hljs-title">file</span><span class="hljs-params">(<span class="hljs-string">&quot;data.txt&quot;</span>)</span></span>; <span class="hljs-comment">// 异常安全</span><br>    <span class="hljs-comment">// 使用文件...</span><br>    <span class="hljs-comment">// 即使抛出异常，文件也会正确关闭</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="总结：处理非标准异常的关键点"><strong>总结：处理非标准异常的关键点</strong></h3>
<table>
<thead>
<tr>
<th>场景</th>
<th>策略</th>
<th>工具/技术</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>基础类型异常</strong></td>
<td>直接<code>catch</code>特定类型</td>
<td><code>catch(int)</code>, <code>catch(const char*)</code></td>
</tr>
<tr>
<td><strong>第三方库异常</strong></td>
<td>封装或直接处理</td>
<td>自定义包装函数</td>
</tr>
<tr>
<td><strong>统一异常接口</strong></td>
<td>继承<code>std::exception</code>或封装</td>
<td><code>UnifiedException</code>类</td>
</tr>
<tr>
<td><strong>未知异常处理</strong></td>
<td>使用<code>catch(...)</code>兜底</td>
<td>结合日志记录和终止逻辑</td>
</tr>
<tr>
<td><strong>资源安全</strong></td>
<td>RAII管理资源</td>
<td>智能指针、自定义RAII类</td>
</tr>
</tbody>
</table>
<p>通过灵活组合这些策略，可以确保程序正确处理所有类型的异常，同时保持代码的健壮性和可维护性。</p>
<h1>26 让main()捕获和报告所有异常。</h1>
<p>在C++中，可以通过在<code>main()</code>函数中使用<code>try-catch</code>块来捕获所有异常，并结合分层处理策略确保程序优雅退出。以下是实现方案及代码示例：</p>
<hr>
<h3 id="1-基础框架：捕获所有异常类型"><strong>1. 基础框架：捕获所有异常类型</strong></h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;exception&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span> <span class="hljs-comment">// EXIT_FAILURE</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 主程序逻辑</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125; <br>    <span class="hljs-comment">// 1. 优先捕获标准异常体系</span><br>    <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;标准异常: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-comment">// 2. 捕获字符串异常</span><br>    <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> <span class="hljs-type">char</span>* msg) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;C风格异常: &quot;</span> &lt;&lt; msg &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-comment">// 3. 捕获整型错误码</span><br>    <span class="hljs-built_in">catch</span> (<span class="hljs-type">int</span> code) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;错误码: &quot;</span> &lt;&lt; code &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-comment">// 4. 兜底捕获其他所有异常</span><br>    <span class="hljs-built_in">catch</span> (...) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;未知类型异常&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 异常退出码</span><br>    <span class="hljs-keyword">return</span> EXIT_FAILURE;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="2-分层捕获策略"><strong>2. 分层捕获策略</strong></h3>
<h4 id="2-1-优先处理具体异常"><strong>2.1 优先处理具体异常</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// 主逻辑</span><br>&#125; <br><span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> NetworkTimeoutException&amp; e) &#123;  <span class="hljs-comment">// 自定义网络超时异常</span><br>    std::cerr &lt;&lt; <span class="hljs-string">&quot;[网络] 操作超时: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">url</span>() &lt;&lt; std::endl;<br>&#125;<br><span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> FileIOException&amp; e) &#123;          <span class="hljs-comment">// 自定义文件异常</span><br>    std::cerr &lt;&lt; <span class="hljs-string">&quot;[文件] 错误路径: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">path</span>() &lt;&lt; std::endl;<br>&#125;<br><span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::invalid_argument&amp; e) &#123;   <span class="hljs-comment">// 标准库参数异常</span><br>    std::cerr &lt;&lt; <span class="hljs-string">&quot;[参数] &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;<br>&#125;<br><span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) &#123;           <span class="hljs-comment">// 其他标准异常</span><br>    std::cerr &lt;&lt; <span class="hljs-string">&quot;[标准] &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;<br>&#125;<br><span class="hljs-built_in">catch</span> (...) &#123;                               <span class="hljs-comment">// 兜底</span><br>    std::cerr &lt;&lt; <span class="hljs-string">&quot;无法识别的异常&quot;</span> &lt;&lt; std::endl;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="2-2-记录异常堆栈（需要平台支持）"><strong>2.2 记录异常堆栈（需要平台支持）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;execinfo.h&gt;</span> <span class="hljs-comment">// Linux回溯</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print_stacktrace</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-type">void</span>* buffer[<span class="hljs-number">64</span>];<br>    <span class="hljs-type">int</span> size = <span class="hljs-built_in">backtrace</span>(buffer, <span class="hljs-number">64</span>);<br>    <span class="hljs-type">char</span>** symbols = <span class="hljs-built_in">backtrace_symbols</span>(buffer, size);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; size; ++i) &#123;<br>        std::cerr &lt;&lt; symbols[i] &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-built_in">free</span>(symbols);<br>&#125;<br><br><span class="hljs-built_in">catch</span> (...) &#123;<br>    std::cerr &lt;&lt; <span class="hljs-string">&quot;异常发生，堆栈追踪：&quot;</span> &lt;&lt; std::endl;<br>    <span class="hljs-built_in">print_stacktrace</span>();<br>    <span class="hljs-keyword">return</span> EXIT_FAILURE;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="3-自定义异常处理扩展"><strong>3. 自定义异常处理扩展</strong></h3>
<h4 id="3-1-统一异常接口"><strong>3.1 统一异常接口</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseException</span> : <span class="hljs-keyword">public</span> std::exception &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">BaseException</span>(<span class="hljs-type">const</span> std::string&amp; msg) : <span class="hljs-built_in">msg_</span>(msg) &#123;&#125;<br>    <span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-title">what</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> <span class="hljs-keyword">override</span> </span>&#123; <span class="hljs-keyword">return</span> msg_.<span class="hljs-built_in">c_str</span>(); &#125;<br><span class="hljs-keyword">private</span>:<br>    std::string msg_;<br>&#125;;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkException</span> : <span class="hljs-keyword">public</span> BaseException &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">NetworkException</span>(<span class="hljs-type">const</span> std::string&amp; url, <span class="hljs-type">int</span> code)<br>        : <span class="hljs-built_in">BaseException</span>(<span class="hljs-string">&quot;网络错误: &quot;</span> + url + <span class="hljs-string">&quot; (代码: &quot;</span> + std::<span class="hljs-built_in">to_string</span>(code) + <span class="hljs-string">&quot;)&quot;</span>) &#123;&#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="3-2-异常上下文增强"><strong>3.2 异常上下文增强</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> BaseException&amp; e) &#123;<br>    std::cerr &lt;&lt; <span class="hljs-string">&quot;[自定义] &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;<br>    <span class="hljs-comment">// 可在此记录额外信息（如时间戳、会话ID）</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="4-全局异常处理（可选）"><strong>4. 全局异常处理（可选）</strong></h3>
<h4 id="4-1-设置全局异常处理器"><strong>4.1 设置全局异常处理器</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;csignal&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;csetjmp&gt;</span></span><br><br>std::jmp_buf env;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">signal_handler</span><span class="hljs-params">(<span class="hljs-type">int</span> sig)</span> </span>&#123;<br>    std::cerr &lt;&lt; <span class="hljs-string">&quot;致命信号: &quot;</span> &lt;&lt; sig &lt;&lt; std::endl;<br>    std::_Exit(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">terminate_handler</span><span class="hljs-params">()</span> </span>&#123;<br>    std::cerr &lt;&lt; <span class="hljs-string">&quot;未捕获异常导致程序终止&quot;</span> &lt;&lt; std::endl;<br>    std::_Exit(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    std::<span class="hljs-built_in">signal</span>(SIGSEGV, signal_handler);<br>    std::<span class="hljs-built_in">set_terminate</span>(terminate_handler);<br><br>    <span class="hljs-comment">// ... try-catch 块 ...</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="5-示例：完整工作流"><strong>5. 示例：完整工作流</strong></h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdexcept&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">risky_operation</span><span class="hljs-params">(<span class="hljs-type">bool</span> fail)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (fail) &#123;<br>        <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;模拟操作失败&quot;</span>);<br>    &#125;<br>    std::cout &lt;&lt; <span class="hljs-string">&quot;操作成功&quot;</span> &lt;&lt; std::endl;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">risky_operation</span>(<span class="hljs-literal">true</span>); <span class="hljs-comment">// 触发异常</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::runtime_error&amp; e) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;运行时错误: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;标准异常: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;<br>    &#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;未知异常&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-keyword">return</span> EXIT_FAILURE;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>输出</strong>：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">运行时错误: 模拟操作失败</span><br></code></pre></td></tr></table></figure>
<hr>
<h3 id="6-关键原则"><strong>6. 关键原则</strong></h3>
<table>
<thead>
<tr>
<th>原则</th>
<th>实现方式</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>从具体到一般</strong></td>
<td>优先捕获具体异常类型，最后<code>catch(...)</code>兜底</td>
</tr>
<tr>
<td><strong>资源释放保证</strong></td>
<td>使用RAII管理资源，确保异常后自动清理</td>
</tr>
<tr>
<td><strong>错误信息丰富化</strong></td>
<td>自定义异常类携带上下文（如错误码、时间戳）</td>
</tr>
<tr>
<td><strong>跨平台兼容性</strong></td>
<td>避免依赖平台特定的异常处理机制（如SEH）</td>
</tr>
<tr>
<td><strong>日志集成</strong></td>
<td>将异常信息写入日志系统，便于事后分析</td>
</tr>
</tbody>
</table>
<p>通过这种分层设计，<code>main()</code>函数能够捕获并报告所有层级的异常，同时确保程序状态可控，资源安全释放。</p>
<h1>27 销毁信息前先要找到它的替代者。</h1>
<p>在C++中，<strong>“销毁信息前先找到替代者”</strong> 的策略对于保证数据完整性和系统稳定性至关重要。以下是分步骤的详细实现方案及代码示例：</p>
<hr>
<h3 id="1-内存管理：先分配新内存，再释放旧内存"><strong>1. 内存管理：先分配新内存，再释放旧内存</strong></h3>
<h4 id="动态数组扩容示例"><strong>动态数组扩容示例</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;algorithm&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdexcept&gt;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicArray</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">resize</span><span class="hljs-params">(<span class="hljs-type">size_t</span> new_size)</span> </span>&#123;<br>        <span class="hljs-comment">// 步骤1：分配新内存</span><br>        <span class="hljs-type">int</span>* new_data = <span class="hljs-built_in">new</span> (std::nothrow) <span class="hljs-type">int</span>[new_size];<br>        <span class="hljs-keyword">if</span> (!new_data) <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">bad_alloc</span>();<br><br>        <span class="hljs-comment">// 步骤2：复制旧数据到新内存</span><br>        <span class="hljs-type">size_t</span> copy_size = std::<span class="hljs-built_in">min</span>(size_, new_size);<br>        std::<span class="hljs-built_in">copy</span>(data_, data_ + copy_size, new_data);<br><br>        <span class="hljs-comment">// 步骤3：安全销毁旧数据（仅在步骤1、2成功后执行）</span><br>        <span class="hljs-keyword">delete</span>[] data_;<br>        data_ = new_data;<br>        size_ = new_size;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">int</span>* data_ = <span class="hljs-literal">nullptr</span>;<br>    <span class="hljs-type">size_t</span> size_ = <span class="hljs-number">0</span>;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="2-文件操作：先创建临时文件，再替换原文件"><strong>2. 文件操作：先创建临时文件，再替换原文件</strong></h3>
<h4 id="原子性文件更新"><strong>原子性文件更新</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdio&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">safe_file_write</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path, <span class="hljs-type">const</span> std::string&amp; content)</span> </span>&#123;<br>    <span class="hljs-comment">// 步骤1：写入临时文件</span><br>    std::string temp_path = path + <span class="hljs-string">&quot;.tmp&quot;</span>;<br>    &#123;<br>        <span class="hljs-function">std::ofstream <span class="hljs-title">tmp</span><span class="hljs-params">(temp_path)</span></span>;<br>        <span class="hljs-keyword">if</span> (!tmp) <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;无法创建临时文件&quot;</span>);<br>        tmp &lt;&lt; content;<br>    &#125; <span class="hljs-comment">// 文件流关闭确保数据刷入磁盘</span><br><br>    <span class="hljs-comment">// 步骤2：重命名临时文件替换原文件（原子操作）</span><br>    <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">rename</span>(temp_path.<span class="hljs-built_in">c_str</span>(), path.<span class="hljs-built_in">c_str</span>()) != <span class="hljs-number">0</span>) &#123;<br>        std::<span class="hljs-built_in">remove</span>(temp_path.<span class="hljs-built_in">c_str</span>()); <span class="hljs-comment">// 清理临时文件</span><br>        <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;文件替换失败&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="3-数据结构：先构建新节点，再更新指针"><strong>3. 数据结构：先构建新节点，再更新指针</strong></h3>
<h4 id="链表节点安全替换"><strong>链表节点安全替换</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LinkedList</span> &#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span> &#123;<br>        <span class="hljs-type">int</span> data;<br>        Node* next;<br>    &#125;;<br><br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update_node</span><span class="hljs-params">(<span class="hljs-type">int</span> old_value, <span class="hljs-type">int</span> new_value)</span> </span>&#123;<br>        <span class="hljs-comment">// 步骤1：创建新节点（可能抛异常）</span><br>        Node* new_node = <span class="hljs-keyword">new</span> Node&#123;new_value, <span class="hljs-literal">nullptr</span>&#125;;<br><br>        <span class="hljs-comment">// 步骤2：定位旧节点并链接新节点</span><br>        Node* current = head_;<br>        Node* prev = <span class="hljs-literal">nullptr</span>;<br>        <span class="hljs-keyword">while</span> (current &amp;&amp; current-&gt;data != old_value) &#123;<br>            prev = current;<br>            current = current-&gt;next;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (!current) &#123;<br>            <span class="hljs-keyword">delete</span> new_node; <span class="hljs-comment">// 未找到旧节点，清理新节点</span><br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">&quot;值不存在&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 步骤3：连接新节点到链表</span><br>        new_node-&gt;next = current-&gt;next;<br>        <span class="hljs-keyword">if</span> (prev) &#123;<br>            prev-&gt;next = new_node;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            head_ = new_node;<br>        &#125;<br><br>        <span class="hljs-comment">// 步骤4：安全删除旧节点</span><br>        <span class="hljs-keyword">delete</span> current;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    Node* head_ = <span class="hljs-literal">nullptr</span>;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="4-多线程安全：先准备数据，再原子替换"><strong>4. 多线程安全：先准备数据，再原子替换</strong></h3>
<h4 id="无锁共享指针替换"><strong>无锁共享指针替换</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;atomic&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadSafeData</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update_data</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; new_data)</span> </span>&#123;<br>        <span class="hljs-comment">// 步骤1：创建新数据副本</span><br>        <span class="hljs-keyword">auto</span> new_ptr = std::<span class="hljs-built_in">make_shared</span>&lt;std::string&gt;(new_data);<br><br>        <span class="hljs-comment">// 步骤2：原子替换旧指针</span><br>        std::<span class="hljs-built_in">atomic_store_explicit</span>(&amp;data_ptr_, new_ptr, std::memory_order_release);<br>    &#125;<br><br>    <span class="hljs-function">std::string <span class="hljs-title">get_data</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>        <span class="hljs-comment">// 原子获取当前数据指针</span><br>        <span class="hljs-keyword">auto</span> ptr = std::<span class="hljs-built_in">atomic_load_explicit</span>(&amp;data_ptr_, std::memory_order_acquire);<br>        <span class="hljs-keyword">return</span> ptr ? *ptr : <span class="hljs-string">&quot;&quot;</span>;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    std::shared_ptr&lt;std::string&gt; data_ptr_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="5-数据库事务：先验证新数据，再提交修改"><strong>5. 数据库事务：先验证新数据，再提交修改</strong></h3>
<h4 id="SQLite事务示例"><strong>SQLite事务示例</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sqlite3.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">safe_db_update</span><span class="hljs-params">(sqlite3* db, <span class="hljs-type">int</span> id, <span class="hljs-type">const</span> std::string&amp; new_value)</span> </span>&#123;<br>    sqlite3_stmt* stmt = <span class="hljs-literal">nullptr</span>;<br>    <br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 步骤1：开始事务</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sqlite3_exec</span>(db, <span class="hljs-string">&quot;BEGIN TRANSACTION&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) != SQLITE_OK) &#123;<br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;事务启动失败&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 步骤2：准备更新语句</span><br>        <span class="hljs-type">const</span> <span class="hljs-type">char</span>* sql = <span class="hljs-string">&quot;UPDATE table SET value=? WHERE id=?&quot;</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sqlite3_prepare_v2</span>(db, sql, <span class="hljs-number">-1</span>, &amp;stmt, <span class="hljs-number">0</span>) != SQLITE_OK) &#123;<br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;SQL准备失败&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 步骤3：绑定新值并执行</span><br>        <span class="hljs-built_in">sqlite3_bind_text</span>(stmt, <span class="hljs-number">1</span>, new_value.<span class="hljs-built_in">c_str</span>(), <span class="hljs-number">-1</span>, SQLITE_STATIC);<br>        <span class="hljs-built_in">sqlite3_bind_int</span>(stmt, <span class="hljs-number">2</span>, id);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sqlite3_step</span>(stmt) != SQLITE_DONE) &#123;<br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;更新失败&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 步骤4：提交事务</span><br>        <span class="hljs-built_in">sqlite3_finalize</span>(stmt);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sqlite3_exec</span>(db, <span class="hljs-string">&quot;COMMIT&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) != SQLITE_OK) &#123;<br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;提交失败&quot;</span>);<br>        &#125;<br>    &#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>        <span class="hljs-comment">// 回滚事务并清理资源</span><br>        <span class="hljs-built_in">sqlite3_exec</span>(db, <span class="hljs-string">&quot;ROLLBACK&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-built_in">sqlite3_finalize</span>(stmt);<br>        <span class="hljs-keyword">throw</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="6-设计原则总结-3"><strong>6. 设计原则总结</strong></h3>
<table>
<thead>
<tr>
<th>原则</th>
<th>实现方法</th>
<th>关键优势</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>资源获取顺序</strong></td>
<td>先构造新资源，再销毁旧资源</td>
<td>避免资源真空期</td>
</tr>
<tr>
<td><strong>异常安全</strong></td>
<td>使用RAII和try-catch块</td>
<td>确保异常发生时资源不泄漏</td>
</tr>
<tr>
<td><strong>原子操作</strong></td>
<td>使用<code>std::atomic</code>或系统级原子操作</td>
<td>保证多线程环境下的可见性和顺序性</td>
</tr>
<tr>
<td><strong>事务处理</strong></td>
<td>BEGIN/COMMIT/ROLLBACK模式</td>
<td>数据库操作的一致性</td>
</tr>
<tr>
<td><strong>数据备份</strong></td>
<td>写入临时文件后重命名</td>
<td>防止写过程崩溃导致数据损坏</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="错误处理决策树-2"><strong>错误处理决策树</strong></h3>
<pre><code class=" mermaid">graph TD
    A[需要修改数据/资源] --&gt; B&#123;是否有新替代者?&#125;
    B --&gt;|是| C[构造新替代者]
    C --&gt; D&#123;构造是否成功?&#125;
    D --&gt;|成功| E[安全销毁旧资源]
    D --&gt;|失败| F[保持旧资源不变]
    B --&gt;|否| G[直接操作旧资源]
</code></pre>
<hr>
<p>通过遵循这些策略，可以确保在销毁旧信息前，其替代者已正确构建并验证，从而提升系统的鲁棒性和数据完整性。</p>
<h1>28 在赋值运算中抛出异常前要确保运算对象处于有效状态。</h1>
<p>在C++中，实现赋值运算符时，确保在抛出异常前<strong>对象处于有效状态</strong>是异常安全性的核心要求。以下是分步骤的实现策略和代码示例：</p>
<hr>
<h3 id="1-异常安全等级与赋值操作"><strong>1. 异常安全等级与赋值操作</strong></h3>
<table>
<thead>
<tr>
<th>安全等级</th>
<th>描述</th>
<th>赋值操作实现要点</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>基本保证</strong></td>
<td>操作失败后对象仍处于有效状态</td>
<td>不破坏当前对象的成员数据</td>
</tr>
<tr>
<td><strong>强保证</strong></td>
<td>操作要么完全成功，要么不影响原对象</td>
<td>使用&quot;拷贝并交换&quot;(copy-and-swap)</td>
</tr>
<tr>
<td><strong>无抛出保证</strong></td>
<td>操作承诺不抛出异常</td>
<td>使用<code>noexcept</code>标记，仅限简单操作</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="2-实现强异常安全的赋值操作"><strong>2. 实现强异常安全的赋值操作</strong></h3>
<h4 id="2-1-拷贝并交换（Copy-and-Swap）惯用法"><strong>2.1 拷贝并交换（Copy-and-Swap）惯用法</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">String</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-comment">// 拷贝构造函数（可能抛出bad_alloc）</span><br>    <span class="hljs-built_in">String</span>(<span class="hljs-type">const</span> String&amp; other) <br>        : <span class="hljs-built_in">data_</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[other.size_ + <span class="hljs-number">1</span>]), <span class="hljs-built_in">size_</span>(other.size_) &#123;<br>        std::<span class="hljs-built_in">copy</span>(other.data_, other.data_ + size_ + <span class="hljs-number">1</span>, data_);<br>    &#125;<br><br>    <span class="hljs-comment">// 交换操作（不抛异常）</span><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">swap</span><span class="hljs-params">(String&amp; other)</span> <span class="hljs-keyword">noexcept</span> </span>&#123;<br>        std::<span class="hljs-built_in">swap</span>(data_, other.data_);<br>        std::<span class="hljs-built_in">swap</span>(size_, other.size_);<br>    &#125;<br><br>    <span class="hljs-comment">// 赋值运算符（强异常安全）</span><br>    String&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> String&amp; rhs) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> != &amp;rhs) &#123;<br>            String <span class="hljs-built_in">temp</span>(rhs); <span class="hljs-comment">// 1. 拷贝构造可能抛异常</span><br>            <span class="hljs-built_in">swap</span>(temp);        <span class="hljs-comment">// 2. 交换无异常</span><br>        &#125;                     <span class="hljs-comment">// 3. temp析构释放旧资源</span><br>        <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">char</span>* data_ = <span class="hljs-literal">nullptr</span>;<br>    <span class="hljs-type">size_t</span> size_ = <span class="hljs-number">0</span>;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p><strong>关键点</strong>：</p>
<ul>
<li><strong>拷贝构造在前</strong>：所有可能抛出异常的操作在修改当前对象前完成。</li>
<li><strong>交换无异常</strong>：<code>swap()</code>使用<code>noexcept</code>确保原子性资源转移。</li>
<li><strong>自赋值安全</strong>：通过<code>if (this != &amp;rhs)</code>避免冗余操作。</li>
</ul>
<hr>
<h3 id="3-处理基本异常安全"><strong>3. 处理基本异常安全</strong></h3>
<p>当无法实现强保证时，至少确保对象有效：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeArray</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    SafeArray&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> SafeArray&amp; rhs) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> != &amp;rhs) &#123;<br>            <span class="hljs-comment">// 1. 分配新内存（可能抛bad_alloc）</span><br>            <span class="hljs-type">int</span>* new_data = <span class="hljs-keyword">new</span> <span class="hljs-type">int</span>[rhs.size_];<br>            std::<span class="hljs-built_in">copy</span>(rhs.data_, rhs.data_ + rhs.size_, new_data);<br>            <br>            <span class="hljs-comment">// 2. 安全替换（无异常）</span><br>            <span class="hljs-keyword">delete</span>[] data_;<br>            data_ = new_data;<br>            size_ = rhs.size_;<br>        &#125;<br>        <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">int</span>* data_ = <span class="hljs-literal">nullptr</span>;<br>    <span class="hljs-type">size_t</span> size_ = <span class="hljs-number">0</span>;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p><strong>风险</strong>：</p>
<ul>
<li>若<code>new int[...]</code>抛出<code>bad_alloc</code>，原<code>data_</code>和<code>size_</code>保持不变（基本保证）。</li>
<li>若<code>std::copy</code>抛出（如元素类型的拷贝抛异常），对象可能处于部分更新状态。</li>
</ul>
<hr>
<h3 id="4-验证异常安全"><strong>4. 验证异常安全</strong></h3>
<h4 id="4-1-单元测试（使用Catch2框架）"><strong>4.1 单元测试（使用Catch2框架）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">TEST_CASE</span>(<span class="hljs-string">&quot;String赋值运算符强异常安全&quot;</span>) &#123;<br>    <span class="hljs-function">String <span class="hljs-title">s1</span><span class="hljs-params">(<span class="hljs-string">&quot;Hello&quot;</span>)</span></span>;<br>    <span class="hljs-function">String <span class="hljs-title">s2</span><span class="hljs-params">(<span class="hljs-string">&quot;World&quot;</span>)</span></span>;<br>    <br>    <span class="hljs-comment">// 模拟拷贝构造函数抛出异常</span><br>    <span class="hljs-keyword">auto</span> throw_on_copy = [](<span class="hljs-type">const</span> String&amp;) -&gt; String &#123;<br>        <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">bad_alloc</span>();<br>    &#125;;<br>    <br>    <span class="hljs-built_in">REQUIRE_THROWS_AS</span>(s1 = <span class="hljs-built_in">throw_on_copy</span>(s2), std::bad_alloc);<br>    <span class="hljs-built_in">REQUIRE</span>(s<span class="hljs-number">1.</span><span class="hljs-built_in">str</span>() == <span class="hljs-string">&quot;Hello&quot;</span>); <span class="hljs-comment">// 赋值失败后s1仍为原值</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="4-2-内存泄漏检测（Valgrind）"><strong>4.2 内存泄漏检测（Valgrind）</strong></h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">valgrind --leak-check=full ./your_program<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="5-总结：实现步骤与原则"><strong>5. 总结：实现步骤与原则</strong></h3>
<table>
<thead>
<tr>
<th>步骤</th>
<th>实现方式</th>
<th>异常安全保证</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>1. 资源拷贝</strong></td>
<td>创建临时对象或分配新资源</td>
<td>强保证：失败不影响原对象</td>
</tr>
<tr>
<td><strong>2. 交换/提交</strong></td>
<td>使用<code>noexcept</code>的<code>swap()</code>或原子替换</td>
<td>无异常</td>
</tr>
<tr>
<td><strong>3. 清理旧资源</strong></td>
<td>在临时对象析构中自动释放旧资源</td>
<td>基本保证</td>
</tr>
</tbody>
</table>
<p><strong>核心原则</strong>：</p>
<ul>
<li><strong>先完成可能失败的操作</strong>：在修改当前对象状态前完成所有可能抛出异常的操作。</li>
<li><strong>资源管理自动化</strong>：依赖RAII（如智能指针）避免手动<code>delete</code>。</li>
<li><strong>自赋值检查</strong>：避免冗余操作和潜在错误。</li>
</ul>
<h1>29 不要让析构函数抛出异常。</h1>
<p>在C++中，<strong>析构函数绝对不应该抛出异常</strong>。这是C++异常安全编程的黄金法则之一，因为析构函数在对象生命周期结束时会被自动调用，若此时抛出异常，会导致程序处于不可预测的状态甚至直接崩溃。以下是详细原因和解决方案：</p>
<hr>
<h3 id="一、为什么析构函数不能抛出异常？"><strong>一、为什么析构函数不能抛出异常？</strong></h3>
<h4 id="1-栈展开（Stack-Unwinding）时的致命问题"><strong>1. 栈展开（Stack Unwinding）时的致命问题</strong></h4>
<p>当异常被抛出时，C++运行时系统会展开调用栈，逐个调用局部对象的析构函数。如果某个析构函数在栈展开过程中又抛出新的异常：</p>
<ul>
<li>C++标准规定此时直接调用 <code>std::terminate()</code>，<strong>程序立即终止</strong>。</li>
<li><strong>资源泄漏</strong>：未完成的析构函数可能无法释放其他资源。</li>
</ul>
<h4 id="2-异常处理机制的冲突"><strong>2. 异常处理机制的冲突</strong></h4>
<ul>
<li><strong>双重异常</strong>：若析构函数抛出异常时，当前已有异常在传播（比如在 <code>catch</code> 块中处理其他异常），则触发 <code>std::terminate()</code>。</li>
<li><strong>违反异常安全保证</strong>：无法确保对象完整销毁。</li>
</ul>
<h4 id="3-设计原则的破坏"><strong>3. 设计原则的破坏</strong></h4>
<ul>
<li><strong>RAII失效</strong>：析构函数是资源释放的最后防线，必须保证可靠。</li>
</ul>
<hr>
<h3 id="二、正确处理析构函数中的异常"><strong>二、正确处理析构函数中的异常</strong></h3>
<h4 id="1-在析构函数中捕获所有异常"><strong>1. 在析构函数中捕获所有异常</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FileHandler</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    ~<span class="hljs-built_in">FileHandler</span>() <span class="hljs-keyword">noexcept</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (file_.<span class="hljs-built_in">is_open</span>()) &#123;<br>                file_.<span class="hljs-built_in">close</span>(); <span class="hljs-comment">// 可能抛出异常</span><br>            &#125;<br>        &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) &#123;<br>            <span class="hljs-comment">// 记录日志，但不重新抛出</span><br>            std::cerr &lt;&lt; <span class="hljs-string">&quot;文件关闭失败: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;<br>        &#125;<br>    &#125;<br><span class="hljs-keyword">private</span>:<br>    std::fstream file_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p><strong>关键点</strong>：</p>
<ul>
<li>使用 <code>try-catch</code> 块包裹可能抛出异常的代码。</li>
<li><strong>不重新抛出</strong>：在 <code>catch</code> 块中处理错误（如记录日志），但不抛出新异常。</li>
</ul>
<h4 id="2-将可能失败的操作移出析构函数"><strong>2. 将可能失败的操作移出析构函数</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConnection</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-comment">// 显式关闭方法（用户可处理异常）</span><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">close</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (conn_.<span class="hljs-built_in">active</span>()) &#123;<br>            conn_.<span class="hljs-built_in">close</span>(); <span class="hljs-comment">// 可能抛出异常</span><br>            conn_ = <span class="hljs-literal">nullptr</span>;<br>        &#125;<br>    &#125;<br><br>    ~<span class="hljs-built_in">DatabaseConnection</span>() <span class="hljs-keyword">noexcept</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">close</span>(); <span class="hljs-comment">// 析构时尝试关闭，但已处理异常</span><br>        &#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>            std::cerr &lt;&lt; <span class="hljs-string">&quot;数据库连接未正常关闭&quot;</span> &lt;&lt; std::endl;<br>        &#125;<br>    &#125;<br><span class="hljs-keyword">private</span>:<br>    DBConnection conn_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p><strong>优势</strong>：</p>
<ul>
<li>用户可显式调用 <code>close()</code> 并处理异常。</li>
<li>析构函数作为后备，确保资源最终被释放。</li>
</ul>
<hr>
<h3 id="三、使用RAII避免异常"><strong>三、使用RAII避免异常</strong></h3>
<h4 id="1-智能指针自动管理资源"><strong>1. 智能指针自动管理资源</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceOwner</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">ResourceOwner</span>() : <span class="hljs-built_in">res_</span>(std::<span class="hljs-built_in">make_unique</span>&lt;Resource&gt;()) &#123;&#125;<br>    <span class="hljs-comment">// 无需自定义析构函数，unique_ptr自动释放资源</span><br><span class="hljs-keyword">private</span>:<br>    std::unique_ptr&lt;Resource&gt; res_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="2-确保资源释放操作无异常"><strong>2. 确保资源释放操作无异常</strong></h4>
<ul>
<li><strong>设计不可失败的接口</strong>：<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MutexGuard</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    ~<span class="hljs-built_in">MutexGuard</span>() <span class="hljs-keyword">noexcept</span> &#123;<br>        mutex_.<span class="hljs-built_in">unlock</span>(); <span class="hljs-comment">// 假设unlock()永远不会失败</span><br>    &#125;<br><span class="hljs-keyword">private</span>:<br>    std::mutex&amp; mutex_;<br>&#125;;<br></code></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="四、代码验证与工具"><strong>四、代码验证与工具</strong></h3>
<h4 id="1-静态检查工具"><strong>1. 静态检查工具</strong></h4>
<ul>
<li><strong>Clang-Tidy检查</strong>：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">clang-tidy -checks=<span class="hljs-string">&#x27;-*,bugprone-exception-escape&#x27;</span> your_file.cpp<br></code></pre></td></tr></table></figure>
<ul>
<li>检测可能从析构函数抛出的异常。</li>
</ul>
</li>
</ul>
<h4 id="2-单元测试"><strong>2. 单元测试</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">TEST_CASE</span>(<span class="hljs-string">&quot;析构函数不抛异常&quot;</span>) &#123;<br>    <span class="hljs-built_in">REQUIRE_NOTHROW</span>([] &#123;<br>        FileHandler fh;<br>    &#125;());<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="五、总结：析构函数异常处理原则"><strong>五、总结：析构函数异常处理原则</strong></h3>
<table>
<thead>
<tr>
<th>原则</th>
<th>实现方式</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>禁止抛出异常</strong></td>
<td>析构函数标记为<code>noexcept</code></td>
<td><code>~ClassName() noexcept &#123; ... &#125;</code></td>
</tr>
<tr>
<td><strong>内部异常完全捕获</strong></td>
<td>用<code>try-catch</code>包裹可能失败的操作</td>
<td>文件关闭、网络连接释放</td>
</tr>
<tr>
<td><strong>资源释放操作无异常</strong></td>
<td>设计资源管理类，确保释放操作可靠</td>
<td>智能指针、RAII包装类</td>
</tr>
<tr>
<td><strong>提供显式释放方法</strong></td>
<td>允许用户处理异常，析构函数作为后备</td>
<td><code>close()</code>, <code>disconnect()</code></td>
</tr>
</tbody>
</table>
<hr>
<h3 id="六、错误处理决策树"><strong>六、错误处理决策树</strong></h3>
<pre><code class=" mermaid">graph TD
    A[析构函数需要释放资源] --&gt; B&#123;资源释放是否可能失败?&#125;
    B --&gt;|否| C[直接释放]
    B --&gt;|是| D[是否有非析构函数释放方法?]
    D --&gt;|是| E[用户显式调用释放方法]
    D --&gt;|否| F[在析构函数内捕获异常并记录]
</code></pre>
<hr>
<p>通过遵循这些原则，可确保析构函数不会抛出异常，从而维护程序的稳定性和可预测性。</p>
<h1>30 把普通代码和异常处理代码分离开来。</h1>
<p>在C++中，将普通代码（业务逻辑）与异常处理代码分离是提升代码可维护性和可读性的重要手段。以下是分步骤的实现策略和代码示例：</p>
<hr>
<h3 id="一、核心设计原则"><strong>一、核心设计原则</strong></h3>
<table>
<thead>
<tr>
<th>原则</th>
<th>实现方式</th>
<th>优势</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>资源与逻辑分离</strong></td>
<td>使用RAII管理资源，避免异常处理代码侵入业务逻辑</td>
<td>业务代码专注流程，异常处理自动完成</td>
</tr>
<tr>
<td><strong>分层异常处理</strong></td>
<td>在独立层（如控制器、中间件）统一处理异常</td>
<td>避免重复try-catch块</td>
</tr>
<tr>
<td><strong>异常安全封装</strong></td>
<td>将可能抛出异常的代码封装到特定模块</td>
<td>业务代码仅调用接口，不处理细节</td>
</tr>
<tr>
<td><strong>错误传递策略</strong></td>
<td>使用异常或错误码规范错误传播路径</td>
<td>统一错误信息格式，方便追踪</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="二、具体实现策略"><strong>二、具体实现策略</strong></h3>
<h4 id="1-RAII资源管理（自动清理，减少try-catch）"><strong>1. RAII资源管理（自动清理，减少try-catch）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 业务代码：无需显式异常处理</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process_data</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span> </span>&#123;<br>    <span class="hljs-function">FileRAII <span class="hljs-title">file</span><span class="hljs-params">(path)</span></span>;  <span class="hljs-comment">// RAII自动管理文件句柄</span><br>    <span class="hljs-function">DataProcessor <span class="hljs-title">processor</span><span class="hljs-params">(file)</span></span>;<br>    processor.<span class="hljs-built_in">analyze</span>();<br>    <span class="hljs-comment">// 无需手动关闭文件，析构时自动处理</span><br>&#125;<br><br><span class="hljs-comment">// RAII包装类</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">FileRAII</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">FileRAII</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span> </span><br><span class="hljs-function">        : file_(fopen(path.c_str(), <span class="hljs-string">&quot;r&quot;</span>)) &#123;</span><br>        <span class="hljs-keyword">if</span> (!file_) <span class="hljs-keyword">throw</span> <span class="hljs-built_in">FileOpenError</span>(path);<br>    &#125;<br>    ~<span class="hljs-built_in">FileRAII</span>() <span class="hljs-keyword">noexcept</span> &#123; <span class="hljs-keyword">if</span> (file_) <span class="hljs-built_in">fclose</span>(file_); &#125;<br>    <span class="hljs-function">FILE* <span class="hljs-title">handle</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>&#123; <span class="hljs-keyword">return</span> file_; &#125;<br><span class="hljs-keyword">private</span>:<br>    FILE* file_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h4 id="2-业务逻辑与异常处理分层"><strong>2. 业务逻辑与异常处理分层</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 业务层：纯逻辑，不处理异常</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">business_operation</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-function">DatabaseConnection <span class="hljs-title">db</span><span class="hljs-params">(<span class="hljs-string">&quot;user:pass@host&quot;</span>)</span></span>;<br>    db.<span class="hljs-built_in">execute</span>(<span class="hljs-string">&quot;UPDATE accounts SET balance = balance * 1.05&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">// 控制层：统一异常处理</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">business_operation</span>();<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> DatabaseException&amp; e) &#123;<br>        <span class="hljs-built_in">log_error</span>(<span class="hljs-string">&quot;数据库错误:&quot;</span>, e.<span class="hljs-built_in">what</span>());<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) &#123;<br>        <span class="hljs-built_in">log_error</span>(<span class="hljs-string">&quot;系统错误:&quot;</span>, e.<span class="hljs-built_in">what</span>());<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>    &#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>        <span class="hljs-built_in">log_error</span>(<span class="hljs-string">&quot;未知错误&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h4 id="3-异常生成与处理模块化"><strong>3. 异常生成与处理模块化</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 异常生成模块：封装可能失败的操作</span><br><span class="hljs-keyword">namespace</span> risky_ops &#123;<br>    <span class="hljs-function">Image <span class="hljs-title">load_image</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">file_exists</span>(path)) <br>            <span class="hljs-keyword">throw</span> <span class="hljs-built_in">ImageLoadError</span>(<span class="hljs-string">&quot;文件不存在: &quot;</span> + path);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">decode_image</span>(path); <span class="hljs-comment">// 可能抛异常</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 业务代码：调用模块化接口</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">display_image</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">auto</span> img = risky_ops::<span class="hljs-built_in">load_image</span>(path);<br>        <span class="hljs-built_in">render</span>(img);<br>    &#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>        <span class="hljs-comment">// 仅在此处理UI相关错误（如显示错误弹窗）</span><br>        <span class="hljs-built_in">show_error_dialog</span>(<span class="hljs-string">&quot;图片加载失败&quot;</span>);<br>        <span class="hljs-keyword">throw</span>; <span class="hljs-comment">// 其他异常继续向上传递</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h4 id="4-错误码与异常转换（混合策略）"><strong>4. 错误码与异常转换（混合策略）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 底层：返回错误码</span><br><span class="hljs-function">ErrorCode <span class="hljs-title">low_level_operation</span><span class="hljs-params">(<span class="hljs-type">int</span> param)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (param &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> ErrorCode::InvalidInput;<br>    <span class="hljs-comment">// ...操作...</span><br>    <span class="hljs-keyword">return</span> ErrorCode::Success;<br>&#125;<br><br><span class="hljs-comment">// 中间层：将错误码转换为异常</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">mid_layer</span><span class="hljs-params">(<span class="hljs-type">int</span> param)</span> </span>&#123;<br>    <span class="hljs-keyword">auto</span> code = <span class="hljs-built_in">low_level_operation</span>(param);<br>    <span class="hljs-keyword">if</span> (code != ErrorCode::Success) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">AppException</span>(<span class="hljs-string">&quot;操作失败&quot;</span>, <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(code));<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 业务层：仅处理异常</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">business_logic</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">mid_layer</span>(<span class="hljs-number">42</span>);<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> AppException&amp; e) &#123;<br>        <span class="hljs-comment">// 处理业务异常</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="三、高级技巧"><strong>三、高级技巧</strong></h3>
<h4 id="1-策略模式实现可插拔异常处理"><strong>1. 策略模式实现可插拔异常处理</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorHandler</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">ErrorHandler</span>() = <span class="hljs-keyword">default</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">handle</span><span class="hljs-params">(<span class="hljs-type">const</span> std::exception&amp; e)</span> <span class="hljs-type">const</span> </span>= <span class="hljs-number">0</span>;<br>&#125;;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsoleHandler</span> : <span class="hljs-keyword">public</span> ErrorHandler &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">handle</span><span class="hljs-params">(<span class="hljs-type">const</span> std::exception&amp; e)</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>&#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;错误: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;<br>    &#125;<br>&#125;;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseWriter</span> &#123;<br>    std::unique_ptr&lt;ErrorHandler&gt; handler_;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">DatabaseWriter</span><span class="hljs-params">(std::unique_ptr&lt;ErrorHandler&gt; handler)</span></span><br><span class="hljs-function">        : handler_(std::move(handler)) &#123;</span>&#125;<br>    <br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">save</span><span class="hljs-params">(<span class="hljs-type">const</span> Data&amp; data)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            db_.<span class="hljs-built_in">insert</span>(data);<br>        &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) &#123;<br>            handler_-&gt;<span class="hljs-built_in">handle</span>(e); <span class="hljs-comment">// 委托给策略处理</span><br>        &#125;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h4 id="2-使用std-optional或std-expected（C-23）减少异常"><strong>2. 使用<code>std::optional</code>或<code>std::expected</code>（C++23）减少异常</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 业务代码使用optional处理可能失败的操作</span><br><span class="hljs-function">std::optional&lt;Image&gt; <span class="hljs-title">safe_load</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">validate_path</span>(path)) <span class="hljs-keyword">return</span> std::<span class="hljs-literal">nullopt</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">decode_image</span>(path); <span class="hljs-comment">// 内部可能抛异常，但被封装</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">display_image</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> img = <span class="hljs-built_in">safe_load</span>(<span class="hljs-string">&quot;photo.jpg&quot;</span>)) &#123;<br>        <span class="hljs-built_in">render</span>(*img);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">show_error</span>(<span class="hljs-string">&quot;无效图片路径&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="四、验证与调试"><strong>四、验证与调试</strong></h3>
<h4 id="1-单元测试分离"><strong>1. 单元测试分离</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 测试业务逻辑（假设无异常）</span><br><span class="hljs-built_in">TEST_CASE</span>(<span class="hljs-string">&quot;数据分析逻辑正确性&quot;</span>) &#123;<br>    DataSet data = <span class="hljs-built_in">generate_test_data</span>();<br>    <span class="hljs-built_in">REQUIRE</span>(<span class="hljs-built_in">process</span>(data) == expected_result);<br>&#125;<br><br><span class="hljs-comment">// 单独测试异常处理</span><br><span class="hljs-built_in">TEST_CASE</span>(<span class="hljs-string">&quot;文件不存在时抛出异常&quot;</span>) &#123;<br>    <span class="hljs-built_in">REQUIRE_THROWS_AS</span>(<span class="hljs-built_in">load_image</span>(<span class="hljs-string">&quot;invalid.jpg&quot;</span>), ImageLoadError);<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="2-静态分析工具"><strong>2. 静态分析工具</strong></h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 使用Clang-Tidy检查异常安全</span><br>clang-tidy -checks=<span class="hljs-string">&#x27;*&#x27;</span> your_file.cpp -- -std=c++20<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="五、总结：代码结构示例"><strong>五、总结：代码结构示例</strong></h3>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">src/<br>├── core/            # 核心业务逻辑（无异常处理）<br>│   ├── data_processor.cpp<br>│   └── database.cpp<br>├── exceptions/      # 异常处理模块<br>│   ├── handlers/    # 异常处理策略<br>│   └── errors.cpp   # 自定义异常类<br>└── main.cpp         # 统一异常捕获入口<br></code></pre></td></tr></table></figure>
<p>通过以上策略，可实现：</p>
<ol>
<li><strong>业务代码纯净</strong>：专注于核心逻辑，无混杂的异常处理代码</li>
<li><strong>异常处理集中</strong>：统一管理错误日志、用户提示、资源回滚</li>
<li><strong>可维护性提升</strong>：修改异常策略时无需改动业务逻辑</li>
<li><strong>测试友好</strong>：业务逻辑和异常处理可分别进行单元测试</li>
</ol>
<h1>31 当异常发生时，如果由new分配的内存尚未被释放将造成内存泄漏，请注意这一点。</h1>
<p>在C++中，当使用 <code>new</code> 分配内存后，若未正确释放且发生异常，会导致内存泄漏。为确保异常安全，需遵循 <strong>RAII（Resource Acquisition Is Initialization）</strong> 原则，结合智能指针和合理的代码设计。以下是详细解决方案和代码示例：</p>
<hr>
<h3 id="一、问题根源与风险"><strong>一、问题根源与风险</strong></h3>
<h4 id="错误示例：直接使用-new-导致泄漏"><strong>错误示例：直接使用 <code>new</code> 导致泄漏</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">risky_function</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-type">int</span>* ptr = <span class="hljs-keyword">new</span> <span class="hljs-type">int</span>[<span class="hljs-number">100</span>];  <span class="hljs-comment">// 分配内存</span><br>    <span class="hljs-built_in">some_operation</span>();         <span class="hljs-comment">// 可能抛异常</span><br>    <span class="hljs-keyword">delete</span>[] ptr;             <span class="hljs-comment">// 若异常发生，此行不会执行！</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>风险</strong>：若 <code>some_operation()</code> 抛出异常，<code>delete[]</code> 无法执行，内存泄漏。</p>
<hr>
<h3 id="二、解决方案"><strong>二、解决方案</strong></h3>
<h4 id="1-使用智能指针（推荐）"><strong>1. 使用智能指针（推荐）</strong></h4>
<p>智能指针（如 <code>std::unique_ptr</code> 和 <code>std::shared_ptr</code>）会在析构时自动释放内存，即使发生异常。</p>
<h5 id="示例：std-unique-ptr"><strong>示例：<code>std::unique_ptr</code></strong></h5>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">safe_function</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">auto</span> ptr = std::<span class="hljs-built_in">make_unique</span>&lt;<span class="hljs-type">int</span>[]&gt;(<span class="hljs-number">100</span>);  <span class="hljs-comment">// 自动管理内存</span><br>    <span class="hljs-built_in">some_operation</span>();  <span class="hljs-comment">// 若抛异常，ptr 析构时自动释放内存</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="示例：std-shared-ptr"><strong>示例：<code>std::shared_ptr</code></strong></h5>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">shared_resource</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">auto</span> ptr = std::<span class="hljs-built_in">shared_ptr</span>&lt;<span class="hljs-type">int</span>&gt;(<span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">42</span>), [](<span class="hljs-type">int</span>* p) &#123; <span class="hljs-keyword">delete</span> p; &#125;);<br>    <span class="hljs-built_in">some_operation</span>();  <span class="hljs-comment">// 异常安全</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="2-手动-try-catch-释放（不推荐）"><strong>2. 手动 <code>try-catch</code> 释放（不推荐）</strong></h4>
<p>若必须手动管理，需在 <code>try</code> 块中释放内存。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">manual_management</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-type">int</span>* ptr = <span class="hljs-literal">nullptr</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        ptr = <span class="hljs-keyword">new</span> <span class="hljs-type">int</span>[<span class="hljs-number">100</span>];<br>        <span class="hljs-built_in">some_operation</span>();<br>        <span class="hljs-keyword">delete</span>[] ptr;<br>    &#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>        <span class="hljs-keyword">delete</span>[] ptr;  <span class="hljs-comment">// 捕获异常后释放</span><br>        <span class="hljs-keyword">throw</span>;         <span class="hljs-comment">// 重新抛出异常</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>缺点</strong>：代码冗余，易遗漏释放逻辑。</p>
<hr>
<h3 id="三、复杂场景：构造函数中的异常"><strong>三、复杂场景：构造函数中的异常</strong></h3>
<h4 id="问题：构造函数中分配多个资源"><strong>问题：构造函数中分配多个资源</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceHolder</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">ResourceHolder</span>() &#123;<br>        ptr1 = <span class="hljs-keyword">new</span> <span class="hljs-type">int</span>[<span class="hljs-number">100</span>];  <span class="hljs-comment">// 分配资源1</span><br>        ptr2 = <span class="hljs-keyword">new</span> <span class="hljs-type">int</span>[<span class="hljs-number">200</span>];  <span class="hljs-comment">// 分配资源2（可能抛异常）</span><br>    &#125;<br>    ~<span class="hljs-built_in">ResourceHolder</span>() &#123; <span class="hljs-keyword">delete</span>[] ptr1; <span class="hljs-keyword">delete</span>[] ptr2; &#125;<br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">int</span>* ptr1;<br>    <span class="hljs-type">int</span>* ptr2;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p><strong>风险</strong>：若 <code>ptr2</code> 分配失败，<code>ptr1</code> 未被释放。</p>
<h4 id="解决方案：用智能指针管理成员"><strong>解决方案：用智能指针管理成员</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeResourceHolder</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">SafeResourceHolder</span>() <br>        : <span class="hljs-built_in">ptr1</span>(std::<span class="hljs-built_in">make_unique</span>&lt;<span class="hljs-type">int</span>[]&gt;(<span class="hljs-number">100</span>)), <br>          <span class="hljs-built_in">ptr2</span>(std::<span class="hljs-built_in">make_unique</span>&lt;<span class="hljs-type">int</span>[]&gt;(<span class="hljs-number">200</span>)) &#123;&#125;<br>    <span class="hljs-comment">// 无需手动编写析构函数</span><br><span class="hljs-keyword">private</span>:<br>    std::unique_ptr&lt;<span class="hljs-type">int</span>[]&gt; ptr1;<br>    std::unique_ptr&lt;<span class="hljs-type">int</span>[]&gt; ptr2;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p><strong>优势</strong>：即使构造函数中途失败，已分配的资源也会被自动释放。</p>
<hr>
<h3 id="四、进阶：自定义RAII类"><strong>四、进阶：自定义RAII类</strong></h3>
<h4 id="封装文件句柄管理"><strong>封装文件句柄管理</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdio&gt;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">FileRAII</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">FileRAII</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path)</span> : file_(fopen(path, <span class="hljs-string">&quot;r&quot;</span>)) &#123;</span><br>        <span class="hljs-keyword">if</span> (!file_) <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;文件打开失败&quot;</span>);<br>    &#125;<br>    ~<span class="hljs-built_in">FileRAII</span>() <span class="hljs-keyword">noexcept</span> &#123; <span class="hljs-keyword">if</span> (file_) <span class="hljs-built_in">fclose</span>(file_); &#125;<br>    <span class="hljs-function">FILE* <span class="hljs-title">handle</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>&#123; <span class="hljs-keyword">return</span> file_; &#125;<br><span class="hljs-keyword">private</span>:<br>    FILE* file_;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process_file</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-function">FileRAII <span class="hljs-title">file</span><span class="hljs-params">(<span class="hljs-string">&quot;data.txt&quot;</span>)</span></span>;  <span class="hljs-comment">// 异常安全</span><br>    <span class="hljs-comment">// 使用 file.handle()</span><br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="五、异常安全等级"><strong>五、异常安全等级</strong></h3>
<table>
<thead>
<tr>
<th>等级</th>
<th>描述</th>
<th>实现方式</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>基本保证</strong></td>
<td>异常发生后程序状态有效，但可能部分修改</td>
<td>确保所有资源被释放</td>
</tr>
<tr>
<td><strong>强保证</strong></td>
<td>异常发生后程序状态与调用前一致</td>
<td>使用&quot;拷贝并交换&quot;(copy-and-swap)</td>
</tr>
<tr>
<td><strong>无抛出保证</strong></td>
<td>操作绝不抛异常</td>
<td>使用 <code>noexcept</code> 标记</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="六、错误处理决策树-2"><strong>六、错误处理决策树</strong></h3>
<pre><code class=" mermaid">graph TD
    A[需要动态分配内存] --&gt; B&#123;是否可能抛异常?&#125;
    B --&gt;|是| C[使用智能指针或RAII类]
    B --&gt;|否| D[直接管理,但需谨慎]
    C --&gt; E[异常安全]
    D --&gt; F[确保所有路径释放内存]
</code></pre>
<hr>
<h3 id="总结-7"><strong>总结</strong></h3>
<table>
<thead>
<tr>
<th>策略</th>
<th>适用场景</th>
<th>优势</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>智能指针</strong></td>
<td>常规动态内存管理</td>
<td>自动释放，代码简洁</td>
</tr>
<tr>
<td><strong>RAII封装类</strong></td>
<td>文件句柄、网络连接等非内存资源</td>
<td>统一资源生命周期管理</td>
</tr>
<tr>
<td><strong>手动try-catch</strong></td>
<td>遗留代码或特殊需求</td>
<td>灵活但易出错，需严格测试</td>
</tr>
</tbody>
</table>
<p>通过将资源管理与对象生命周期绑定，可从根本上避免因异常导致的内存泄漏。优先使用智能指针和RAII机制，而非手动管理。</p>
<h1>32 函数如果能抛出一个异常，那么它就会抛出这个异常，遵循这一假设。</h1>
<p>在C++中，遵循“若函数可能抛出异常，则必须确保异常正确抛出”的假设，需要通过以下策略实现健壮的异常安全性：</p>
<hr>
<h3 id="一、确保异常正确抛出的关键原则"><strong>一、确保异常正确抛出的关键原则</strong></h3>
<ol>
<li>
<p><strong>异常安全保证等级</strong>：</p>
<ul>
<li><strong>基本保证</strong>：异常发生时，对象仍处于有效状态，资源不泄漏。</li>
<li><strong>强保证</strong>：操作要么完全成功，要么不改变程序状态（原子性）。</li>
<li><strong>无抛出保证</strong>（<code>noexcept</code>）：操作绝不抛出异常。</li>
</ul>
</li>
<li>
<p><strong>资源管理</strong>：</p>
<ul>
<li>使用RAII（如智能指针、自定义资源句柄）确保资源自动释放。</li>
<li>析构函数标记为<code>noexcept</code>，且绝不抛出异常。</li>
</ul>
</li>
</ol>
<hr>
<h3 id="二、实现异常正确抛出的代码规范"><strong>二、实现异常正确抛出的代码规范</strong></h3>
<h4 id="1-显式抛出异常的条件检查"><strong>1. 显式抛出异常的条件检查</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DataProcessor</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; input)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (input.<span class="hljs-built_in">empty</span>()) &#123;<br>            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">&quot;输入不可为空&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">// 业务逻辑...</span><br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="2-使用RAII保证资源安全"><strong>2. 使用RAII保证资源安全</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">safe_file_operation</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span> </span>&#123;<br>    <span class="hljs-function">std::ofstream <span class="hljs-title">file</span><span class="hljs-params">(path)</span></span>; <span class="hljs-comment">// RAII自动管理文件流</span><br>    <span class="hljs-keyword">if</span> (!file) &#123;<br>        <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;无法打开文件: &quot;</span> + path);<br>    &#125;<br>    <span class="hljs-comment">// 文件操作...</span><br>&#125; <span class="hljs-comment">// 文件流析构时自动关闭</span><br></code></pre></td></tr></table></figure>
<h4 id="3-强异常保证：Copy-and-Swap"><strong>3. 强异常保证：Copy-and-Swap</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; key, <span class="hljs-type">const</span> std::string&amp; value)</span> </span>&#123;<br>        <span class="hljs-keyword">auto</span> temp = data_;          <span class="hljs-comment">// 拷贝原数据</span><br>        temp[key] = value;          <span class="hljs-comment">// 修改副本（可能抛异常）</span><br>        data_.<span class="hljs-built_in">swap</span>(temp);           <span class="hljs-comment">// 无异常则原子交换</span><br>    &#125;<br><span class="hljs-keyword">private</span>:<br>    std::map&lt;std::string, std::string&gt; data_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="4-异常传播与封装"><strong>4. 异常传播与封装</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">high_level_operation</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">low_level_operation</span>(); <span class="hljs-comment">// 可能抛异常</span><br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> LowLevelException&amp; e) &#123;<br>        <span class="hljs-comment">// 添加上下文后重新抛出</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">HighLevelException</span>(<span class="hljs-string">&quot;高层操作失败&quot;</span>, e);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="三、异常处理的代码分层"><strong>三、异常处理的代码分层</strong></h3>
<h4 id="1-业务层（纯逻辑，无try-catch）"><strong>1. 业务层（纯逻辑，无<code>try-catch</code>）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">business_logic</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-function">DatabaseConnection <span class="hljs-title">db</span><span class="hljs-params">(<span class="hljs-string">&quot;user:pass@host&quot;</span>)</span></span>;<br>    db.<span class="hljs-built_in">execute</span>(<span class="hljs-string">&quot;UPDATE accounts SET balance = balance * 1.05&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="2-控制层（统一异常处理）"><strong>2. 控制层（统一异常处理）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">business_logic</span>();<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> DatabaseException&amp; e) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;数据库错误: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;系统错误: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>    &#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;未知异常&quot;</span> &lt;&lt; std::endl;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="四、自定义异常类设计"><strong>四、自定义异常类设计</strong></h3>
<h4 id="1-继承自std-exception"><strong>1. 继承自<code>std::exception</code></strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkException</span> : <span class="hljs-keyword">public</span> std::runtime_error &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">NetworkException</span>(<span class="hljs-type">const</span> std::string&amp; url, <span class="hljs-type">int</span> code)<br>        : std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;网络错误: &quot;</span> + url + <span class="hljs-string">&quot; (代码: &quot;</span> + std::<span class="hljs-built_in">to_string</span>(code) + <span class="hljs-string">&quot;)&quot;</span>),<br>          <span class="hljs-built_in">url_</span>(url), <span class="hljs-built_in">code_</span>(code) &#123;&#125;<br>    <br>    <span class="hljs-function"><span class="hljs-type">const</span> std::string&amp; <span class="hljs-title">url</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>&#123; <span class="hljs-keyword">return</span> url_; &#125;<br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">code</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>&#123; <span class="hljs-keyword">return</span> code_; &#125;<br><br><span class="hljs-keyword">private</span>:<br>    std::string url_;<br>    <span class="hljs-type">int</span> code_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="2-使用异常链传递上下文"><strong>2. 使用异常链传递上下文</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-built_in">connect_to_server</span>(<span class="hljs-string">&quot;https://example.com&quot;</span>);<br>&#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> SocketException&amp; e) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-built_in">NetworkException</span>(<span class="hljs-string">&quot;example.com&quot;</span>, <span class="hljs-number">500</span>).<span class="hljs-built_in">with_context</span>(e);<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="五、工具与验证"><strong>五、工具与验证</strong></h3>
<h4 id="1-静态分析工具"><strong>1. 静态分析工具</strong></h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 使用Clang-Tidy检查异常安全性</span><br>clang-tidy -checks=<span class="hljs-string">&#x27;*&#x27;</span> your_file.cpp -- -std=c++20<br></code></pre></td></tr></table></figure>
<h4 id="2-单元测试验证"><strong>2. 单元测试验证</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">TEST_CASE</span>(<span class="hljs-string">&quot;空输入触发异常&quot;</span>) &#123;<br>    DataProcessor processor;<br>    <span class="hljs-built_in">REQUIRE_THROWS_AS</span>(processor.<span class="hljs-built_in">process</span>(<span class="hljs-string">&quot;&quot;</span>), std::invalid_argument);<br>&#125;<br><br><span class="hljs-built_in">TEST_CASE</span>(<span class="hljs-string">&quot;文件打开失败时抛出异常&quot;</span>) &#123;<br>    <span class="hljs-built_in">REQUIRE_THROWS_AS</span>(<span class="hljs-built_in">safe_file_operation</span>(<span class="hljs-string">&quot;/invalid/path&quot;</span>), std::runtime_error);<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="六、性能与异常处理的平衡"><strong>六、性能与异常处理的平衡</strong></h3>
<table>
<thead>
<tr>
<th>场景</th>
<th>策略</th>
<th>工具/技术</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>性能敏感路径</strong></td>
<td>禁用异常，使用错误码或<code>std::expected</code></td>
<td><code>-fno-exceptions</code>编译选项</td>
</tr>
<tr>
<td><strong>可恢复错误</strong></td>
<td>抛出自定义异常类</td>
<td>异常层次结构设计</td>
</tr>
<tr>
<td><strong>不可恢复错误</strong></td>
<td>终止程序（<code>std::terminate</code>）</td>
<td>断言或日志记录后终止</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="七、总结：异常处理决策树"><strong>七、总结：异常处理决策树</strong></h3>
<pre><code class=" mermaid">graph TD
    A[函数可能失败] --&gt; B&#123;是否可恢复?&#125;
    B --&gt;|是| C&#123;是否性能敏感?&#125;
    C --&gt;|是| D[返回错误码或状态]
    C --&gt;|否| E[抛出异常]
    B --&gt;|否| F[记录日志并终止]
    E --&gt; G[确保异常正确传递]
    D --&gt; H[调用方显式处理错误]
</code></pre>
<p>通过严格遵循这些原则和模式，可确保异常在预期场景下正确抛出，同时保持代码的健壮性和可维护性。</p>
<h1>33 库不应自行终止程序，正确的做法是抛出一个异常然后由调用者决定该怎么做。</h1>
<p>在C++库设计中，遵循“库不应自行终止程序，而应抛出异常”的原则，可确保调用者拥有完全的错误处理控制权。以下是具体实现步骤与示例：</p>
<hr>
<h3 id="一、设计原则"><strong>一、设计原则</strong></h3>
<ol>
<li><strong>绝不调用终止函数</strong>：避免使用 <code>std::terminate</code>、<code>abort</code> 或 <code>exit</code>。</li>
<li><strong>资源安全</strong>：通过RAII管理资源，确保异常抛出时无泄漏。</li>
<li><strong>异常类型明确</strong>：自定义异常类，传递详细错误信息。</li>
<li><strong>文档清晰</strong>：明确标注可能抛出的异常类型及触发条件。</li>
</ol>
<hr>
<h3 id="二、实现步骤"><strong>二、实现步骤</strong></h3>
<h4 id="1-定义自定义异常类"><strong>1. 定义自定义异常类</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdexcept&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">LibraryException</span> : <span class="hljs-keyword">public</span> std::runtime_error &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">LibraryException</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; msg, <span class="hljs-type">int</span> error_code = <span class="hljs-number">0</span>)</span></span><br><span class="hljs-function">        : std::runtime_error(msg), error_code_(error_code) &#123;</span>&#125;<br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">code</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>&#123; <span class="hljs-keyword">return</span> error_code_; &#125;<br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">int</span> error_code_;<br>&#125;;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">FileOpenException</span> : <span class="hljs-keyword">public</span> LibraryException &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">FileOpenException</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path, <span class="hljs-type">int</span> errno_code)</span></span><br><span class="hljs-function">        : LibraryException(<span class="hljs-string">&quot;无法打开文件: &quot;</span> + path, errno_code), path_(path) &#123;</span>&#125;<br>    <span class="hljs-function"><span class="hljs-type">const</span> std::string&amp; <span class="hljs-title">path</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> path_; &#125;<br><span class="hljs-keyword">private</span>:<br>    std::string path_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="2-资源管理：使用RAII"><strong>2. 资源管理：使用RAII</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeFile</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">SafeFile</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span> : file_(fopen(path.c_str(), <span class="hljs-string">&quot;r&quot;</span>)) &#123;</span><br>        <span class="hljs-keyword">if</span> (!file_) <span class="hljs-keyword">throw</span> <span class="hljs-built_in">FileOpenException</span>(path, errno);<br>    &#125;<br>    ~<span class="hljs-built_in">SafeFile</span>() <span class="hljs-keyword">noexcept</span> &#123; <span class="hljs-keyword">if</span> (file_) <span class="hljs-built_in">fclose</span>(file_); &#125;<br>    <span class="hljs-function">FILE* <span class="hljs-title">handle</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>&#123; <span class="hljs-keyword">return</span> file_; &#125;<br><span class="hljs-keyword">private</span>:<br>    FILE* file_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="3-函数实现：抛出异常而非终止"><strong>3. 函数实现：抛出异常而非终止</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 正确做法：抛出异常</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process_data</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span> </span>&#123;<br>    <span class="hljs-function">SafeFile <span class="hljs-title">file</span><span class="hljs-params">(path)</span></span>; <span class="hljs-comment">// 可能抛出FileOpenException</span><br>    <span class="hljs-comment">// 处理文件...</span><br>&#125;<br><br><span class="hljs-comment">// 错误做法：终止程序</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">bad_process_data</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span> </span>&#123;<br>    FILE* file = <span class="hljs-built_in">fopen</span>(path.<span class="hljs-built_in">c_str</span>(), <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span> (!file) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;致命错误：无法打开文件&quot;</span> &lt;&lt; std::endl;<br>        std::<span class="hljs-built_in">exit</span>(EXIT_FAILURE); <span class="hljs-comment">// ❌ 库不应自行终止</span><br>    &#125;<br>    <span class="hljs-comment">// 处理文件...</span><br>    <span class="hljs-built_in">fclose</span>(file);<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="4-错误传播：不吞噬异常"><strong>4. 错误传播：不吞噬异常</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">low_level_operation</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">critical_error_detected</span>()) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">LibraryException</span>(<span class="hljs-string">&quot;底层操作失败&quot;</span>, error_code);<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">high_level_api</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">low_level_operation</span>();<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> LibraryException&amp; e) &#123;<br>        <span class="hljs-comment">// 可添加上下文后重新抛出</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">LibraryException</span>(<span class="hljs-string">&quot;高层操作失败: &quot;</span> + std::<span class="hljs-built_in">string</span>(e.<span class="hljs-built_in">what</span>()), e.<span class="hljs-built_in">code</span>());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="5-提供错误码选项（可选）"><strong>5. 提供错误码选项（可选）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">enum class</span> <span class="hljs-title class_">ErrorCode</span> &#123; Success = <span class="hljs-number">0</span>, InvalidInput, ResourceBusy &#125;;<br><br><span class="hljs-function">ErrorCode <span class="hljs-title">safe_operation</span><span class="hljs-params">(<span class="hljs-type">int</span> param)</span> <span class="hljs-keyword">noexcept</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (param &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-built_in">LibraryException</span>(<span class="hljs-string">&quot;参数无效&quot;</span>, <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(ErrorCode::InvalidInput));<br>        <span class="hljs-comment">// 操作...</span><br>        <span class="hljs-keyword">return</span> ErrorCode::Success;<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> LibraryException&amp; e) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">static_cast</span>&lt;ErrorCode&gt;(e.<span class="hljs-built_in">code</span>());<br>    &#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>        <span class="hljs-keyword">return</span> ErrorCode::ResourceBusy;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="三、调用者处理示例"><strong>三、调用者处理示例</strong></h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">process_data</span>(<span class="hljs-string">&quot;data.txt&quot;</span>);<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> FileOpenException&amp; e) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;文件错误: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() <br>                  &lt;&lt; <span class="hljs-string">&quot;\n路径: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">path</span>() <br>                  &lt;&lt; <span class="hljs-string">&quot;\n系统错误码: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">code</span>() &lt;&lt; std::endl;<br>        <span class="hljs-comment">// 恢复策略：使用默认数据</span><br>        <span class="hljs-built_in">load_default_data</span>();<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> LibraryException&amp; e) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;库错误[&quot;</span> &lt;&lt; e.<span class="hljs-built_in">code</span>() &lt;&lt; <span class="hljs-string">&quot;]: &quot;</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;<br>        <span class="hljs-keyword">return</span> EXIT_FAILURE;<br>    &#125;<br>    <span class="hljs-keyword">return</span> EXIT_SUCCESS;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="四、文档标注"><strong>四、文档标注</strong></h3>
<p>在头文件中明确标注可能抛出的异常：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief 处理指定文件的数据</span><br><span class="hljs-comment"> * @param path 文件路径</span><br><span class="hljs-comment"> * @throws FileOpenException 文件无法打开时抛出</span><br><span class="hljs-comment"> * @throws LibraryException 其他库内部错误时抛出</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process_data</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span></span>;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="五、测试验证"><strong>五、测试验证</strong></h3>
<p>编写单元测试验证异常行为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;catch2/catch.hpp&gt;</span></span><br><br><span class="hljs-built_in">TEST_CASE</span>(<span class="hljs-string">&quot;文件打开失败时抛出FileOpenException&quot;</span>) &#123;<br>    <span class="hljs-built_in">REQUIRE_THROWS_AS</span>(<span class="hljs-built_in">process_data</span>(<span class="hljs-string">&quot;nonexistent.txt&quot;</span>), FileOpenException);<br>&#125;<br><br><span class="hljs-built_in">TEST_CASE</span>(<span class="hljs-string">&quot;无效参数触发LibraryException&quot;</span>) &#123;<br>    <span class="hljs-built_in">REQUIRE_THROWS_AS</span>(<span class="hljs-built_in">safe_operation</span>(<span class="hljs-number">-1</span>), LibraryException);<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="六、总结"><strong>六、总结</strong></h3>
<table>
<thead>
<tr>
<th>原则</th>
<th>实现方式</th>
<th>优势</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>异常而非终止</strong></td>
<td>用<code>throw</code>替换<code>exit</code>/<code>abort</code></td>
<td>调用者可灵活处理错误</td>
</tr>
<tr>
<td><strong>资源自动释放</strong></td>
<td>RAII类管理文件句柄、内存、锁等</td>
<td>异常安全无泄漏</td>
</tr>
<tr>
<td><strong>异常类型分层</strong></td>
<td>自定义异常继承自标准异常</td>
<td>错误信息丰富且类型安全</td>
</tr>
<tr>
<td><strong>文档明确性</strong></td>
<td>头文件中标注<code>@throws</code></td>
<td>用户清晰了解可能的错误条件</td>
</tr>
</tbody>
</table>
<p>通过此设计，库将错误控制权完全交给调用者，提升代码的健壮性和可维护性。</p>
<h1>34 库不应该直接输出面向最终用户的错误诊断信息，正确的做法是抛出一个异常然后由调用者决定该怎么做。</h1>
<p>在C++库设计中，避免直接输出用户可见的错误信息，转而通过异常机制将错误传递给调用者处理，是提高灵活性和可维护性的关键。以下是分步骤的实现方案：</p>
<hr>
<h3 id="一、定义异常类体系"><strong>一、定义异常类体系</strong></h3>
<h4 id="1-基础异常类（继承自-std-exception）"><strong>1. 基础异常类（继承自 <code>std::exception</code>）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdexcept&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">LibraryException</span> : <span class="hljs-keyword">public</span> std::runtime_error &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">LibraryException</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; msg, <span class="hljs-type">int</span> error_code = <span class="hljs-number">0</span>)</span></span><br><span class="hljs-function">        : std::runtime_error(msg), error_code_(error_code) &#123;</span>&#125;<br>    <br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">code</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>&#123; <span class="hljs-keyword">return</span> error_code_; &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> std::string <span class="hljs-title">details</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>; &#125;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">int</span> error_code_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h4 id="2-具体异常类（按错误类型细化）"><strong>2. 具体异常类（按错误类型细化）</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 文件操作异常</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">FileIOException</span> : <span class="hljs-keyword">public</span> LibraryException &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">FileIOException</span>(<span class="hljs-type">const</span> std::string&amp; path, <span class="hljs-type">int</span> errno_code)<br>        : <span class="hljs-built_in">LibraryException</span>(<span class="hljs-string">&quot;文件I/O错误: &quot;</span> + path, errno_code), <span class="hljs-built_in">path_</span>(path) &#123;&#125;<br>    <br>    <span class="hljs-function">std::string <span class="hljs-title">details</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;路径: &quot;</span> + path_ + <span class="hljs-string">&quot;，系统错误码: &quot;</span> + std::<span class="hljs-built_in">to_string</span>(<span class="hljs-built_in">code</span>());<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    std::string path_;<br>&#125;;<br><br><span class="hljs-comment">// 网络异常</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkException</span> : <span class="hljs-keyword">public</span> LibraryException &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">NetworkException</span>(<span class="hljs-type">const</span> std::string&amp; url, <span class="hljs-type">int</span> http_status)<br>        : <span class="hljs-built_in">LibraryException</span>(<span class="hljs-string">&quot;网络请求失败: &quot;</span> + url, http_status), <span class="hljs-built_in">url_</span>(url) &#123;&#125;<br>    <br>    <span class="hljs-function">std::string <span class="hljs-title">details</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;URL: &quot;</span> + url_ + <span class="hljs-string">&quot;，HTTP状态码: &quot;</span> + std::<span class="hljs-built_in">to_string</span>(<span class="hljs-built_in">code</span>());<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    std::string url_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="二、实现异常安全的库函数"><strong>二、实现异常安全的库函数</strong></h3>
<h4 id="1-抛出异常而非输出错误"><strong>1. 抛出异常而非输出错误</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><br><span class="hljs-function">std::vector&lt;<span class="hljs-type">char</span>&gt; <span class="hljs-title">read_file</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span> </span>&#123;<br>    <span class="hljs-function">std::ifstream <span class="hljs-title">file</span><span class="hljs-params">(path, std::ios::binary)</span></span>;<br>    <span class="hljs-keyword">if</span> (!file) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">FileIOException</span>(path, errno); <span class="hljs-comment">// 抛出而非输出到stderr</span><br>    &#125;<br>    <br>    file.<span class="hljs-built_in">seekg</span>(<span class="hljs-number">0</span>, std::ios::end);<br>    <span class="hljs-type">size_t</span> size = file.<span class="hljs-built_in">tellg</span>();<br>    file.<span class="hljs-built_in">seekg</span>(<span class="hljs-number">0</span>, std::ios::beg);<br>    <br>    <span class="hljs-function">std::vector&lt;<span class="hljs-type">char</span>&gt; <span class="hljs-title">buffer</span><span class="hljs-params">(size)</span></span>;<br>    <span class="hljs-keyword">if</span> (!file.<span class="hljs-built_in">read</span>(buffer.<span class="hljs-built_in">data</span>(), size)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">FileIOException</span>(path, errno);<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> buffer;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="2-使用RAII管理资源"><strong>2. 使用RAII管理资源</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConnection</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">DatabaseConnection</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; conn_str)</span> </span><br><span class="hljs-function">        : handle_(connect(conn_str)) </span><br><span class="hljs-function">    &#123;</span><br>        <span class="hljs-keyword">if</span> (!handle_.<span class="hljs-built_in">active</span>()) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-built_in">NetworkException</span>(conn_str, <span class="hljs-number">-1</span>);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">execute</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; sql)</span> </span>&#123;<br>        <span class="hljs-comment">// 执行SQL，失败时抛异常</span><br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    DBHandle handle_; <span class="hljs-comment">// RAII管理连接</span><br>&#125;;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="三、调用者处理异常"><strong>三、调用者处理异常</strong></h3>
<h4 id="1-捕获并处理异常"><strong>1. 捕获并处理异常</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">auto</span> data = <span class="hljs-built_in">read_file</span>(<span class="hljs-string">&quot;config.json&quot;</span>);<br>        <span class="hljs-function">DatabaseConnection <span class="hljs-title">db</span><span class="hljs-params">(<span class="hljs-string">&quot;user:pass@localhost&quot;</span>)</span></span>;<br>        db.<span class="hljs-built_in">execute</span>(<span class="hljs-string">&quot;UPDATE settings SET value=1&quot;</span>);<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> FileIOException&amp; e) &#123;<br>        <span class="hljs-comment">// 记录到日志系统，而非直接输出</span><br>        <span class="hljs-built_in">log_error</span>(<span class="hljs-string">&quot;文件错误[代码%d]: %s\n详情: %s&quot;</span>, <br>            e.<span class="hljs-built_in">code</span>(), e.<span class="hljs-built_in">what</span>(), e.<span class="hljs-built_in">details</span>().<span class="hljs-built_in">c_str</span>());<br>        <span class="hljs-keyword">return</span> EXIT_FAILURE;<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> NetworkException&amp; e) &#123;<br>        <span class="hljs-built_in">show_user_alert</span>(<span class="hljs-string">&quot;网络连接失败: &quot;</span> + e.<span class="hljs-built_in">details</span>()); <span class="hljs-comment">// 用户界面提示</span><br>        <span class="hljs-keyword">return</span> EXIT_FAILURE;<br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> LibraryException&amp; e) &#123;<br>        <span class="hljs-built_in">log_error</span>(<span class="hljs-string">&quot;库内部错误: %s (代码%d)&quot;</span>, e.<span class="hljs-built_in">what</span>(), e.<span class="hljs-built_in">code</span>());<br>        <span class="hljs-keyword">return</span> EXIT_FAILURE;<br>    &#125; <span class="hljs-built_in">catch</span> (...) &#123;<br>        <span class="hljs-built_in">log_error</span>(<span class="hljs-string">&quot;未知异常&quot;</span>);<br>        <span class="hljs-keyword">return</span> EXIT_FAILURE;<br>    &#125;<br>    <span class="hljs-keyword">return</span> EXIT_SUCCESS;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="四、文档与接口规范"><strong>四、文档与接口规范</strong></h3>
<h4 id="1-头文件注释"><strong>1. 头文件注释</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief 读取文件内容到字节数组</span><br><span class="hljs-comment"> * @param path 文件路径</span><br><span class="hljs-comment"> * @return 包含文件内容的std::vector&lt;char&gt;</span><br><span class="hljs-comment"> * @throws FileIOException 文件打开或读取失败时抛出</span><br><span class="hljs-comment"> * @throws std::bad_alloc 内存不足时抛出</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function">std::vector&lt;<span class="hljs-type">char</span>&gt; <span class="hljs-title">read_file</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span></span>;<br></code></pre></td></tr></table></figure>
<h4 id="2-异常类型文档"><strong>2. 异常类型文档</strong></h4>
<table>
<thead>
<tr>
<th>异常类</th>
<th>触发场景</th>
<th>携带信息</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>FileIOException</code></td>
<td>文件无法打开或读取</td>
<td>文件路径、系统错误码</td>
</tr>
<tr>
<td><code>NetworkException</code></td>
<td>网络请求失败</td>
<td>URL、HTTP状态码</td>
</tr>
<tr>
<td><code>LibraryException</code></td>
<td>库内部未分类错误</td>
<td>错误消息、自定义错误码</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="五、单元测试验证"><strong>五、单元测试验证</strong></h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;catch2/catch.hpp&gt;</span></span><br><br><span class="hljs-built_in">TEST_CASE</span>(<span class="hljs-string">&quot;读取不存在的文件应抛出FileIOException&quot;</span>) &#123;<br>    <span class="hljs-built_in">REQUIRE_THROWS_AS</span>(<span class="hljs-built_in">read_file</span>(<span class="hljs-string">&quot;nonexistent.txt&quot;</span>), FileIOException);<br>&#125;<br><br><span class="hljs-built_in">TEST_CASE</span>(<span class="hljs-string">&quot;网络连接失败时抛出NetworkException&quot;</span>) &#123;<br>    <span class="hljs-built_in">REQUIRE_THROWS_AS</span>(<span class="hljs-built_in">DatabaseConnection</span>(<span class="hljs-string">&quot;invalid_conn&quot;</span>), NetworkException);<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="六、设计原则总结"><strong>六、设计原则总结</strong></h3>
<table>
<thead>
<tr>
<th>原则</th>
<th>实现方式</th>
<th>优势</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>异常而非输出</strong></td>
<td>抛出携带详细信息的异常类</td>
<td>调用者灵活处理错误</td>
</tr>
<tr>
<td><strong>资源自动释放</strong></td>
<td>RAII类管理文件句柄、网络连接等</td>
<td>异常安全无泄漏</td>
</tr>
<tr>
<td><strong>异常分类清晰</strong></td>
<td>继承体系区分不同错误类型</td>
<td>精准捕获和处理特定错误</td>
</tr>
<tr>
<td><strong>文档完整性</strong></td>
<td>头文件和独立文档描述异常行为</td>
<td>调用者明确了解错误条件</td>
</tr>
</tbody>
</table>
<p>通过此设计，库将错误处理权完全交给调用者，同时确保错误信息的丰富性和可追溯性，符合现代C++库的最佳实践。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/C-%E7%AC%94%E8%AE%B0/" class="category-chain-item">C++笔记</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>C++程序设计语言笔记——基本功能：异常处理</div>
      <div>https://mounthuangshan.github.io/C-笔记/C++笔记/C++程序设计语言笔记——基本功能：异常处理/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>黄山</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年3月19日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/C-%E7%AC%94%E8%AE%B0/C++%E7%AC%94%E8%AE%B0/C++%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%9F%BA%E6%9C%AC%E5%8A%9F%E8%83%BD%EF%BC%9A%E6%BA%90%E6%96%87%E4%BB%B6%E4%B8%8E%E7%A8%8B%E5%BA%8F/" title="C++程序设计语言笔记——基本功能：源文件与程序">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">C++程序设计语言笔记——基本功能：源文件与程序</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/C-%E7%AC%94%E8%AE%B0/C++%E7%AC%94%E8%AE%B0/C++%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%9F%BA%E6%9C%AC%E5%8A%9F%E8%83%BD%EF%BC%9A%E7%BB%93%E6%9E%84%E3%80%81%E8%81%94%E5%90%88%E4%B8%8E%E6%9E%9A%E4%B8%BE/" title="C++程序设计语言笔记——基本功能：结构、联合与枚举">
                        <span class="hidden-mobile">C++程序设计语言笔记——基本功能：结构、联合与枚举</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
